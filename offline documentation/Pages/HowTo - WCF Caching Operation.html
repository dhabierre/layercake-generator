<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
	<title>LCG - HowTo - WCF Caching Operation</title>
	<link rel="stylesheet" type="text/css" href="../Styles/Highlight.css">
	<link rel="stylesheet" type="text/css" href="../Styles/Styles.css">
</head>
<body>
	<h1>HowTo - WCF Caching Operation</h1>
	<section>
		<p>The <span class="text-bold">CachingOperationAttribute</span> is used to cache WCF operation results and increase the system reactivity.</p>
		<div class="box important">
			<h3>CachingOperationAttribute</h3>
			<div class="box-content">This attribute can be set to either Business methods or WCF operations. When set on a Business method the attribute will be automatically set on the associated WCF operation (LayerCake Generator Process).</div>
		</div>
	</section>
	<section>
		<h2>1. Standard way</h2>
		<p>When the result does not depend on the user context</p>
		<pre class="hl">﻿<span class="hl com">// Business</span>

<span class="hl opt">[</span><span class="hl kwd">BusinessMethod</span><span class="hl opt">]</span>
<span class="text-bold text-red">[CachingOperation(Minutes = 30)]</span>
<span class="hl kwa">public</span> TCollection<span class="hl opt">&lt;</span>Data<span class="hl opt">&gt;</span> <span class="hl kwd">GetAllData</span><span class="hl opt">(</span>IUserContext userContext<span class="hl opt">)</span>
<span class="hl opt">{</span>
    TCollection<span class="hl opt">&lt;</span>Data<span class="hl opt">&gt;</span> collection <span class="hl opt">=</span> <span class="hl kwa">new</span> TCollection<span class="hl opt">&lt;</span>Data<span class="hl opt">&gt;();</span>
    collection<span class="hl opt">.</span><span class="hl kwd">Add</span><span class="hl opt">(</span><span class="hl kwa">new</span> Data <span class="hl opt">{</span> Content <span class="hl opt">=</span> <span class="hl str">&quot;Result...&quot;</span> <span class="hl opt">});</span>

    <span class="hl kwa">return</span> collection<span class="hl opt">;</span>
<span class="hl opt">}</span></pre>
		<p>Timespan supported: Days, Hours, Minutes &amp; Seconds.</p>
		<p> When the result depends on the user context (each user has his own specific result)</p>
		<pre class="hl">﻿<span class="hl com">// Business</span>

<span class="hl opt">[</span><span class="hl kwd">BusinessMethod</span><span class="hl opt">]</span>
<span class="hl opt">[</span><span class="hl kwd">CachingOperation</span><span class="hl opt">(</span>Minutes <span class="hl opt">=</span> <span class="hl num">30</span><span class="hl opt">,</span> <span class="text-bold text-red">WithUserContextDependency = true</span><span class="hl opt">)]</span>
<span class="hl kwa">public</span> TCollection<span class="hl opt">&lt;</span>Data<span class="hl opt">&gt;</span> <span class="hl kwd">GetAllDataByUser</span><span class="hl opt">(</span>IUserContext userContext<span class="hl opt">)</span>
<span class="hl opt">{</span>
    TCollection<span class="hl opt">&lt;</span>Data<span class="hl opt">&gt;</span> collection <span class="hl opt">=</span> <span class="hl kwa">new</span> TCollection<span class="hl opt">&lt;</span>Data<span class="hl opt">&gt;();</span>
    collection<span class="hl opt">.</span><span class="hl kwd">Add</span><span class="hl opt">(</span><span class="hl kwa">new</span> Data <span class="hl opt">{</span> Content <span class="hl opt">=</span> <span class="hl kwb">string</span><span class="hl opt">.</span><span class="hl kwd">Format</span><span class="hl opt">(</span><span class="hl str">&quot;Result for user {0}...&quot;</span><span class="hl opt">,</span> userContext<span class="hl opt">.</span>Identifier<span class="hl opt">) });</span>

    <span class="hl kwa">return</span> collection<span class="hl opt">;</span>
<span class="hl opt">}</span></pre>
	</section>
	<section>
		<h2>2. Advanced way</h2>
		<p>The second way gives the ability to define the key to generate using <span class="text-bold">IKeyGenerator&lt;T&gt;</span> interface.</p>
		<pre class="hl">﻿<span class="hl com">// Business</span>

<span class="hl opt">[</span><span class="hl kwd">BusinessMethod</span><span class="hl opt">]</span>
<span class="hl opt">[</span><span class="hl kwd">CachingOperation</span><span class="hl opt">(</span>Minutes <span class="hl opt">=</span> <span class="hl num">30</span><span class="hl opt">,</span> <span class="text-bold text-red">KeyGeneratorType = typeof(GetDataKeyGenerator)</span><span class="hl opt">)]</span>
<span class="hl kwa">public</span> TCollection<span class="hl opt">&lt;</span>Data<span class="hl opt">&gt;</span> <span class="hl kwd">GetData</span><span class="hl opt">(</span>IUserContext userContext<span class="hl opt">,</span> <span class="hl kwb">long</span> id<span class="hl opt">)</span>
<span class="hl opt">{</span>
    <span class="hl slc">// ...</span>
<span class="hl opt">}</span>

<span class="hl kwa">public class</span> <span class="text-bold text-red">GetDataKeyGenerator</span> <span class="hl opt">:</span> IKeyGenerator<span class="hl opt">&lt;</span><span class="hl kwb">string</span><span class="hl opt">&gt;</span>
<span class="hl opt">{</span>
    <span class="hl kwa">public</span> <span class="hl kwb">string</span> <span class="hl kwd">Generate</span><span class="hl opt">(</span><span class="hl kwb">object</span><span class="hl opt">[]</span> parameters<span class="hl opt">)</span>
    <span class="hl opt">{</span>
        <span class="hl slc">// parameters contains the input parameters of the method</span>

        IUserContext userContext <span class="hl opt">= (</span>IUserContext<span class="hl opt">)</span>parameters<span class="hl opt">[</span><span class="hl num">0</span><span class="hl opt">];</span> <span class="hl slc">// can be used or not (depends on whether the user context is used)</span>
        <span class="hl kwb">long</span> id <span class="hl opt">= (</span><span class="hl kwb">long</span><span class="hl opt">)</span>parameters<span class="hl opt">[</span><span class="hl num">1</span><span class="hl opt">];</span>

        <span class="hl kwa">return</span> <span class="hl kwb">string</span><span class="hl opt">.</span><span class="hl kwd">Format</span><span class="hl opt">(</span><span class="hl str">&quot;{0}_{1}&quot;</span><span class="hl opt">,</span> userContext<span class="hl opt">.</span>Identifier<span class="hl opt">,</span> id<span class="hl opt">);</span>
    <span class="hl opt">}</span>
<span class="hl opt">}</span></pre>
		<div class="box important">
		    <h3>KeyGenerator&lt;T&gt; Interface</h3>
		    <div class="box-content">The <span class="text-bold">Generate()</span> method must return unique key given the WCF operation parameters.</div>
		</div>
		<p>WCF Caching Operation process is handled in the <span class="text-bold">CachingOperationInvoker</span> class and can be easily customized.</p>
	</section>
</body>
</html>
