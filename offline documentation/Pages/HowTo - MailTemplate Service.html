<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
	<title>LCG - HowTo - MailTemplate Service</title>
	<link rel="stylesheet" type="text/css" href="../Styles/Highlight.css">
	<link rel="stylesheet" type="text/css" href="../Styles/Styles.css">
</head>
<body>
	<h1>HowTo - MailTemplate Service</h1>
	<section>
		<p>By default the mail templates are stored in the <span class="text-bold">WebServices\App_Data\MailTemplates</span> directory.</p>
		<p>This path can be changed in the <span class="text-bold">Web.config</span> file.</p>
		<pre class="hl"><span class="hl kwa">&lt;mailTemplateServiceConfiguration</span>
  <span class="hl kwb">path</span>=<span class="hl str">&quot;App_Data\MailTemplates&quot;</span> <span class="hl kwa">/&gt;</span></pre>
		<div class="box important">
		    <h3>Note</h3>
		    <div class="box-content">All the *.xml files in the WebServices\App_Data\MailTemplates folder will be copied in the Tests\App_Data\MailTemplates\ when the WebServices project is compiled (thus templates should be tested in the unit tests context).</div>
		</div>
	</section>
	<section>
		<h2>1. Mail Template</h2>
		<p>Here an example of a mail template (<span class="text-italic">OnUserCreated.xml</span>) used when a new user is created to the database.</p>
		<pre class="hl"><span class="hl kwa">&lt;?xml</span> <span class="hl kwb">version</span>=<span class="hl str">&quot;1.0&quot;</span> <span class="hl kwb">encoding</span>=<span class="hl str">&quot;utf-8&quot;</span> <span class="hl kwa">?&gt;</span>
<span class="hl kwa">&lt;Templates&gt;</span>
  
  <span class="hl kwa">&lt;Template</span> <span class="hl kwb">culture</span>=<span class="hl str">&quot;EN&quot;</span><span class="hl kwa">&gt;</span>
    <span class="hl kwa">&lt;Subject&gt;</span>
      &lt;![CDATA[Welcome <span class="text-red">%User.Username%</span>]]<span class="hl kwa">&gt;</span>
    <span class="hl kwa">&lt;/Subject&gt;</span>
    <span class="hl kwa">&lt;Message&gt;</span>
      &lt;![CDATA[
<span class="hl slc">&lt;div id="header"&gt;
    &lt;em&gt;Site logo here...&lt;/em&gt;
    &lt;!--&lt;img src="http://www.your-site.com/images/mail-logo.png" alt="Site slogan here" /&gt;--&gt;
&lt;/div&gt;
&lt;div id="content"&gt;
    &lt;p&gt;Welcome and thanks for joining!&lt;/p&gt;
    &lt;p&gt;Here is your login information:&lt;/p&gt;
    &lt;p&gt;Username: <span class="text-red">%User.Username%</span>&lt;/p&gt;
    &lt;p&gt;Password: ********&lt;/p&gt;
    &lt;p&gt;Email: <span class="text-red">%User.Email%</span>&lt;/p&gt;
    &lt;p&gt;Secret question: <span class="text-red">%User.PasswordQuestion%</span>&lt;/p&gt;
    &lt;p&gt;Secret response: <span class="text-red">%User.PasswordResponse%*******</span>&lt;/p&gt;
    &lt;p&gt;If you have any questions, please do not hesitate to contact us.&lt;/p&gt;
&lt;/div&gt;
&lt;div id="footer"&gt;
    &lt;br /&gt;
    &lt;p&gt;Best regards,&lt;p/&gt;
    &lt;p&gt;Com.Example.Labs Staff&lt;br /&gt;
      &lt;a href="http://www.your-site.com"&gt;http://www.your-site.com&lt;/a&gt;&lt;br /&gt;
      &lt;a href="mailto:contact@your-site.com"&gt;contact@your-site.com&lt;/a&gt;
    &lt;/p&gt;
&lt;/div&gt;</span>
      ]]<span class="hl kwa">&gt;</span>
    <span class="hl kwa">&lt;/Message&gt;</span>
  <span class="hl kwa">&lt;/Template&gt;</span>
  
  <span class="hl kwa">&lt;Template</span> <span class="hl kwb">culture</span>=<span class="hl str">&quot;FR&quot;</span><span class="hl kwa">&gt;</span>
    <span class="hl kwa">&lt;Subject&gt;</span>
      &lt;![CDATA[...]]<span class="hl kwa">&gt;</span>
    <span class="hl kwa">&lt;/Subject&gt;</span>
    <span class="hl kwa">&lt;Message&gt;</span>
      &lt;![CDATA[...]]<span class="hl kwa">&gt;</span>
    <span class="hl kwa">&lt;/Message&gt;</span>
  <span class="hl kwa">&lt;/Template&gt;</span>
  
  <span class="hl kwa">&lt;Template</span> <span class="hl kwb">culture</span>=<span class="hl str">&quot;ES&quot;</span><span class="hl kwa">&gt;</span>
    <span class="hl kwa">&lt;Subject&gt;</span>
      &lt;![CDATA[...]]<span class="hl kwa">&gt;</span>
    <span class="hl kwa">&lt;/Subject&gt;</span>
    <span class="hl kwa">&lt;Message&gt;</span>
      &lt;![CDATA[...]]<span class="hl kwa">&gt;</span>
    <span class="hl kwa">&lt;/Message&gt;</span>
  <span class="hl kwa">&lt;/Template&gt;</span>
  
  <span class="hl kwa">&lt;Template</span> <span class="hl kwb">culture</span>=<span class="hl str">&quot;DE&quot;</span><span class="hl kwa">&gt;</span>
    <span class="hl kwa">&lt;Subject&gt;</span>
      &lt;![CDATA[...]]<span class="hl kwa">&gt;</span>
    <span class="hl kwa">&lt;/Subject&gt;</span>
    <span class="hl kwa">&lt;Message&gt;</span>
      &lt;![CDATA[...]]<span class="hl kwa">&gt;</span>
    <span class="hl kwa">&lt;/Message&gt;</span>
  <span class="hl kwa">&lt;/Template&gt;</span>

<span class="hl kwa">&lt;/Templates&gt;</span></pre>
	</section>
	<section>
		<h2>2. Code Sample</h2>
		<p>Here how to load a template, fill it and send it by mail.</p>
		<pre class="hl">﻿<span class="hl com">// Tests</span>

<span class="hl kwa">namespace</span> Com<span class="hl opt">.</span>Example<span class="hl opt">.</span>Labs<span class="hl opt">.</span><span class="text-red">Tests</span>
<span class="hl opt">{</span>
    <span class="hl kwa">using</span> System<span class="hl opt">.</span>Collections<span class="hl opt">;</span>
    <span class="hl kwa">using</span> System<span class="hl opt">.</span>Collections<span class="hl opt">.</span>Generic<span class="hl opt">;</span>

    <span class="hl kwa">using</span> Microsoft<span class="hl opt">.</span>VisualStudio<span class="hl opt">.</span>TestTools<span class="hl opt">.</span>UnitTesting<span class="hl opt">;</span>

    <span class="hl kwa">using</span> LayerCake<span class="hl opt">.</span>Generator<span class="hl opt">.</span>Core<span class="hl opt">;</span>
    <span class="hl kwa">using</span> LayerCake<span class="hl opt">.</span>Generator<span class="hl opt">.</span>Models<span class="hl opt">;</span>

    <span class="hl opt">[</span><span class="hl kwd">TestClass</span><span class="hl opt">]</span>
    <span class="hl kwa">public class</span> MailTemplateServiceTests
    <span class="hl opt">{</span>
        <span class="hl opt">[</span><span class="hl kwd">TestMethod</span><span class="hl opt">]</span>
        <span class="hl kwa">public</span> <span class="hl kwb">void</span> <span class="hl kwd">MailTemplateServiceTests_Example</span><span class="hl opt">()</span>
        <span class="hl opt">{</span>
            User user <span class="hl opt">=</span> <span class="hl kwa">new</span> User
            <span class="hl opt">{</span>
                Username <span class="hl opt">=</span> <span class="hl str">&quot;jdoe&quot;</span><span class="hl opt">,</span>
                Email <span class="hl opt">=</span> <span class="hl str">&quot;john&#64;doe.com&quot;</span><span class="hl opt">,</span>
                PasswordQuestion <span class="hl opt">=</span> <span class="hl str">&quot;My pet's name&quot;</span><span class="hl opt">,</span>
                PasswordResponse <span class="hl opt">=</span> <span class="hl str">&quot;Deus&quot;</span><span class="hl opt">,</span>
                Culture <span class="hl opt">=</span> Cultures<span class="hl opt">.</span>EN
            <span class="hl opt">};</span>

            <span class="hl slc">// Save this User in the database...</span>
            <span class="hl slc">// ... </span>

            <span class="hl slc">// 1. Create the service with the 'OnUserCreated' template
            // (name of the xml file without the extension)</span>
            <span class="hl kwa">var</span> template <span class="hl opt">=</span> <span class="hl kwa">new</span> <span class="hl kwd">MailTemplateService</span><span class="hl opt">(</span><span class="hl str">&quot;OnUserCreated&quot;</span><span class="hl opt">);</span>

            <span class="hl slc">// 2. Declare the tokens (key, value) to replace in the template</span>
            <span class="hl kwa">var</span> tokens <span class="hl opt">=</span> <span class="hl kwa">new</span> Dictionary<span class="hl opt">&lt;</span><span class="hl kwb">string</span><span class="hl opt">,</span> <span class="hl kwb">object</span><span class="hl opt">&gt;();</span>

            tokens<span class="hl opt">.</span><span class="hl kwd">Add</span><span class="hl opt">(</span><span class="hl str">&quot;%User.Username%&quot;</span><span class="hl opt">,</span> user<span class="hl opt">.</span>Username<span class="hl opt">);</span>
            tokens<span class="hl opt">.</span><span class="hl kwd">Add</span><span class="hl opt">(</span><span class="hl str">&quot;%User.Email%&quot;</span><span class="hl opt">,</span> user<span class="hl opt">.</span>Email<span class="hl opt">);</span>
            tokens<span class="hl opt">.</span><span class="hl kwd">Add</span><span class="hl opt">(</span><span class="hl str">&quot;%User.PasswordQuestion%&quot;</span><span class="hl opt">,</span> user<span class="hl opt">.</span>PasswordQuestion<span class="hl opt">);</span>
            tokens<span class="hl opt">.</span><span class="hl kwd">Add</span><span class="hl opt">(</span><span class="hl str">&quot;%User.PasswordResponse%&quot;</span><span class="hl opt">,</span> user<span class="hl opt">.</span>PasswordResponse<span class="hl opt">[</span>0<span class="hl opt">]</span><span class="hl opt">);</span>

            <span class="hl slc">// 3. Load the template with the User's culture and the token collection</span>
            template<span class="hl opt">.</span><span class="hl kwd">Load</span><span class="hl opt">(</span>user<span class="hl opt">.</span>Culture<span class="hl opt">,</span> tokens<span class="hl opt">);</span>

            <span class="hl slc">// 4. Send the transformed template</span>
            template<span class="hl opt">.</span><span class="hl kwd">SendByMail</span><span class="hl opt">(</span>user<span class="hl opt">.</span>Email<span class="hl opt">,</span> <span class="hl kwa">new</span> SmtpServiceOptions <span class="hl opt">{</span> IsHtmlBody <span class="hl opt">=</span> <span class="hl kwa">true</span> <span class="hl opt">});</span>
        <span class="hl opt">}</span>
    <span class="hl opt">}</span>
<span class="hl opt">}</span></pre>
	</section>
</body>
</html>
