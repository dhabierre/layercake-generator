<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
    <title>LCG - 12 - Start with an ASP.NET MVC Project (WCF Layer)</title>
    <link rel="stylesheet" type="text/css" href="../Styles/Highlight.css">
    <link rel="stylesheet" type="text/css" href="../Styles/Styles.css">
</head>
<body>
    <h1>Lab 12 - Start with an ASP.NET MVC Project (WCF Layer)</h1>
    <section>
        <p>Duration: <span class="text-bold">~15mins</span></p>
    </section>
    <section>
        <p class="action">Add a new ASP.NET MVC project to the solution.</p>
		<img src="../ScreenShots/12-01.png" title="Illustration" alt="Illustration" />
		<p class="action">Add the references to the following assemblies.</p>
		<img src="../ScreenShots/12-02.png" title="Illustration" alt="Illustration" />
		<div class="box important">
		    <h3>References</h3>
		    <div class="box-content">Do not add reference to the other assemblies.</div>
		    <div class="box-content">If you don't want to use WCF / WebServices layer report to the <a href="HowTo - Local ServiceProxy.html" target="_blank">Local ServiceProxy HowTo</a>.</div>
		</div>
		<p class="action">Set the startup projects.</p>
		<img src="../ScreenShots/12-03.png" title="Illustration" alt="Illustration" />
		<p>The WebServices project must start before the WebSite in order to be consumed.</p>
		<img src="../ScreenShots/12-04.png" title="Illustration" alt="Illustration" />
		<p class="action">Edit the <span class="text-bold">Application Configuration file</span> and remove the <span class="text-bold">&lt;connectionStrings&gt;</span> section (the database access should be managed by the WebServices project only).</p>
		<p class="action">Open the <span class="text-bold">App.config</span> file located to the <span class="text-bold">Tests</span> project and copy (or merge) each red section in the WebSite Application Configuration file.</p>
		<p>For example (do not use this because it can be out-of-date)</p>
		<pre class="hl"><span class="hl slc">&lt;!-- From Com.Example.Labs.Tests\App.config --&gt;</span>

&lt;?xml version=&quot;1.0&quot;?&gt;
&lt;configuration&gt;

  <span class="text-red text-bold">&lt;configSections&gt;</span>
    &lt;section
      name=&quot;serviceLocatorConfiguration&quot;
      type=&quot;System.ServiceLocatorSectionHandler, System.Extensions&quot; /&gt;
    &lt;section
      name=&quot;loggerServiceConfiguration&quot;
      type=&quot;System.LoggerServiceSectionHandler, System.Extensions&quot; /&gt;
    &lt;section
      name=&quot;smtpServiceConfiguration&quot;
      type=&quot;System.SmtpServiceSectionHandler, System.Extensions&quot; /&gt;
    &lt;section
      name=&quot;queueExecutionTracerServiceConfiguration&quot;
      type=&quot;System.QueueExecutionTracerServiceSectionHandler, System.Extensions&quot; /&gt;
    &lt;section
      name=&quot;xmlExecutionTracerServiceConfiguration&quot;
      type=&quot;System.XmlExecutionTracerServiceSectionHandler, System.Extensions&quot; /&gt;
    &lt;section
      name=&quot;mailTemplateServiceConfiguration&quot;
      type=&quot;Com.Example.Labs.Core.MailTemplateServiceSectionHandler, Com.Example.Labs.Core&quot; /&gt;
    &lt;section
      name=&quot;serviceProxyConfiguration&quot;
      type=&quot;Com.Example.Labs.ClientCore.ServiceProxySectionHandler, Com.Example.Labs.ClientCore&quot; /&gt;
  <span class="text-red text-bold">&lt;/configSections&gt;</span>

  <span class="text-red text-bold">&lt;serviceLocatorConfiguration&gt;</span>
    &lt;instances&gt;
      &lt;instance
        interface=&quot;System.ILoggerService, System.Extensions&quot;
        implementation=&quot;System.LoggerService, System.Extensions&quot;
        instancingMode=&quot;Singleton&quot; /&gt;
      &lt;instance
        interface=&quot;System.ICacheService, System.Extensions&quot;
        implementation=&quot;System.LocalMemoryCacheService, System.Extensions&quot;
        instancingMode=&quot;Singleton&quot; /&gt;
      &lt;instance
        interface=&quot;System.IMessengerService, System.Extensions&quot;
        implementation=&quot;System.MessengerService, System.Extensions&quot;
        instancingMode=&quot;Singleton&quot; /&gt;
      &lt;instance
        interface=&quot;System.ISmtpService, System.Extensions&quot;
        implementation=&quot;System.SmtpService, System.Extensions&quot;
        instancingMode=&quot;Singleton&quot; /&gt;
    &lt;/instances&gt;
  <span class="text-red text-bold">&lt;/serviceLocatorConfiguration&gt;</span>

  <span class="text-red text-bold">&lt;loggerServiceConfiguration</span>
    isEnabled=&quot;True&quot;
    outputPath=&quot;Logs\DefaultLogs.log.txt&quot; /&gt;

  <span class="text-red text-bold">&lt;smtpServiceConfiguration</span>
    hostname=&quot;smtp.free.fr&quot;
    port=&quot;25&quot;
    username=&quot;&quot;
    password=&quot;&quot;
    senderName=&quot;Com.Example.Labs Team&quot;
    from=&quot;contact&#64;example.com&quot;
    cc=&quot;&quot;
    bcc=&quot;&quot;
    redirection=&quot;&quot;
    enableSsl=&quot;false&quot;
    useDefaultCredentials=&quot;true&quot; /&gt;

  <span class="text-red text-bold">&lt;xmlExecutionTracerServiceConfiguration</span>
    isEnabled=&quot;True&quot;
    withDebugTrace=&quot;True&quot;
    outputPath=&quot;Logs\ExecutionTracer.log.xml&quot; /&gt;

  <span class="text-red text-bold">&lt;queueExecutionTracerServiceConfiguration</span>
    isEnabled=&quot;True&quot;
    withDebugTrace=&quot;True&quot;
    maxItems=&quot;1024&quot;
    rollTimer=&quot;1&quot; /&gt;

  <span class="text-red text-bold">&lt;serviceProxyConfiguration</span>
    isLocal=&quot;False&quot; /&gt;

  <span class="text-red text-bold">&lt;mailTemplateServiceConfiguration</span>
    path=&quot;App_Data\MailTemplates&quot; /&gt;
  
  <span class="hl slc text-bold">&lt;!-- DO NOT COPY THIS SECTION --&gt;
  &lt;connectionStrings&gt;
    &lt;add
      name=&quot;Default&quot;
      connectionString=&quot;Data Source=localhost;Initial Catalog=Labs;Integrated Security=SSPI;&quot; /&gt;
  &lt;/connectionStrings&gt;</span>

  <span class="text-red text-bold">&lt;system.serviceModel&gt;</span>
    &lt;behaviors&gt;
      &lt;endpointBehaviors&gt;
        &lt;behavior name=&quot;defaultEndpointBehavior&quot;&gt;
          &lt;technicalException /&gt;
          &lt;operationException /&gt;
          &lt;entityValidationException /&gt;
        &lt;/behavior&gt;
      &lt;/endpointBehaviors&gt;
    &lt;/behaviors&gt;
    &lt;client configSource=&quot;Config\ServiceModel.Client.generated.config&quot; /&gt;
    &lt;bindings&gt;
      &lt;wsHttpBinding&gt;
        &lt;binding
          closeTimeout=&quot;00:02:00&quot;
          openTimeout=&quot;00:02:00&quot;
          sendTimeout=&quot;00:02:00&quot;
          maxBufferPoolSize=&quot;2147483647&quot;
          maxReceivedMessageSize=&quot;2147483647&quot;&gt;
          &lt;readerQuotas
            maxArrayLength=&quot;2147483647&quot;
            maxNameTableCharCount=&quot;2147483647&quot;
            maxStringContentLength=&quot;2147483647&quot;
            maxDepth=&quot;2147483647&quot;
            maxBytesPerRead=&quot;2147483647&quot; /&gt;
          &lt;security mode=&quot;None&quot; /&gt;
          &lt;!--&lt;security mode=&quot;TransportWithMessageCredential&quot;&gt;
            &lt;transport
              clientCredentialType=&quot;None&quot;
              proxyCredentialType=&quot;None&quot;
              realm=&quot;&quot; /&gt;
            &lt;message
              clientCredentialType=&quot;UserName&quot;
              negotiateServiceCredential=&quot;true&quot;
              algorithmSuite=&quot;Default&quot;
              establishSecurityContext=&quot;true&quot; /&gt;
          &lt;/security&gt;--&gt;
        &lt;/binding&gt;
      &lt;/wsHttpBinding&gt;
    &lt;/bindings&gt;
    &lt;extensions&gt;
      &lt;behaviorExtensions&gt;
        &lt;add
          name=&quot;technicalException&quot;
          type=&quot;Com.Example.Labs.Core.TechnicalExceptionElement, Com.Example.Labs.Core&quot; /&gt;
        &lt;add
          name=&quot;operationException&quot;
          type=&quot;Com.Example.Labs.Core.OperationExceptionElement, Com.Example.Labs.Core&quot; /&gt;
        &lt;add
          name=&quot;entityValidationException&quot;
          type=&quot;Com.Example.Labs.Core.EntityValidationExceptionElement, Com.Example.Labs.Core&quot; /&gt;
      &lt;/behaviorExtensions&gt;
    &lt;/extensions&gt;
  <span class="text-red text-bold">&lt;/system.serviceModel&gt;</span>

&lt;/configuration&gt;</pre>
		<p class="action">Add the <span class="text-bold">Config</span> directory.</p>
		<img src="../ScreenShots/12-05.png" title="Illustration" alt="Illustration" />
		<p class="action">Add <span class="text-bold">Existing Item</span> on it.</p>
		<img src="../ScreenShots/12-06.png" title="Illustration" alt="Illustration" />
		<p class="action">Select (<span class="text-bold">Add</span> &gt; <span class="text-bold">Add As Link</span>) the two files located in the <span class="text-bold">Tests\Com.Example.Labs.Tests\Config\</span> directory.</p>
		<img src="../ScreenShots/12-07.png" title="Illustration" alt="Illustration" />
		<p>Result</p>
		<img src="../ScreenShots/12-08.png" title="Illustration" alt="Illustration" />
		<p class="action">Edit the <span class="text-bold">Com.Example.Labs.WebSite.csproj</span> with Notepad and add the following <span class="text-bold">Target</span> node before the final <span class="text-bold">&lt;/Project&gt;</span> tag.</p>
		<pre class="hl">  ...
  <span class="hl kwa">&lt;Target</span> <span class="hl kwb">Name</span>=<span class="hl str">&quot;CopyLinkedContentFiles&quot;</span>
          <span class="hl kwb">BeforeTargets</span>=<span class="hl str">&quot;Build&quot;</span><span class="hl kwa">&gt;</span>
    <span class="hl kwa">&lt;Copy</span> <span class="hl kwb">SourceFiles</span>=<span class="hl str">&quot;%(Content.Identity)&quot;</span> 
          <span class="hl kwb">DestinationFiles</span>=<span class="hl str">&quot;%(Content.Link)&quot;</span> 
          <span class="hl kwb">SkipUnchangedFiles</span>=<span class="hl str">'true' </span>
          <span class="hl kwb">OverwriteReadOnlyFiles</span>=<span class="hl str">'true' </span>
          <span class="hl kwb">Condition</span>=<span class="hl str">&quot;'%(Content.Link)' != ''&quot;</span> <span class="hl kwa">/&gt;</span>
  <span class="hl kwa">&lt;/Target&gt;</span>
<span class="hl kwa">&lt;/Project&gt;</span></pre>
		<p>This means that the process will copy the linked files at each build (otherwise Config directory is empty).</p>
		<p>The MVC project is now ready to consume the WebServices layer through the <span class="text-bold">ServiceProxy&lt;T&gt;</span> class.</p>
    </section>
</body>
</html>
