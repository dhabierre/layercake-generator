<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
    <title>LCG - 06 - Custom Stored Procedures</title>
    <link rel="stylesheet" type="text/css" href="../Styles/Highlight.css">
    <link rel="stylesheet" type="text/css" href="../Styles/Styles.css">
</head>
<body>
    <h1>Lab 06 - Custom Stored Procedures</h1>
    <section>
        <p>Duration: <span class="text-bold">~30mins</span></p>
    </section>
    <section>
        <p>In the previous lab (Lab - 05 - Business Layer) we have created the <span class="text-bold">GetClientWithCommands()</span> business method.</p>
		<p>Each highlighted method access to the database. This approach is quite easy but implies too many database access.</p>
        <pre class="hl"><span class="text-red text-bold">[BusinessMethod]</span>
<span class="hl kwa">public</span> Client <span class="hl kwd">GetClientWithCommands</span><span class="hl opt">(</span>IUserContext userContext<span class="hl opt">,</span> <span class="hl kwb">int</span> clientRef<span class="hl opt">,</span> <span class="hl kwb">bool</span> withProducts <span class="hl opt">=</span> <span class="hl kwa">false</span><span class="hl opt">)</span>
<span class="hl opt">{</span>
    <span class="hl kwa">var</span> client <span class="hl opt">=</span> <span class="hl kwa">this</span><span class="hl opt">.</span><span class="highlight-text">GetClientByRef</span><span class="hl opt">(</span>userContext<span class="hl opt">,</span> clientRef<span class="hl opt">);</span>
    <span class="hl kwa">if</span> <span class="hl opt">(</span>client <span class="hl opt">!=</span> <span class="hl kwa">null</span><span class="hl opt">)</span>
    <span class="hl opt">{</span>
        <span class="hl kwa">using</span> <span class="hl opt">(</span><span class="hl kwa">var</span> et <span class="hl opt">=</span> <span class="hl kwa">new</span> <span class="hl kwd">ExecutionTracerService</span><span class="hl opt">())</span>
        <span class="hl kwa">using</span> <span class="hl opt">(</span><span class="hl kwa">var</span> dbClient <span class="hl opt">=</span> <span class="hl kwa">new</span> <span class="hl kwd">ClientCrud</span><span class="hl opt">(</span>userContext<span class="hl opt">))</span>
        <span class="hl kwa">using</span> <span class="hl opt">(</span><span class="hl kwa">var</span> dbCommand <span class="hl opt">=</span> <span class="hl kwa">new</span> <span class="hl kwd">CommandCrud</span><span class="hl opt">(</span>userContext<span class="hl opt">))</span>
        <span class="hl opt">{</span>
            dbClient<span class="hl opt">.</span><span class="highlight-text">LoadCommandCollection</span><span class="hl opt">(</span><span class="hl kwa">ref</span> client<span class="hl opt">);</span> <span class="hl slc">// retrieve all the commands of the client (-&gt; client.CommandCollection)</span>

            client<span class="hl opt">.</span>CommandCollection<span class="hl opt">.</span><span class="hl kwd">AsParallel</span><span class="hl opt">().</span><span class="hl kwd">AsOrdered</span><span class="hl opt">().</span><span class="hl kwd">ForEach</span><span class="hl opt">(</span>command <span class="hl opt">=&gt;</span> <span class="hl slc">// .AsParallel() -&gt; PLINQ feature</span>
            <span class="hl opt">{</span>
                var currentCommand <span class="hl opt">=</span> command<span class="hl opt">;</span>
                dbCommand<span class="hl opt">.</span><span class="highlight-text">LoadCommandStatus</span><span class="hl opt">(</span><span class="hl kwa">ref</span> currentCommand<span class="hl opt">);</span>

                <span class="hl kwa">if</span> <span class="hl opt">(</span>withProducts<span class="hl opt">)</span> <span class="hl slc">// retrieve commandlines and products</span>
                <span class="hl opt">{</span>
                    dbCommand<span class="hl opt">.</span><span class="highlight-text">LoadCommandLineCollection</span><span class="hl opt">(</span><span class="hl kwa">ref</span> currentCommand<span class="hl opt">);</span>

                    <span class="hl kwa">using</span> <span class="hl opt">(</span>CommandLineCrud dbCommandLine <span class="hl opt">=</span> <span class="hl kwa">new</span> <span class="hl kwd">CommandLineCrud</span><span class="hl opt">(</span>userContext<span class="hl opt">))</span>
                    <span class="hl opt">{</span>
                        currentCommand<span class="hl opt">.</span>CommandLineCollection<span class="hl opt">.</span><span class="hl kwd">AsParallel</span><span class="hl opt">().</span><span class="hl kwd">AsOrdered</span><span class="hl opt">().</span><span class="hl kwd">ForEach</span><span class="hl opt">(</span>commandLine <span class="hl opt">=&gt;</span>
                        <span class="hl opt">{</span>
                            var currentCommandLine <span class="hl opt">=</span> commandLine<span class="hl opt">;</span>
                            dbCommandLine<span class="hl opt">.</span><span class="highlight-text">LoadProduct</span><span class="hl opt">(</span><span class="hl kwa">ref</span> currentCommandLine<span class="hl opt">);</span>
                        <span class="hl opt">});</span>
                    <span class="hl opt">}</span>
                <span class="hl opt">}</span>
            <span class="hl opt">});</span>
        <span class="hl opt">}</span>
    <span class="hl opt">}</span>

    <span class="hl kwa">return</span> client<span class="hl opt">;</span>
<span class="hl opt">}</span></pre>
        <p>In fact we could use a stored procedure to retrieve the data one-shot.</p>
        <h2>2. Extend The Crud layer with custom Stored Procedures</h2>
        <p class="action">Add the following stored procedure on the SQL Server.</p>
        <div class="box important">
            <h3>Database Project</h3>
            <div class="box-content">If you use the Database Project, add the stored procedure in the \dbo\Stored Procedures\ folder and do not forget to synchronize (Compare/Update operation) the Database Project with the database in order to create the stored procedures on the SQL Server).</div>
        </div>
        <pre class="hl"><span class="hl kwa">CREATE PROCEDURE</span> <span class="hl opt">[</span>dbo<span class="hl opt">]</span>.<span class="hl opt">[</span>Client_Custom_GetClientWithCommands<span class="hl opt">]</span>
<span class="hl opt">(</span>
    &#64;ClientRef <span class="hl kwb">INT</span><span class="hl opt">,</span>

    &#64;CtxUser <span class="hl kwb">BIGINT</span><span class="hl opt"> =</span> <span class="hl kwa">NULL</span><span class="hl opt">,</span>		<span class="hl slc">-- Parameter required by LCG. Not used there</span>
    &#64;CtxCulture <span class="hl kwb">VARCHAR</span><span class="hl opt">(</span><span class="hl num">2</span><span class="hl opt">) =</span> <span class="hl str">N'EN'</span><span class="hl opt">,</span>	<span class="hl slc">-- Parameter required by LCG. Not used there</span>
    &#64;CtxWithContextSecurity <span class="hl kwa">BIT</span> <span class="hl opt">=</span> <span class="hl kwa">NULL</span>	<span class="hl slc">-- Parameter required by LCG. Not used there</span>
<span class="hl opt">)</span>
<span class="hl kwa">AS</span>
<span class="hl kwa">BEGIN</span>
    <span class="hl kwa">SET NOCOUNT ON</span><span class="hl opt">;</span>

    <span class="hl kwa">SELECT</span>
        <span class="hl opt">[</span>Client<span class="hl opt">]</span>.<span class="hl opt">*,</span>
        <span class="hl opt">[</span>Command<span class="hl opt">]</span>.<span class="hl opt">*,</span>
        <span class="hl opt">[</span>CommandLine<span class="hl opt">]</span>.<span class="hl opt">*,</span>
        <span class="hl opt">[</span>CommandStatus<span class="hl opt">]</span>.<span class="hl opt">*,</span>
        <span class="hl opt">[</span>Product<span class="hl opt">]</span>.<span class="hl opt">*</span>
        
    <span class="hl kwa">FROM</span>
        <span class="hl opt">[</span>Client<span class="hl opt">]</span> <span class="hl kwa">WITH</span><span class="hl opt">(</span><span class="hl kwa">NOLOCK</span><span class="hl opt">)</span>
        <span class="hl kwa">INNER JOIN</span> <span class="hl opt">[</span>Command<span class="hl opt">]</span> <span class="hl kwa">WITH</span><span class="hl opt">(</span><span class="hl kwa">NOLOCK</span><span class="hl opt">)</span> <span class="hl kwa">ON</span> <span class="hl opt">[</span>Command<span class="hl opt">]</span>.<span class="hl opt">[</span>Command_IdClient<span class="hl opt">] = [</span>Client<span class="hl opt">]</span>.<span class="hl opt">[</span>Client_Id<span class="hl opt">]</span>
         <span class="hl kwa">LEFT JOIN</span> <span class="hl opt">[</span>CommandLine<span class="hl opt">]</span> <span class="hl kwa">WITH</span><span class="hl opt">(</span><span class="hl kwa">NOLOCK</span><span class="hl opt">)</span> <span class="hl kwa">ON</span> <span class="hl opt">[</span>CommandLine<span class="hl opt">]</span>.<span class="hl opt">[</span>CommandLine_IdCommand<span class="hl opt">] = [</span>Command<span class="hl opt">]</span>.<span class="hl opt">[</span>Command_Id<span class="hl opt">]</span>
         <span class="hl kwa">LEFT JOIN</span> <span class="hl opt">[</span>CommandStatus<span class="hl opt">]</span> <span class="hl kwa">WITH</span><span class="hl opt">(</span><span class="hl kwa">NOLOCK</span><span class="hl opt">)</span> <span class="hl kwa">ON</span> <span class="hl opt">[</span>CommandStatus<span class="hl opt">]</span>.<span class="hl opt">[</span>CommandStatus_Id<span class="hl opt">] = [</span>Command<span class="hl opt">]</span>.<span class="hl opt">[</span>Command_IdCommandStatus<span class="hl opt">]</span>
         <span class="hl kwa">LEFT JOIN</span> <span class="hl opt">[</span>Product<span class="hl opt">]</span> <span class="hl kwa">WITH</span><span class="hl opt">(</span><span class="hl kwa">NOLOCK</span><span class="hl opt">)</span> <span class="hl kwa">ON</span> <span class="hl opt">[</span>Product<span class="hl opt">]</span>.<span class="hl opt">[</span>Product_Id<span class="hl opt">] = [</span>CommandLine<span class="hl opt">]</span>.<span class="hl opt">[</span>CommandLine_IdProduct<span class="hl opt">]</span>
        
    <span class="hl kwa">WHERE</span>
        <span class="hl opt">[</span>Client<span class="hl opt">]</span>.<span class="hl opt">[</span>Client_Ref<span class="hl opt">] =</span> &#64;ClientRef

<span class="hl kwa">END</span>
<span class="hl kwa">GO</span></pre>
        <p class="action">Open the <span class="text-bold">Com.Example.Labs.Crud</span> project</p>
        <p class="action">Edit the <span class="text-bold">ClientCrud.custom.cs</span> file and add the following method.</p>
        <pre class="hl"><span class="hl kwa">public</span> Client <span class="hl kwd">GetClientWithCommands</span><span class="hl opt">(</span><span class="hl kwb">int</span> clientRef<span class="hl opt">,</span> <span class="hl kwb">bool</span> withProducts <span class="hl opt">=</span> <span class="hl kwa">false</span><span class="hl opt">)</span>
<span class="hl opt">{</span>
    <span class="hl kwa">var</span> parameters <span class="hl opt">=</span> <span class="hl kwa">new</span> Dictionary<span class="hl opt">&lt;</span><span class="hl kwb">string</span><span class="hl opt">,</span> <span class="hl kwb">object</span><span class="hl opt">&gt;();</span>
    parameters<span class="hl opt">.</span><span class="hl kwd">Add</span><span class="hl opt">(</span><span class="hl str">&quot;&#64;ClientRef&quot;</span><span class="hl opt">,</span> clientRef<span class="hl opt">);</span>

    <span class="hl kwa">using</span> <span class="hl opt">(</span><span class="hl kwa">var</span> et <span class="hl opt">=</span> <span class="hl kwa">new</span> <span class="hl kwd">ExecutionTracerService</span><span class="hl opt">())</span>
    <span class="hl opt">{</span>
        <span class="hl kwa">return base</span><span class="hl opt">.</span><span class="hl kwd">ToEntityCollection</span><span class="hl opt">(</span><span class="hl str">&quot;Client_Custom_GetClientWithCommands&quot;</span><span class="hl opt">,</span> parameters<span class="hl opt">).</span><span class="hl kwd">FirstOrDefault</span><span class="hl opt">();</span>
    <span class="hl opt">}</span>
<span class="hl opt">}</span></pre>
        <div class="box important">
            <h3>Retrieve Data</h3>
            <ul>
                <li>
                    <div class="field">ToEntityCollection</div>
                    <div class="description">withDeepMapping = true | null (default value) -> Returns a <span class="text-bold">TCollection</span> WITH all possible children entities (automatic deep mapping)</div>
                    <div class="description">withDeepMapping = false -> Returns a <span class="text-bold">TCollection</span> WITHOUT children entities</div>
                </li>
                <li>
                    <div class="field">ToDataReader</div>
                    <div class="description">Returns an object implementing <span class="text-bold">IDataReader</span> interface (seems to be the fatest method)</div>
                    <pre class="hl">DbConnection dbConnection <span class="hl opt">=</span> <span class="hl kwa">null</span><span class="hl opt">;</span>

<span class="hl kwa">using</span> <span class="hl opt">(</span>IDataReader dbReader <span class="hl opt">=</span> <span class="hl kwa">base</span><span class="hl opt">.</span><span class="text-red">ToDataReader</span><span class="hl opt">(</span>
    <span class="hl str">&quot;Client_Custom_GetClientWithCommands&quot;</span><span class="hl opt">,</span> parameters<span class="hl opt">,</span> <span class="hl kwa">out</span> dbConnection<span class="hl opt">))</span>
<span class="hl opt">{</span>
    <span class="hl kwa">while</span> <span class="hl opt">(</span>dbReader<span class="hl opt">.</span><span class="hl kwd">Read</span><span class="hl opt">())</span>
    <span class="hl opt">{</span>
        Client client <span class="hl opt">=</span> <span class="hl kwa">new</span> <span class="hl kwd">Client</span><span class="hl opt">();</span>
        client<span class="hl opt">.</span><span class="hl kwd">Map</span><span class="hl opt">(</span>dbReader<span class="hl opt"><span class="hl opt">, </span><span class="hl kwa">base</span><span class="hl opt">.</span>UserContext);</span>

        <span class="hl opt">...</span>
    <span class="hl opt">}</span>
<span class="hl opt">}</span>

<span class="text-bold text-red">if (dbConnection != null) { dbConnection.Close(); }</span></pre>
                </li>
                <li>
                    <div class="field">ToDataTable</div>
                    <div class="description">Returns a <span class="text-bold">DataTable</span> object (use it when the stored procedure returns 1 SELECT)</div>
                    <pre class="hl"><span class="hl kwa">using</span> <span class="hl opt">(</span>DataTable dt <span class="hl opt">=</span> <span class="hl kwa">base</span><span class="hl opt">.</span><span class="text-red">ToDataTable</span><span class="hl opt">(</span>
    <span class="hl str">&quot;Client_Custom_GetClientWithCommands&quot;</span><span class="hl opt">,</span> <span class="hl str">&quot;Client&quot;</span><span class="hl opt">,</span> <span class="hl kwa">null</span><span class="hl opt">))</span>
<span class="hl opt">{</span>
    <span class="hl kwa">foreach</span> <span class="hl opt">(</span>DataRow row <span class="hl kwa">in</span> dt<span class="hl opt">.</span>Rows<span class="hl opt">)</span>
    <span class="hl opt">{</span>
        Client client <span class="hl opt">=</span> <span class="hl kwa">new</span> <span class="hl kwd">Client</span><span class="hl opt">();</span>
        client<span class="hl opt">.</span><span class="hl kwd">Map</span><span class="hl opt">(</span>row<span class="hl opt"><span class="hl opt">, </span><span class="hl kwa">base</span><span class="hl opt">.</span>UserContext);</span>

        <span class="hl opt">...</span>
    <span class="hl opt">}</span>
<span class="hl opt">}</span></pre>
                </li>
                <li>
                    <div class="field">ToDataSet</div>
                    <div class="description">Returns a <span class="text-bold">DataSet</span> object (use it when the stored procedure returns many SELECT)</div>
                    <pre class="hl"><span class="hl kwa">using</span> <span class="hl opt">(</span>DataSet ds <span class="hl opt">=</span> <span class="hl kwa">base</span><span class="hl opt">.</span><span class="text-red">ToDataSet</span><span class="hl opt">(</span>
    <span class="hl str">&quot;Client_Custom_GetSomeData&quot;</span><span class="hl opt">,</span> parameters<span class="hl opt">,</span> <span class="hl str">&quot;TableResult1&quot;</span><span class="hl opt">,</span> <span class="hl str">&quot;TableResult2&quot;</span><span class="hl opt">,</span> <span class="hl str">&quot;TableResult3&quot;</span><span class="hl opt">))</span>
<span class="hl opt">{</span>
    DataTable dt1 <span class="hl opt">=</span> ds<span class="hl opt">.</span>Tables<span class="hl opt">[</span><span class="hl str">&quot;TableResult1&quot;</span><span class="hl opt">];</span>

    <span class="hl opt">...</span>
<span class="hl opt">}</span></pre>
                </li>
            </ul>
        </div>
        <p>Note: custom mapping is also possible using Map() and DeepMap() methods defined in the Model Layer.</p>
        <div class="box important">
            <h3>Data Mapping Helpers On Model Layer</h3>
            <ul>
                <li>
                    <div class="field">Entity.Map(IDataReader) &amp; Entity.Map(DataRow)</div>
                    <div class="description">Transforms a IDataReader/DataRow object to an entity <span class="text-red">without its children</span></div>
                </li>
                <li>
                    <div class="field">Entity.DeepMap(IDataReader) &amp; Entity.DeepMap(DataRow)</div>
                    <div class="description">Transforms a IDataReader/DataRow object to an entity <span class="text-red">with its children</span></div>
                </li>
            </ul>
        </div>
        <p class="action">Open the <span class="text-bold">Com.Example.Labs.Business</span> project and add (or edit) the method in the <span class="text-bold">ClientBusiness.custom.cs</span> file.</p>
        <pre class="hl"><span class="text-red text-bold">[BusinessMethod]</span>
<span class="hl kwa">public</span> Client <span class="hl kwd">GetClientWithCommands</span><span class="hl opt">(</span>IUserContext userContext<span class="hl opt">,</span> <span class="hl kwb">int</span> clientRef<span class="hl opt">,</span> <span class="hl kwb">bool</span> withProducts <span class="hl opt">=</span> <span class="hl kwa">false</span><span class="hl opt">)</span>
<span class="hl opt">{</span>
    <span class="hl kwa">using</span> <span class="hl opt">(</span><span class="hl kwa">var</span> et <span class="hl opt">=</span> <span class="hl kwa">new</span> <span class="hl kwd">ExecutionTracerService</span><span class="hl opt">())</span>
    <span class="hl kwa">using</span> <span class="hl opt">(</span><span class="hl kwa">var</span> db <span class="hl opt">=</span> <span class="hl kwa">new</span> <span class="hl kwd">ClientCrud</span><span class="hl opt">(</span>userContext<span class="hl opt">))</span>
    <span class="hl opt">{</span>
        <span class="hl kwa">return</span> db<span class="hl opt">.</span><span class="hl kwd">GetClientWithCommands</span><span class="hl opt">(</span>clientRef<span class="hl opt">,</span> withProducts<span class="hl opt">);</span>
    <span class="hl opt">}</span>
<span class="hl opt">}</span></pre>
		<p class="action">Finally compile the solution again and run LayerCake Generator to integrate the new Business method on Service &amp; WCF layers.</p>
		<img src="../ScreenShots/06-01.png" title="Illustration" alt="Illustration" />
    </section>
</body>
</html>
