<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
	<title>LCG - Lab 03 - First Steps</title>
	<link rel="stylesheet" type="text/css" href="../Styles/Highlight.css">
	<link rel="stylesheet" type="text/css" href="../Styles/Styles.css">
</head>
<body>
	<h1>Lab 03 - First Steps</h1>
	<section>
		<p>Duration: <span class="text-bold">~30mins</span></p>
	</section>
	<section>
		<h2>1. Pre-Requirements</h2>
		<p class="action">Launch <span class="text-bold">SQL Server Management Studio</span></p>
		<p>To avoid the following message when working on the database's structure...</p>
		<img src="../ScreenShots/03-01.png" title="Illustration" alt="Illustration" />
		<p class="action">Go to <span class="text-bold">Tools</span> -> <span class="text-bold">Options</span> -> <span class="text-bold">Designers</span> node and uncheck the <span class="text-bold">Prevent saving changes that require table re-creation</span> option.</p>
		<img src="../ScreenShots/03-02.png" title="Illustration" alt="Illustration" />
	</section>
	<section>
		<h2>2. First Steps With LayerCake Generator</h2>
		<p>In this part we assume that you are comfortable with relational data models and Database Project.</p>
		<p>Database Project - From <a href="http://msdn.microsoft.com/en-us/library/xee70aty.aspx" title="Working with Database Projects" target="_blank">MSDN</a></p>
		<p class="quote">You can use database projects to create new databases, new data-tier applications (DACs), and to update existing databases and data-tier applications. Both database projects and DAC projects enable you to apply version control and project management techniques to your database development efforts in much the same way that you apply those techniques to managed or native code. You can help your development team manage changes to databases and database servers by creating a DAC project, database project, or a server project and putting it under version control. Members of your team can then check out files to make, build, and test changes in an isolated development environment, or sandbox, before sharing them with the team. To help ensure code quality, your team can finish and test all changes for a particular release of the database in a staging environment before you deploy the changes into production.</p>
		<div class="box warning">
			<h3>Database Project Synchronization</h3>
			<div class="box-content">In the next steps we use SQL Management Studio to manage the database. We could use directly the Database Project but we don't. Just keep in mind that the Database Project and the database MUST BE SYNCHRONIZED to each other!</div>
		</div>
		<div class="box important">
			<h3>Don't use the Database Project?</h3>
			<div class="box-content">If you do not want to use the Database Project you can unload it from the solution but DO NOT REMOVE IT FROM THE FILESYSTEM!</div>
		</div>
		<p class="action">To avoid synchronization errors in the labs (out-of scope) unload the Database Project from the solution.</p>
		<img src="../ScreenShots/03-04.png" title="Illustration" alt="Illustration" />
	</section>
	<section>
		<h3>2. 1. Database Schema</h3>
		<p>In this lab we are going to work with the following schema.</p>
		<img src="../ScreenShots/03-05.png" title="Illustration" alt="Illustration" />
		<div class="box warning">
			<h3>Column Names</h3>
			<div class="box-content">Must be named <span class="text-bold">&lt;TABLE_NAME&gt;_&lt;COLUMN_NAME&gt;</span></div>
			<div class="box-content"><u>Example:</u> Client_Firstname, Command_IsPaid...</div>
		</div>
		<div class="box warning">
			<h3>Primary Key</h3>
			<ul>
				<li>Must be named <span class="text-bold">&lt;TABLE_NAME&gt;_Id</span></li>
				<li>Data type must be <span class="text-bold">BIGINT</span> and <span class="text-bold">IDENTITY</span></li>
				<li>Must be <span class="text-bold">NOT NULL</span></li>
			</ul>
			<div class="box-content"><u>Example:</u> Client_Id, Product_Id...</div>
		</div>
		<div class="box warning">
			<h3>Foreign Key</h3>
			<ul>
				<li>Must be named <span class="text-bold">&lt;TABLE_NAME&gt;_Id&lt;REFERENCED_TABLE_NAME&gt;</span></li>
				<li>Data type must be <span class="text-bold">BIGINT</span></li>
				<li>Can be <span class="text-bold">NULL</span> or <span class="text-bold">NOT NULL</span></li>
			</ul>
			<div class="box-content"><u>Example:</u> Client_IdCountry, Command_IdProduct...</div>
		</div>
		<div class="box warning">
			<h3>CodeRef Column</h3>
			<div class="box-content">It is a reserved column name which is useful for reference tables. When a reference table has this column LayerCake will create a special method in order to access to a record given a CodeRef value.</div>
			<ul class="with-left-spacer">
				<li>Data type must be <span class="text-bold">VARCHAR(...)</span></li>
				<li>
					Requires an <span class="text-bold">UNIQUE CONSTRAINT</span>
					<pre class="hl"><span class="hl kwa">ALTER TABLE</span> <span class="hl opt">[</span>Category<span class="hl opt">]</span>
<span class="hl kwa">ADD CONSTRAINT</span> <span class="hl opt">[</span>UQ_Category_CodeRef<span class="hl opt">]</span> <span class="hl kwa">UNIQUE</span> <span class="hl opt">([</span>Category_CodeRef<span class="hl opt">])</span></pre>
					<pre class="hl"><span class="hl kwa">ALTER TABLE</span> <span class="hl opt">[</span>CommandStatus<span class="hl opt">]</span>
<span class="hl kwa">ADD CONSTRAINT</span> <span class="hl opt">[</span>UQ_CommandStatus_CodeRef<span class="hl opt">]</span> <span class="hl kwa">UNIQUE</span> <span class="hl opt">([</span>CommandStatus_CodeRef<span class="hl opt">])</span></pre>
				</li>
			</ul>
			<div class="box-content"><u>Example:</u> CommandStatus_CodeRef, Category_CodeRef...</div>
		</div>
		<div class="box warning">
			<h3>Multilanguage Columns</h3>
			<ul>
				<li>
					<div>Must be named <span class="text-bold">&lt;COLUMN_NAME&gt;_&lt;CULTURE&gt;</span> (as defined in the <span class="text-bold">Translation</span> table).</div>
					<div><img src="../ScreenShots/03-06.png" title="Illustration" alt="Illustration" /></div>
				</li>
				<li>Data types must be exactly the same (type, length, nullable)</li>
				<li>Default values are supported</li>
			</ul>
			<div class="box-content"><u>Example:</u> Product_Name_EN, Product_Name_FR...</div>
		</div>
		<p>Let's update the database's structure!</p>
		<p class="action">Get the SQL script <a href="../Resources/Lab03-UpdateDatabase.txt" target="_blank" class="red-round">here</a> and execute it on the <span class="text-bold">Labs</span> database to update the schema.</p>
		<p class="action">Run <span class="text-bold">LayerCake Generator and select the configuration file</span>.</p>
		<div><img src="../ScreenShots/03-07.png" title="Illustration" alt="Illustration" /></div>
		<p class="action">Check the new/modified tables only and press the <span class="text-bold">Process</span> button to start the process.</p>
		<img src="../ScreenShots/03-08.png" title="Illustration" alt="Illustration" />
		<div class="box important">
			<h3>Process Options</h3>
			<ul>
				<li>The <span class="text-bold">With SQL Procedure Integration</span> option is used to create and/or update the stored procedures on SQL Server side (this action can take a couple of seconds to complete)</li>
				<li>The <span class="text-bold">With Business Integration</span> option cannot be unchecked</li>
			</ul>
			<ul>
				<li>Check all the tables and the <em>With SQL Procedure Integration</em> option to execute the full process (in other words the code will be fully updated)</li>
				<li>Check only the new or modified tables to reduce the process</li>
				<li>You should check the <em>SQL Procedure Integration</em> option when a table is created or modified</li>
				<li>The <em>SQL Procedure Integration</em> option should be unchecked when working on business classes only (see later)</li>
			</ul>
		</div>
		<p>Once done LayerCake Generator warns that new services have been created.</p>
		<img src="../ScreenShots/03-09.png" title="Illustration" alt="Illustration" />
	</section>
	<section>
		<h3>2. 2. First steps with code!</h3>
		<p>In this part we are going to create a Console Application and write simple code <span class="text-underline">without using WCF layer</span> (this point will be see later).</p>
		<p class="action">First add a <span class="text-bold">Console Application</span> project to the solution. Name it <span class="text-bold">Com.Example.Labs.FirstStepsConsole</span>.</p>
		<p class="action">Then add the following Solution&gt;Projects references</p>
		<ul>
			<li>Com.Example.Labs.ClientCore</li>
			<li>Com.Example.Labs.Contracts</li>
			<li>Com.Example.Labs.Core</li>
			<li>Com.Example.Labs.Models</li>
			<li>Com.Example.Labs.Services</li>
			<li>System.Extensions</li>
		</ul>
		<img src="../ScreenShots/03-10.png" title="Illustration" alt="Illustration" />
		<p class="action">Find your Default the connection string from the <span class="text-bold">Tests\Com.Example.Labs.Tests\App.config</span> file and add it in the <span class="text-bold">App.config</span> file (because we won't use WCF layer).</p>
		<p>Example</p>
		<pre class="hl">﻿<span class="hl kwa">&lt;?xml</span> <span class="hl kwb">version</span>=<span class="hl str">&quot;1.0&quot;</span> <span class="hl kwb">encoding</span>=<span class="hl str">&quot;utf-8&quot;</span> <span class="hl kwa">?&gt;</span>
<span class="hl kwa">&lt;configuration&gt;</span>
    <span class="hl kwa">&lt;startup&gt;</span>
        <span class="hl kwa">&lt;supportedRuntime</span> <span class="hl kwb">version</span>=<span class="hl str">&quot;v4.0&quot;</span> <span class="hl kwb">sku</span>=<span class="hl str">&quot;.NETFramework,Version=v4.5&quot;</span> <span class="hl kwa">/&gt;</span>
    <span class="hl kwa">&lt;/startup&gt;</span>
    <span class="highlight-text text-bold">&lt;connectionStrings&gt;</span>
    <span class="highlight-text text-bold">      &lt;add</span>
    <span class="highlight-text text-bold">        name=&quot;Default&quot;</span>
    <span class="highlight-text text-bold">        connectionString=&quot;Data Source=localhost;Initial Catalog=Labs;Integrated Security=SSPI;&quot; /&gt;</span>
    <span class="highlight-text text-bold">&lt;/connectionStrings&gt;</span>
<span class="hl kwa">&lt;/configuration&gt;</span></pre>
		<p class="action">Finally copy and paste the following code in the <span class="text-bold">Program.cs</span> file.</p>
		<pre class="hl"><span class="hl kwa">namespace</span> Com<span class="hl opt">.</span>Example<span class="hl opt">.</span>Labs<span class="hl opt">.</span>FirstStepsConsole
<span class="hl opt">{</span>
    <span class="hl kwa">using</span> Com<span class="hl opt">.</span>Example<span class="hl opt">.</span>Labs<span class="hl opt">.</span>ClientCore<span class="hl opt">;</span>
    <span class="hl kwa">using</span> Com<span class="hl opt">.</span>Example<span class="hl opt">.</span>Labs<span class="hl opt">.</span>Contracts<span class="hl opt">;</span>
    <span class="hl kwa">using</span> Com<span class="hl opt">.</span>Example<span class="hl opt">.</span>Labs<span class="hl opt">.</span>Core<span class="hl opt">;</span>
    <span class="hl kwa">using</span> Com<span class="hl opt">.</span>Example<span class="hl opt">.</span>Labs<span class="hl opt">.</span>Models<span class="hl opt">;</span>
    <span class="hl kwa">using</span> Com<span class="hl opt">.</span>Example<span class="hl opt">.</span>Labs<span class="hl opt">.</span>Services<span class="hl opt">;</span>

    <span class="hl kwa">using</span> System<span class="hl opt">;</span>
    <span class="hl kwa">using</span> System<span class="hl opt">.</span>Collections<span class="hl opt">.</span>Generic<span class="hl opt">;</span>
    <span class="hl kwa">using</span> System<span class="hl opt">.</span>Linq<span class="hl opt">;</span>

    <span class="hl kwa">class</span> Program
    <span class="hl opt">{</span>
        <span class="hl slc">// All service calls require a IUserContext context (this point will be see later).</span>
        <span class="hl kwa">private static</span> IUserContext userContext <span class="hl opt">=</span> ClientContext<span class="hl opt">.</span>Anonymous<span class="hl opt">;</span>
        
        <span class="hl kwa">static</span> <span class="hl kwb">void</span> <span class="hl kwd">Main</span><span class="hl opt">(</span><span class="hl kwb">string</span><span class="hl opt">[]</span> args<span class="hl opt">)</span>
        <span class="hl opt">{</span>
            <span class="hl slc">// 1. </span>
            <span class="hl slc">// -----------------------------------------------------</span>
                
            <span class="hl slc">// Create and store some countries in database</span>
                
            <span class="hl kwa">foreach</span> <span class="hl opt">(</span>var countryName <span class="hl kwa">in new</span> List<span class="hl opt">&lt;</span><span class="hl kwb">string</span><span class="hl opt">&gt; {</span> <span class="hl str">&quot;England&quot;</span><span class="hl opt">,</span> <span class="hl str">&quot;France&quot;</span><span class="hl opt">,</span> <span class="hl str">&quot;Spain&quot;</span> <span class="hl opt">})</span>
            <span class="hl opt">{</span>
                Country country <span class="hl opt">=</span> <span class="hl kwa">new</span> <span class="hl kwd">Country</span><span class="hl opt">();</span>
                
                country<span class="hl opt">.</span>Name<span class="hl opt">.</span>EN <span class="hl opt">=</span> <span class="hl kwb">string</span><span class="hl opt">.</span><span class="hl kwd">Format</span><span class="hl opt">(</span><span class="hl str">&quot;EN_{0}_{1}</span><span class="hl str">&quot;</span><span class="hl opt">,</span> countryName<span class="hl opt">,</span> RandomHelper<span class="hl opt">.</span><span class="hl kwd">GetNumber</span><span class="hl opt">(</span><span class="hl num">10000</span><span class="hl opt">,</span> <span class="hl num">99999</span><span class="hl opt">));</span>
                country<span class="hl opt">.</span>Name<span class="hl opt">.</span>FR <span class="hl opt">=</span> <span class="hl kwb">string</span><span class="hl opt">.</span><span class="hl kwd">Format</span><span class="hl opt">(</span><span class="hl str">&quot;FR_{0}_{1}</span><span class="hl str">&quot;</span><span class="hl opt">,</span> countryName<span class="hl opt">,</span> RandomHelper<span class="hl opt">.</span><span class="hl kwd">GetNumber</span><span class="hl opt">(</span><span class="hl num">10000</span><span class="hl opt">,</span> <span class="hl num">99999</span><span class="hl opt">));</span>
                
                <span class="hl slc">// NOTE: When a property is modified, the State property is automatically updated.</span>
                <span class="hl slc">//       Here country.State == ToInsert</span>
                
                <span class="hl kwa">using</span> <span class="hl opt">(</span><span class="hl kwa">var</span> service <span class="hl opt">=</span> <span class="hl kwa">new</span> ServiceProxy<span class="hl opt">&lt;</span>ICountryService<span class="hl opt">&gt;())</span>
                <span class="hl opt">{</span>
                    service<span class="hl opt">.</span>Proxy<span class="hl opt">.</span><span class="hl kwd">Save</span><span class="hl opt">(</span>userContext<span class="hl opt">,</span> <span class="hl kwa">ref</span> country<span class="hl opt">);</span>
                <span class="hl opt">}</span>
            <span class="hl opt">}</span>
                
            <span class="hl slc">// 2. </span>
            <span class="hl slc">// -----------------------------------------------------</span>
                
            <span class="hl slc">// Retrieve all countries where [Name_EN LIKE 'England']</span>
                
            var options <span class="hl opt">=</span> <span class="hl kwa">new</span> <span class="hl kwd">SearchOptions</span><span class="hl opt">();</span>
            options<span class="hl opt">.</span>Filters<span class="hl opt">.</span><span class="hl kwd">Add</span><span class="hl opt">(</span>Country<span class="hl opt">.</span>ColumnNames<span class="hl opt">.</span>Name_EN<span class="hl opt">,</span> FilterOperator<span class="hl opt">.</span>Like<span class="hl opt">,</span> <span class="hl str">&quot;England&quot;</span><span class="hl opt">);</span>
		    
            <span class="hl kwa">using</span> <span class="hl opt">(</span><span class="hl kwa">var</span> service <span class="hl opt">=</span> <span class="hl kwa">new</span> ServiceProxy<span class="hl opt">&lt;</span>ICountryService<span class="hl opt">&gt;())</span>
            <span class="hl opt">{</span>
                TCollection<span class="hl opt">&lt;</span>Country<span class="hl opt">&gt;</span> countries <span class="hl opt">=</span> service<span class="hl opt">.</span>Proxy<span class="hl opt">.</span><span class="hl kwd">Search</span><span class="hl opt">(</span>userContext<span class="hl opt">,</span> <span class="hl kwa">ref</span> options<span class="hl opt">);</span>
            <span class="hl opt">}</span>

            <span class="hl slc">// 3. </span>
            <span class="hl slc">// -----------------------------------------------------</span>

            <span class="hl slc">// Retrieve all countries where [Name_EN LIKE 'England'] OR [Name_FR LIKE 'France']</span>

            options<span class="hl opt">.</span><span class="hl kwd">Clear</span><span class="hl opt">();</span>
            options<span class="hl opt">.</span>Filters<span class="hl opt">.</span><span class="hl kwd">Add</span><span class="hl opt">(</span><span class="hl num">0</span><span class="hl opt">,</span> Country<span class="hl opt">.</span>ColumnNames<span class="hl opt">.</span>Name_EN<span class="hl opt">,</span> FilterOperator<span class="hl opt">.</span>Like<span class="hl opt">,</span> <span class="hl str">&quot;England&quot;</span><span class="hl opt">);</span>
            options<span class="hl opt">.</span>Filters<span class="hl opt">.</span><span class="hl kwd">Add</span><span class="hl opt">(</span><span class="hl num">1</span><span class="hl opt">,</span> Country<span class="hl opt">.</span>ColumnNames<span class="hl opt">.</span>Name_FR<span class="hl opt">,</span> FilterOperator<span class="hl opt">.</span>Like<span class="hl opt">,</span> <span class="hl str">&quot;France&quot;</span><span class="hl opt">);</span>

            <span class="hl kwa">using</span> <span class="hl opt">(</span><span class="hl kwa">var</span> service <span class="hl opt">=</span> <span class="hl kwa">new</span> ServiceProxy<span class="hl opt">&lt;</span>ICountryService<span class="hl opt">&gt;())</span>
            <span class="hl opt">{</span>
                TCollection<span class="hl opt">&lt;</span>Country<span class="hl opt">&gt;</span> countries <span class="hl opt">=</span> service<span class="hl opt">.</span>Proxy<span class="hl opt">.</span><span class="hl kwd">Search</span><span class="hl opt">(</span>userContext<span class="hl opt">,</span> <span class="hl kwa">ref</span> options<span class="hl opt">);</span>
            <span class="hl opt">}</span>

            <span class="hl slc">// 4.</span>
            <span class="hl slc">// -----------------------------------------------------</span>

            <span class="hl slc">// Retrieve all countries and remove them from database</span>

            options<span class="hl opt">.</span><span class="hl kwd">Clear</span><span class="hl opt">();</span> <span class="hl slc">// no filter</span>

            <span class="hl kwa">using</span> <span class="hl opt">(</span><span class="hl kwa">var</span> service <span class="hl opt">=</span> <span class="hl kwa">new</span> ServiceProxy<span class="hl opt">&lt;</span>ICountryService<span class="hl opt">&gt;())</span>
            <span class="hl opt">{</span>
                <span class="hl kwa">foreach</span> <span class="hl opt">(</span>var country <span class="hl kwa">in</span> service<span class="hl opt">.</span>Proxy<span class="hl opt">.</span><span class="hl kwd">Search</span><span class="hl opt">(</span>userContext<span class="hl opt">,</span> <span class="hl kwa">ref</span> options<span class="hl opt">)</span> <span class="hl com">/* no filter -&gt; all records are returned */</span><span class="hl opt">)</span>
                <span class="hl opt">{</span>
                    service<span class="hl opt">.</span>Proxy<span class="hl opt">.</span><span class="hl kwd">Delete</span><span class="hl opt">(</span>userContext<span class="hl opt">,</span> country<span class="hl opt">.</span>Id<span class="hl opt">);</span>
                <span class="hl opt">}</span>
            <span class="hl opt">}</span>

            <span class="hl slc">// 5. </span>
            <span class="hl slc">// -----------------------------------------------------</span>

            Client aClient <span class="hl opt">=</span> <span class="hl kwa">new</span> Client <span class="hl opt">{</span> Lastname <span class="hl opt">=</span> <span class="hl str">&quot;Doe&quot;</span> <span class="hl opt">};</span>

            <span class="hl kwa">using</span> <span class="hl opt">(</span><span class="hl kwa">var</span> clientService <span class="hl opt">=</span> <span class="hl kwa">new</span> ServiceProxy<span class="hl opt">&lt;</span>IClientService<span class="hl opt">&gt;())</span>
            <span class="hl kwa">using</span> <span class="hl opt">(</span><span class="hl kwa">var</span> countryService <span class="hl opt">=</span> <span class="hl kwa">new</span> ServiceProxy<span class="hl opt">&lt;</span>ICountryService<span class="hl opt">&gt;())</span>
            <span class="hl opt">{</span>
                <span class="hl kwa">try</span>
                <span class="hl opt">{</span>
                    clientService<span class="hl opt">.</span>Proxy<span class="hl opt">.</span><span class="hl kwd">Save</span><span class="hl opt">(</span>userContext<span class="hl opt">,</span> <span class="hl kwa">ref</span> aClient<span class="hl opt">);</span> <span class="hl slc">// here aClient is not valid because some mandatory fields are not set -&gt; throw EntityValidationException exception</span>
                <span class="hl opt">}</span>
                <span class="hl kwa">catch</span> <span class="hl opt">(</span>EntityValidationException x<span class="hl opt">)</span>
                <span class="hl opt">{</span>
                    Console<span class="hl opt">.</span><span class="hl kwd">WriteLine</span><span class="hl opt">(</span><span class="hl str">&quot;Cannot save the client in database!&quot;</span><span class="hl opt">);</span>
                    Console<span class="hl opt">.</span><span class="hl kwd">WriteLine</span><span class="hl opt">(</span><span class="hl str">&quot; Some mandatory fields are not set:&quot;</span><span class="hl opt">);</span>

                    <span class="hl kwa">foreach</span> <span class="hl opt">(</span>var error <span class="hl kwa">in</span> x<span class="hl opt">.</span>Translations<span class="hl opt">)</span>
                    <span class="hl opt">{</span>
                        Console<span class="hl opt">.</span><span class="hl kwd">WriteLine</span><span class="hl opt">(</span><span class="hl str">&quot;  -&gt; {0}&quot;</span><span class="hl opt">,</span> TranslationResolver<span class="hl opt">.</span>Current<span class="hl opt">.</span><span class="hl kwd">GetMessage</span><span class="hl opt">(</span>error<span class="hl opt">));</span>
                                
                        <span class="hl slc">// NOTE: TranslationResolver is used to translate TranslationEnums to string according the current culture.</span>
                        <span class="hl slc">//       Translations are located in the Translation table.</span>
                    <span class="hl opt">}</span>
                <span class="hl opt">}</span>

                aClient<span class="hl opt">.</span>Firstname <span class="hl opt">=</span> <span class="hl str">&quot;John&quot;</span><span class="hl opt">;</span>
                aClient<span class="hl opt">.</span>Email <span class="hl opt">=</span> <span class="hl str">&quot;jdoe&#64;nowhere.org&quot;</span><span class="hl opt">;</span>
                aClient<span class="hl opt">.</span>Ref <span class="hl opt">=</span> <span class="hl num">1234</span><span class="hl opt">;</span>

                Country aCountry <span class="hl opt">=</span> <span class="hl kwa">new</span> <span class="hl kwd">Country</span><span class="hl opt">();</span>

                aCountry<span class="hl opt">.</span>Name<span class="hl opt">.</span>EN <span class="hl opt">=</span> <span class="hl kwb">string</span><span class="hl opt">.</span><span class="hl kwd">Format</span><span class="hl opt">(</span><span class="hl str">&quot;EN_USA_{0}</span><span class="hl str">&quot;</span><span class="hl opt">,</span> RandomHelper<span class="hl opt">.</span><span class="hl kwd">GetNumber</span><span class="hl opt">(</span><span class="hl num">10000</span><span class="hl opt">,</span> <span class="hl num">99999</span><span class="hl opt">));</span>
                aCountry<span class="hl opt">.</span>Name<span class="hl opt">.</span>FR <span class="hl opt">=</span> <span class="hl kwb">string</span><span class="hl opt">.</span><span class="hl kwd">Format</span><span class="hl opt">(</span><span class="hl str">&quot;FR_USA_{0}</span><span class="hl str">&quot;</span><span class="hl opt">,</span> RandomHelper<span class="hl opt">.</span><span class="hl kwd">GetNumber</span><span class="hl opt">(</span><span class="hl num">10000</span><span class="hl opt">,</span> <span class="hl num">99999</span><span class="hl opt">));</span>

                aClient<span class="hl opt">.</span>Country <span class="hl opt">=</span> aCountry<span class="hl opt">;</span> <span class="hl slc">// NOTE: aCountry will be automatically inserted in the database</span>

                IList<span class="hl opt">&lt;</span>TranslationEnum<span class="hl opt">&gt;</span> validationErrors<span class="hl opt">;</span>

                <span class="hl kwa">if</span> <span class="hl opt">(</span>aClient<span class="hl opt">.</span><span class="hl kwd">IsValid</span><span class="hl opt">(</span>out validationErrors<span class="hl opt">))</span> <span class="hl slc">// check whether the aClient entity is valid</span>
                <span class="hl opt">{</span>
                    <span class="hl kwa">if</span> <span class="hl opt">(</span>aClient<span class="hl opt">.</span>Country<span class="hl opt">.</span><span class="hl kwd">IsValid</span><span class="hl opt">(</span>out validationErrors<span class="hl opt">))</span> <span class="hl slc">// check whether the aClient.Country entity is valid</span>
                    <span class="hl opt">{</span>
                        clientService<span class="hl opt">.</span>Proxy<span class="hl opt">.</span><span class="hl kwd">Save</span><span class="hl opt">(</span>userContext<span class="hl opt">,</span> <span class="hl kwa">ref</span> aClient<span class="hl opt">,</span> <span class="hl kwa">new</span> SaveOptions <span class="hl opt">{</span> SaveChildren <span class="hl opt">=</span> <span class="hl kwa">true</span> <span class="hl com">/* NOTE: perform Save() recursively (-&gt; Country then Client) */</span> <span class="hl opt">});</span>
                        clientService<span class="hl opt">.</span>Proxy<span class="hl opt">.</span><span class="hl kwd">LoadCountry</span><span class="hl opt">(</span>userContext<span class="hl opt">,</span> <span class="hl kwa">ref</span> aClient<span class="hl opt">);</span> <span class="hl slc">// load into aClient.Country property the associated Country instance</span>

                        aClient<span class="hl opt">.</span>Email <span class="hl opt">=</span> <span class="hl str">&quot;john.doe&#64;skynet.net&quot;</span><span class="hl opt">;</span>

                        <span class="hl slc">// NOTE: now aClient.State == ToUpdate</span>

                        clientService<span class="hl opt">.</span>Proxy<span class="hl opt">.</span><span class="hl kwd">Save</span><span class="hl opt">(</span>userContext<span class="hl opt">,</span> <span class="hl kwa">ref</span> aClient<span class="hl opt">);</span> <span class="hl slc">// update data</span>

                        <span class="hl slc">// Clear database</span>

                        clientService<span class="hl opt">.</span>Proxy<span class="hl opt">.</span><span class="hl kwd">Delete</span><span class="hl opt">(</span>userContext<span class="hl opt">,</span> aClient<span class="hl opt">.</span>Id<span class="hl opt">);</span>
                        countryService<span class="hl opt">.</span>Proxy<span class="hl opt">.</span><span class="hl kwd">Delete</span><span class="hl opt">(</span>userContext<span class="hl opt">,</span> aClient<span class="hl opt">.</span>Country<span class="hl opt">.</span>Id<span class="hl opt">);</span>
                    <span class="hl opt">}</span>
                <span class="hl opt">}</span>
            <span class="hl opt">}</span>

            Console<span class="hl opt">.</span><span class="hl kwd">ReadLine</span><span class="hl opt">();</span>
        <span class="hl opt">}</span>
    <span class="hl opt">}</span>
<span class="hl opt">}</span></pre>
		<p class="action">Run the program and use breakpoints to analyze the code at runtime.</p>
		<p>It's so simple :)</p>
	</section>
	<section>
		<h3>2. 3. What next?</h3>
		<p>In order to use advanced features (Cache, Logger, Smtp, Tracers...) and WCF (when invoking service.Proxy.Method()) we have to edit the <span class="text-bold">App.config</span>.</p>
		<p>Important files</p>
		<ul>
			<li>Tests\Com.Example.Labs.Tests\App.config (Advanced features &amp; WCF configuration)</li>
			<li>Tests\Com.Example.Labs.Tests\Config\ServiceModel.Client.generated.config (generated WCF endpoints)</li>
			<li>Tests\Com.Example.Labs.Tests\Config\ServiceModel.Client.custom.config (custom WCF endpoints)</li>
		</ul>
		<p class="action">Open the <span class="text-bold">Tests\Com.Example.Labs.Tests\App.config</span> file and copy its content in the <span class="text-bold">Console Application</span> configuration file.</p>
		<div class="box warning">
			<h3>Warning</h3>
			<div class="box-content">The <span class="text-bold">&lt;configSections&gt;</span> section must be the first node otherwise an exception is raised at runtime!</div>
		</div>
		<p class="action">Remove all <span class="text-bold">connectionStrings</span> sections (normally, 2) from the <span class="text-bold">Console Application</span> configuration file.</p>

		<p class="action">To set-up WCF support, create a <span class="text-bold">Config</span> folder in the <span class="text-bold">Console Application</span> project and create links (<span class="text-bold">Add &gt; Existing Items...</span>) to the following files</p>
		<ul>
			<li>Tests\Com.Example.Labs.Tests\Config\ServiceModel.Client.generated.config</li>
			<li>Tests\Com.Example.Labs.Tests\Config\ServiceModel.Client.custom.config</li>
		</ul>
		<img src="../ScreenShots/03-11.png" title="Illustration" alt="Illustration" />
		<p class="action">For each linked file, set <span class="text-bold">Copy to Output Directory = Copy always</span> in the properties.</p>
		<img src="../ScreenShots/03-12.png" title="Illustration" alt="Illustration" />
		<div class="box important">
			<h3>Before using WCF...</h3>
			<div class="box-content">
				<img src="../ScreenShots/03-13.png" title="Illustration" alt="Illustration" />
				<p class="text-red">It means the endpoint is not accessible. <span class="text-bold">The WebServices project</span> (that host the WCF services) must be running (using IIS or IIS Express). Do not forget this point!</p>
				<ul>
					<li>Execute cmd as administrator</li>
					<li>&nbsp;&gt; cd C:\Program Files\IIS Express</li>
					<li>&nbsp;&gt; iisexpress /path:"C:\DEV\Com.Example.Labs\Src\Com.Example.Labs.WebServices" /port:64666</li>
				</ul>
				<p>You can also use <span class="text-bold">Multiple startup projects</span> on the solution properties.</p>
				<p class="text-red text-bold">When modifying shared-code between Server and Clients (Core, Contracts, etc) do not forget to compile and run again the WebServices to reload updated assemblies into IIS/Cassini memory!</p>
			</div>
		</div>
		<p class="action">Remove the reference on the <span class="text-bold">Com.Examples.Labs.Services</span> assembly and the <span class="text-bold">using Com.Example.Labs.Services</span> namespace too.</p>
		<img src="../ScreenShots/03-14.png" title="Illustration" alt="Illustration" />
		<p class="action">Run again the Console Application.</p>
		<p>Now the application uses WCF (Com.Example.Labs.WebServices) and the code implementation (Services, Business and Crud) is only known at server-side.</p>
	</section>
</body>
</html>
