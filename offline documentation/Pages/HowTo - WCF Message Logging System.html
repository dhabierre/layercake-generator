<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
	<title>LCG - HowTo - WCF Message Logging System</title>
	<link rel="stylesheet" type="text/css" href="../Styles/Highlight.css">
	<link rel="stylesheet" type="text/css" href="../Styles/Styles.css">
</head>
<body>
	<h1>HowTo - WCF Message Logging System</h1>
	<section>
		<p>How to implement custom WCF Message Logging System.</p>
		<p class="action">Go to the <span class="text-bold">WebServices project</span> and open the <span class="text-bold">Wcf\Inspectors\WcfServiceTrackingInspector.cs</span> file.</p>
		<p class="action">Edit the <span class="text-bold">TraceOperation</span> method.</p>
		<pre class="hl"><span class="hl com">// WebServices | WcfServiceTrackingInspector.cs</span>

<span class="hl kwa">namespace</span> Com<span class="hl opt">.</span>Example<span class="hl opt">.</span>Labs<span class="hl opt">.</span><span class="text-red">WebServices</span>
<span class="hl opt">{</span>
    <span class="hl kwa">using</span> System<span class="hl opt">;</span>
    <span class="hl kwa">using</span> System<span class="hl opt">.</span>Collections<span class="hl opt">.</span>ObjectModel<span class="hl opt">;</span>
    <span class="hl kwa">using</span> System<span class="hl opt">.</span>ServiceModel<span class="hl opt">;</span>
    <span class="hl kwa">using</span> System<span class="hl opt">.</span>ServiceModel<span class="hl opt">.</span>Channels<span class="hl opt">;</span>
    <span class="hl kwa">using</span> System<span class="hl opt">.</span>ServiceModel<span class="hl opt">.</span>Description<span class="hl opt">;</span>
    <span class="hl kwa">using</span> System<span class="hl opt">.</span>ServiceModel<span class="hl opt">.</span>Dispatcher<span class="hl opt">;</span>

    <span class="hl kwa">using</span> Com<span class="hl opt">.</span>Example<span class="hl opt">.</span>Labs<span class="hl opt">.</span>Core<span class="hl opt">;</span>

    <span class="hl kwa">public class</span> WcfServiceTrackingInspector <span class="hl opt">:</span> IDispatchMessageInspector<span class="hl opt">,</span> IServiceBehavior
    <span class="hl opt">{</span>
        <span class="hl slc">// ...</span>

        <span class="hl kwa">public</span> <span class="hl kwb">object</span> <span class="hl kwd">AfterReceiveRequest</span><span class="hl opt">(</span><span class="hl kwa">ref</span> Message request<span class="hl opt">,</span> IClientChannel channel<span class="hl opt">,</span> InstanceContext instanceContext<span class="hl opt">)</span>
        <span class="hl opt">{</span>
            <span class="text-red">TraceOperation</span><span class="hl opt">(</span><span class="hl kwa">ref</span> request<span class="hl opt">,</span> channel<span class="hl opt">,</span> instanceContext<span class="hl opt">);</span>
            <span class="hl kwa">return null</span><span class="hl opt">;</span>
        <span class="hl opt">}</span>

        <span class="hl kwa">private static</span> <span class="hl kwb">void</span> <span class="text-red text-bold">TraceOperation</span><span class="hl opt">(</span><span class="hl kwa">ref</span> Message request<span class="hl opt">,</span> IClientChannel channel<span class="hl opt">,</span> InstanceContext instanceContext<span class="hl opt">)</span>
        <span class="hl opt">{</span>
            <span class="hl kwa">if</span> <span class="hl opt">(</span>_configSection<span class="hl opt">.</span>IsEnabled<span class="hl opt">)</span>
            <span class="hl opt">{</span>
                <span class="hl kwa">if</span> <span class="hl opt">(!</span>request<span class="hl opt">.</span>IsEmpty<span class="hl opt">)</span>
                <span class="hl opt">{</span>
                    <span class="hl kwa">if</span> <span class="hl opt">(</span>_loggerService <span class="hl opt">!=</span> <span class="hl kwa">null</span><span class="hl opt">)</span>
                    <span class="hl opt">{</span>
                        <span class="hl slc">// Enter your custom code in this block...</span>

                        <span class="hl kwb">string</span> to <span class="hl opt">=</span> OperationContext<span class="hl opt">.</span>Current<span class="hl opt">.</span>IncomingMessageHeaders<span class="hl opt">.</span>To<span class="hl opt">.</span><span class="hl kwd">ToString</span><span class="hl opt">();</span>
                        <span class="hl kwb">string</span> action <span class="hl opt">=</span> OperationContext<span class="hl opt">.</span>Current<span class="hl opt">.</span>IncomingMessageHeaders<span class="hl opt">.</span>Action<span class="hl opt">;</span>
                        <span class="hl kwb">string</span> operationName <span class="hl opt">=</span> action<span class="hl opt">.</span><span class="hl kwd">Substring</span><span class="hl opt">(</span>action<span class="hl opt">.</span><span class="hl kwd">LastIndexOf</span><span class="hl opt">(</span><span class="hl str">&quot;/&quot;</span><span class="hl opt">,</span> StringComparison<span class="hl opt">.</span>OrdinalIgnoreCase<span class="hl opt">) +</span> <span class="hl num">1</span><span class="hl opt">);</span>

                        <span class="hl kwb">string</span> logLine <span class="hl opt">=</span> <span class="hl kwb">string</span><span class="hl opt">.</span><span class="hl kwd">Format</span><span class="hl opt">(</span>
                            <span class="hl str">&quot;Request from {0} -&gt; {1} (operationName = {2})&quot;</span><span class="hl opt">,</span>
                            WcfHelper<span class="hl opt">.</span><span class="hl kwd">GetClientIpAddress</span><span class="hl opt">(),</span> to<span class="hl opt">,</span> operationName<span class="hl opt">);</span>

                        <span class="hl kwa">if</span> <span class="hl opt">(</span>_configSection<span class="hl opt">.</span>WithMessageLogging<span class="hl opt">)</span>
                        <span class="hl opt">{</span>
                            logLine <span class="hl opt">=</span> <span class="hl kwb">string</span><span class="hl opt">.</span><span class="hl kwd">Concat</span><span class="hl opt">(</span>
                                logLine<span class="hl opt">,</span> Environment<span class="hl opt">.</span>NewLine<span class="hl opt">,</span> WcfHelper<span class="hl opt">.</span><span class="hl kwd">MessageToString</span><span class="hl opt">(</span><span class="hl kwa">ref</span> request<span class="hl opt">));</span>
                        <span class="hl opt">}</span>

                        _loggerService<span class="hl opt">.</span><span class="hl kwd">WriteLine</span><span class="hl opt">(</span><span class="hl str">&quot;WcfServiceTracking&quot;</span><span class="hl opt">,</span> LogStatus<span class="hl opt">.</span>Info<span class="hl opt">,</span> logLine<span class="hl opt">);</span>
                    <span class="hl opt">}</span>
                <span class="hl opt">}</span>
            <span class="hl opt">}</span>
        <span class="hl opt">}</span>
    <span class="hl opt">}</span>
<span class="hl opt">}</span></pre>
	</section>
</body>
</html>
