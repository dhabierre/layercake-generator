<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
	<title>LCG - HowTo - Search Implementations</title>
	<link rel="stylesheet" type="text/css" href="../Styles/Highlight.css">
	<link rel="stylesheet" type="text/css" href="../Styles/Styles.css">
</head>
<body>
	<h1>HowTo - Search Implementations</h1>
	<section>
		<p>This HowTo explains how to used the generated search method and how to implement a custom one.</p>
        <p>Here the database schema used in these examples.</p>
        <img src="../ScreenShots/SearchImplementations-01.png" title="Illustration" alt="Illustration" />
        <img src="../ScreenShots/SearchImplementations-02.png" title="Illustration" alt="Illustration" />
        <img src="../ScreenShots/SearchImplementations-03.png" title="Illustration" alt="Illustration" />
        <img src="../ScreenShots/SearchImplementations-04.png" title="Illustration" alt="Illustration" />
	</section>
	<section>
        <h2>1. Generated Search Methods</h2>
        <p>LayerCake Generator generates Search methods that take a <span class="text-bold">SearchOptions</span> parameter.</p>
        <h3>1. 1. Standard Way</h3>
        <pre class="hl"><span class="hl kwa">using</span> <span class="hl opt">(</span><span class="hl kwa">var</span> service <span class="hl opt">=</span> <span class="hl kwa">new</span> ServiceProxy<span class="hl opt">&lt;</span>IProductService<span class="hl opt">&gt;())</span>
<span class="hl opt">{</span>
    SearchOptions options <span class="hl opt">=</span> <span class="hl kwa">new</span> <span class="hl kwd">SearchOptions</span><span class="hl opt">();</span>

    <span class="hl slc">// Retrieve the Products where IsAvailable == true...</span>
    options<span class="hl opt">.</span>Filters<span class="hl opt">.</span><span class="hl kwd">Add</span><span class="hl opt">(</span><span class="text-red text-bold">Product.ColumnNames.IsAvailable</span><span class="hl opt">,</span> <span class="text-red text-bold">FilterOperator.Equals</span><span class="hl opt">,</span> <span class="hl kwa">true</span><span class="hl opt">);</span>

    TCollection<span class="hl opt">&lt;</span>Product<span class="hl opt">&gt;</span> collection <span class="hl opt">=</span> service<span class="hl opt">.</span>Proxy<span class="hl opt">.</span><span class="hl kwd text-bold">Search</span><span class="hl opt">(</span>ClientContext<span class="hl opt">.</span>Anonymous<span class="hl opt">,</span> <span class="hl kwa">ref</span> options<span class="hl opt">);</span>
<span class="hl opt">}</span></pre>
        <h3>1. 2. With MaxRecords Option</h3>
        <pre class="hl"><span class="hl kwa">using</span> <span class="hl opt">(</span><span class="hl kwa">var</span> service <span class="hl opt">=</span> <span class="hl kwa">new</span> ServiceProxy<span class="hl opt">&lt;</span>IProductService<span class="hl opt">&gt;())</span>
<span class="hl opt">{</span>
    SearchOptions options <span class="hl opt">=</span> <span class="hl kwa">new</span> <span class="hl kwd">SearchOptions</span><span class="hl opt">();</span>

    <span class="hl slc">// Retrieve the Products where IsAvailable == true...</span>
    options<span class="hl opt">.</span>Filters<span class="hl opt">.</span><span class="hl kwd">Add</span><span class="hl opt">(</span>Product<span class="hl opt">.</span>ColumnNames<span class="hl opt">.</span>IsAvailable<span class="hl opt">,</span> FilterOperator<span class="hl opt">.</span>Equals<span class="hl opt">,</span> <span class="hl kwa">true</span><span class="hl opt">);</span>

    <span class="hl slc">// Retrieve 2 records max...</span>
    <span class="text-red text-bold">options.MaxRecords = 2;</span>

    TCollection<span class="hl opt">&lt;</span>Product<span class="hl opt">&gt;</span> collection <span class="hl opt">=</span> service<span class="hl opt">.</span>Proxy<span class="hl opt">.</span><span class="hl kwd text-bold">Search</span><span class="hl opt">(</span>ClientContext<span class="hl opt">.</span>Anonymous<span class="hl opt">,</span> <span class="hl kwa">ref</span> options<span class="hl opt">);</span>

    <span class="hl slc">// Here we are using MaxRecords limitation.</span>
    <span class="hl slc">// Thus collection.Count &lt;= options.PagingOptions.TotalRecords</span>

    Assert<span class="hl opt">.</span><span class="hl kwd">IsTrue</span><span class="hl opt">(</span>collection<span class="hl opt">.</span>Count <span class="hl opt">&lt;=</span> <span class="hl num">2</span><span class="hl opt">);</span>
<span class="hl opt">}</span></pre>
        <h3>1. 3. With Paging Options</h3>
        <pre class="hl"><span class="hl kwa">using</span> <span class="hl opt">(</span><span class="hl kwa">var</span> service <span class="hl opt">=</span> <span class="hl kwa">new</span> ServiceProxy<span class="hl opt">&lt;</span>IProductService<span class="hl opt">&gt;())</span>
<span class="hl opt">{</span>
    SearchOptions options <span class="hl opt">=</span> <span class="hl kwa">new</span> <span class="hl kwd">SearchOptions</span><span class="hl opt">();</span>

    <span class="hl slc">// Retrieve the Products where IsAvailable == true...</span>
    options<span class="hl opt">.</span>Filters<span class="hl opt">.</span><span class="hl kwd">Add</span><span class="hl opt">(</span>Product<span class="hl opt">.</span>ColumnNames<span class="hl opt">.</span>IsAvailable<span class="hl opt">,</span> FilterOperator<span class="hl opt">.</span>Equals<span class="hl opt">,</span> <span class="hl kwa">true</span><span class="hl opt">);</span>

    <span class="hl slc">// Retrieve the first page with 5 items max...</span>

    <span class="text-red text-bold">options.WithPaging = true;</span> <span class="hl slc">// default value is false.</span>
    <span class="text-red text-bold">options.PagingOptions.CurrentPage = 1;
    options.PagingOptions.RecordsPerPage = 5;</span>

    TCollection<span class="hl opt">&lt;</span>Product<span class="hl opt">&gt;</span> collection <span class="hl opt">=</span> service<span class="hl opt">.</span>Proxy<span class="hl opt">.</span><span class="hl kwd text-bold">Search</span><span class="hl opt">(</span>ClientContext<span class="hl opt">.</span>Anonymous<span class="hl opt">,</span> <span class="hl kwa">ref</span> options<span class="hl opt">);</span>

    <span class="hl slc">// Here we are using WithPaging option.</span>
    <span class="hl slc">// Thus collection.Count &lt;= options.PagingOptions.TotalRecords</span>

    Assert<span class="hl opt">.</span><span class="hl kwd">IsTrue</span><span class="hl opt">(</span>collection<span class="hl opt">.</span>Count <span class="hl opt">&lt;=</span> <span class="hl num">5</span><span class="hl opt">);</span>
    Assert<span class="hl opt">.</span><span class="hl kwd">IsTrue</span><span class="hl opt">(</span>collection<span class="hl opt">.</span>Count <span class="hl opt">&lt;=</span> options<span class="hl opt">.</span>PagingOptions<span class="hl opt">.</span>TotalRecords<span class="hl opt">);</span>
<span class="hl opt">}</span></pre>
        <h3>1. 4. Full-Text Search</h3>
        <p>Full-text search allows fast and flexible indexing for keyword-based query of text data stored in a Microsoft SQL Server database. In contrast to the LIKE predicate, which only works on character patterns, full-text queries perform linguistic searches against this data, by operating on words and phrases based on rules of a particular language. To know more about this feature report to the MSDN.</p>
        <pre class="hl">﻿<span class="hl kwa">using</span> <span class="hl opt">(</span><span class="hl kwa">var</span> service <span class="hl opt">=</span> <span class="hl kwa">new</span> ServiceProxy<span class="hl opt">&lt;</span>IProductService<span class="hl opt">&gt;())</span>
<span class="hl opt">{</span>
    SearchOptions options <span class="hl opt">=</span> <span class="hl kwa">new</span> <span class="hl kwd">SearchOptions</span><span class="hl opt">();</span>
    options<span class="hl opt">.</span>Filters<span class="hl opt">.</span><span class="hl kwd">Add</span><span class="hl opt">(</span><span class="text-red text-bold">Product.ColumnNames.Name</span><span class="hl opt">,</span> <span class="text-red text-bold">FilterOperator.Contains</span><span class="hl opt">,</span> <span class="hl str">&quot;htc&quot;</span><span class="hl opt">);</span>

    TCollection<span class="hl opt">&lt;</span>Product<span class="hl opt">&gt;</span> collection <span class="hl opt">=</span> service<span class="hl opt">.</span>Proxy<span class="hl opt">.</span><span class="hl kwd">Search</span><span class="hl opt">(</span>ClientContext<span class="hl opt">.</span>Anonymous<span class="hl opt">,</span> <span class="hl kwa">ref</span> options<span class="hl opt">);</span>

    options <span class="hl opt">=</span> <span class="hl kwa">new</span> <span class="hl kwd">SearchOptions</span><span class="hl opt">();</span>
    options<span class="hl opt">.</span>Filters<span class="hl opt">.</span><span class="hl kwd">Add</span><span class="hl opt">(</span>Product<span class="hl opt">.</span>ColumnNames<span class="hl opt">.</span>Name<span class="hl opt">,</span> FilterOperator<span class="hl opt">.</span>Contains<span class="hl opt">,</span> <span class="hl str">&quot;htc 8x&quot;</span><span class="hl opt">);</span> <span class="hl slc">// transform to &quot;htc AND 8x&quot;</span>

    collection <span class="hl opt">=</span> service<span class="hl opt">.</span>Proxy<span class="hl opt">.</span><span class="hl kwd">Search</span><span class="hl opt">(</span>ClientContext<span class="hl opt">.</span>Anonymous<span class="hl opt">,</span> <span class="hl kwa">ref</span> options<span class="hl opt">);</span>

    options <span class="hl opt">=</span> <span class="hl kwa">new</span> <span class="hl kwd">SearchOptions</span><span class="hl opt">();</span>
    options<span class="hl opt">.</span>Filters<span class="hl opt">.</span><span class="hl kwd">Add</span><span class="hl opt">(</span>Product<span class="hl opt">.</span>ColumnNames<span class="hl opt">.</span>Name<span class="hl opt">,</span> FilterOperator<span class="hl opt">.</span>Contains<span class="hl opt">,</span> <span class="hl str">&quot;htc AND 8x&quot;</span><span class="hl opt">);</span>

    collection <span class="hl opt">=</span> service<span class="hl opt">.</span>Proxy<span class="hl opt">.</span><span class="hl kwd">Search</span><span class="hl opt">(</span>ClientContext<span class="hl opt">.</span>Anonymous<span class="hl opt">,</span> <span class="hl kwa">ref</span> options<span class="hl opt">);</span>

    options <span class="hl opt">=</span> <span class="hl kwa">new</span> <span class="hl kwd">SearchOptions</span><span class="hl opt">();</span>
    options<span class="hl opt">.</span>Filters<span class="hl opt">.</span><span class="hl kwd">Add</span><span class="hl opt">(</span>Product<span class="hl opt">.</span>ColumnNames<span class="hl opt">.</span>Name<span class="hl opt">,</span> FilterOperator<span class="hl opt">.</span>Contains<span class="hl opt">,</span> <span class="hl str">&quot;htc OR nokia&quot;</span><span class="hl opt">);</span>

    collection <span class="hl opt">=</span> service<span class="hl opt">.</span>Proxy<span class="hl opt">.</span><span class="hl kwd">Search</span><span class="hl opt">(</span>ClientContext<span class="hl opt">.</span>Anonymous<span class="hl opt">,</span> <span class="hl kwa">ref</span> options<span class="hl opt">);</span>

    options <span class="hl opt">=</span> <span class="hl kwa">new</span> <span class="hl kwd">SearchOptions</span><span class="hl opt">();</span>
    options<span class="hl opt">.</span>Filters<span class="hl opt">.</span><span class="hl kwd">Add</span><span class="hl opt">(</span><span class="text-red text-bold">&quot;*&quot;</span> <span class="hl com">/* == (Product_Name, Product_Description) */</span><span class="hl opt">,</span> FilterOperator<span class="hl opt">.</span>Contains<span class="hl opt">,</span> <span class="hl str">&quot;(windows AND phone) OR wp&quot;</span><span class="hl opt">);</span>

    collection <span class="hl opt">=</span> service<span class="hl opt">.</span>Proxy<span class="hl opt">.</span><span class="hl kwd">Search</span><span class="hl opt">(</span>ClientContext<span class="hl opt">.</span>Anonymous<span class="hl opt">,</span> <span class="hl kwa">ref</span> options<span class="hl opt">);</span>
<span class="hl opt">}</span></pre>
	</section>
	<section>
        <h2>2. Global Search Method</h2>
        <p>The GlobalSearch method executes the search operation (1 keyword) on all the tables of the database (with paging).</p>
        <pre class="hl"><span class="hl slc">// GlobalSearch excludes the following tables:</span>
<span class="hl slc">// AppSettings, ExecutionTrace, ProcessErrorLog, ProcessLog, Role, Translation, User, UserRole</span>

<span class="hl kwa">using</span> <span class="hl opt">(</span><span class="hl kwa">var</span> service <span class="hl opt">=</span> <span class="hl kwa">new</span> ServiceProxy<span class="hl opt">&lt;</span>ICommonService<span class="hl opt">&gt;())</span>
<span class="hl opt">{</span>
    <span class="hl slc">// 1° page with 10 first records.</span>
    PagingOptions paging <span class="hl opt">=</span> <span class="hl kwa">new</span> PagingOptions <span class="hl opt">{</span> CurrentPage <span class="hl opt">=</span> <span class="hl num">1</span><span class="hl opt">,</span> RecordsPerPage <span class="hl opt">=</span> <span class="hl num">10</span> <span class="hl opt">};</span>

    IList<span class="hl opt">&lt;</span>GlobalSearchResultItem<span class="hl opt">&gt;</span> results <span class="hl opt">=</span> service<span class="hl opt">.</span>Proxy<span class="hl opt">.</span><span class="hl kwd">GlobalSearch</span><span class="hl opt">(</span>ClientContext<span class="hl opt">.</span>Anonymous<span class="hl opt">,</span> <span class="hl str">&quot;Bike&quot;</span><span class="hl opt">,</span> <span class="hl kwa">ref</span> paging<span class="hl opt">);</span>

    <span class="hl kwa">if</span> <span class="hl opt">(</span>paging<span class="hl opt">.</span>TotalRecords <span class="hl opt">&gt;</span> <span class="hl num">10</span><span class="hl opt">)</span>
    <span class="hl opt">{</span>
        <span class="hl slc">// 2° page with 10 next records.</span>
        paging<span class="hl opt">.</span>CurrentPage <span class="hl opt">=</span> <span class="hl num">2</span><span class="hl opt">;</span>

        <span class="hl slc">// Executes the search operation on all the database tables...</span>
        results <span class="hl opt">=</span> service<span class="hl opt">.</span>Proxy<span class="hl opt">.</span><span class="hl kwd">GlobalSearch</span><span class="hl opt">(</span>ClientContext<span class="hl opt">.</span>Anonymous<span class="hl opt">,</span> <span class="hl str">&quot;Bike&quot;</span><span class="hl opt">,</span> <span class="hl kwa">ref</span> paging<span class="hl opt">);</span>
    <span class="hl opt">}</span>

    <span class="hl slc">// Executes the search operation on given tables...</span>
    <span class="hl slc">//results = service.Proxy.GlobalSearch(ClientContext.Anonymous, &quot;Bike&quot;, paging, new List&lt;string&gt; { &quot;Product&quot;, ... });</span>
<span class="hl opt">}</span></pre>
        <p>GlobalSearchResultItem = { TableName, ColumnName, Id, Value }</p>
	</section>
	<section>
        <h2>3. Custom Implementation With Paging Support</h2>
        <p>Suppose we want to write a method that retrieves Product records with Manufacturers and Sellers associations given several criterias.</p>
        <p>We could write the following Business method.</p>
        <pre class="hl"><span class="hl com">// Business | ProductBusiness.custom.cs</span>

<span class="hl opt">[</span><span class="hl kwd">BusinessMethod</span><span class="hl opt">]</span>
<span class="hl kwa">public</span> TCollection<span class="hl opt">&lt;</span>Product<span class="hl opt">&gt;</span> <span class="hl kwd">SearchByCriterias</span><span class="hl opt">(</span>
    IUserContext userContext<span class="hl opt">,</span>
    <span class="hl kwb">string</span> searchText<span class="hl opt">,</span>
    <span class="hl kwb">long</span>? idSeller<span class="hl opt">,</span>
    <span class="hl kwb">long</span>? IdManufacturer<span class="hl opt">,</span>
    <span class="hl kwb">string</span> sellerName<span class="hl opt">,</span>
    <span class="hl kwb">string</span> manufacturerName<span class="hl opt">,</span>
    <span class="hl kwb">bool</span>? isAvailable<span class="hl opt">,</span>
    <span class="hl kwb">double</span>? minPrice<span class="hl opt">,</span>
    <span class="hl kwb">double</span>? maxPrice<span class="hl opt">)</span>
<span class="hl opt">{</span>
    <span class="hl slc">// ...</span>
<span class="hl opt">}</span></pre>
        <p>But this design is quite bad. Too many parameters.</p>
        <p>The best practice is to create a criteria class and to inherit the <span class="text-bold">SearchCriterias</span> class.</p>
        <pre class="hl">﻿<span class="hl slc">// Models | Com.Example.Labs.Models\Models\SearchCriterias\ProductSearchCriterias.cs</span>
        
<span class="hl kwa">namespace</span> Com<span class="hl opt">.</span>Example<span class="hl opt">.</span>Labs<span class="hl opt">.</span><span class="text-red">Models</span>
<span class="hl opt">{</span>
    <span class="hl kwa">using</span> System<span class="hl opt">;</span>
    <span class="hl kwa">using</span> System<span class="hl opt">.</span>Collections<span class="hl opt">.</span>Generic<span class="hl opt">;</span>
    <span class="hl kwa">using</span> System<span class="hl opt">.</span>ComponentModel<span class="hl opt">;</span>
    <span class="hl kwa">using</span> System<span class="hl opt">.</span>Runtime<span class="hl opt">.</span>Serialization<span class="hl opt">;</span>
	
    <span class="hl kwa">using</span> Com<span class="hl opt">.</span>Example<span class="hl opt">.</span>Labs<span class="hl opt">.</span>Core<span class="hl opt">;</span>

    <span class="hl opt">[</span><span class="hl kwd">Serializable</span><span class="hl opt">]</span>
    <span class="hl opt">[</span><span class="hl kwd">DataContract</span><span class="hl opt">(</span>Namespace <span class="hl opt">=</span> Globals<span class="hl opt">.</span>Namespace<span class="hl opt">,</span> IsReference <span class="hl opt">= true)]</span>
    <span class="hl kwa">public class</span> <span class="text-bold">ProductSearchCriterias</span> <span class="hl opt">:</span> <span class="text-red text-bold">SearchCriterias</span>
    <span class="hl opt">{</span>
        <span class="hl opt">[</span><span class="hl kwd">DataMember</span><span class="hl opt">]</span>
        <span class="text-red text-bold">[CriteriaMember(&quot;&#64;SearchText&quot;, isFullTextSearch: true ﻿<span class="hl slc">/* automatically formatted */</span>)]</span>
        <span class="hl kwa">public</span> <span class="hl kwb">string</span> SearchText ﻿<span class="hl slc">// Product_Name, Product_Description</span>
        <span class="hl opt">{</span>
            <span class="hl kwa">get</span><span class="hl opt">;</span>
            <span class="hl kwa">set</span><span class="hl opt">;</span>
        <span class="hl opt">}</span>

        <span class="hl opt">[</span><span class="hl kwd">DataMember</span><span class="hl opt">]</span>
        <span class="text-red text-bold">[CriteriaMember(&quot;&#64;IdSeller&quot;)]</span>
        <span class="hl kwa">public</span> <span class="hl kwb">long</span><span class="hl opt">?</span> IdSeller
        <span class="hl opt">{</span>
            <span class="hl kwa">get</span><span class="hl opt">;</span>
            <span class="hl kwa">set</span><span class="hl opt">;</span>
        <span class="hl opt">}</span>

        <span class="hl opt">[</span><span class="hl kwd">DataMember</span><span class="hl opt">]</span>
        <span class="text-red text-bold">[CriteriaMember(&quot;&#64;IdManufacturer&quot;)]</span>
        <span class="hl kwa">public</span> <span class="hl kwb">long</span><span class="hl opt">?</span> IdManufacturer
        <span class="hl opt">{</span>
            <span class="hl kwa">get</span><span class="hl opt">;</span>
            <span class="hl kwa">set</span><span class="hl opt">;</span>
        <span class="hl opt">}</span>

        <span class="hl opt">[</span><span class="hl kwd">DataMember</span><span class="hl opt">]</span>
        <span class="text-red text-bold">[CriteriaMember(&quot;&#64;SellerName&quot;)]</span>
        <span class="hl kwa">public</span> <span class="hl kwb">string</span> SellerName
        <span class="hl opt">{</span>
            <span class="hl kwa">get</span><span class="hl opt">;</span>
            <span class="hl kwa">set</span><span class="hl opt">;</span>
        <span class="hl opt">}</span>

        <span class="hl opt">[</span><span class="hl kwd">DataMember</span><span class="hl opt">]</span>
        <span class="text-red text-bold">[CriteriaMember(&quot;&#64;ManufacturerName&quot;)]</span>
        <span class="hl kwa">public</span> <span class="hl kwb">string</span> ManufacturerName
        <span class="hl opt">{</span>
            <span class="hl kwa">get</span><span class="hl opt">;</span>
            <span class="hl kwa">set</span><span class="hl opt">;</span>
        <span class="hl opt">}</span>

        <span class="hl opt">[</span><span class="hl kwd">DataMember</span><span class="hl opt">]</span>
        <span class="text-red text-bold">[CriteriaMember(&quot;&#64;IsAvailable&quot;)]</span>
        <span class="hl kwa">public</span> <span class="hl kwb">bool</span><span class="hl opt">?</span> IsAvailable
        <span class="hl opt">{</span>
            <span class="hl kwa">get</span><span class="hl opt">;</span>
            <span class="hl kwa">set</span><span class="hl opt">;</span>
        <span class="hl opt">}</span>

        <span class="hl opt">[</span><span class="hl kwd">DataMember</span><span class="hl opt">]</span>
        <span class="text-red text-bold">[CriteriaMember(&quot;&#64;MinPrice&quot;)]</span>
        <span class="hl kwa">public</span> <span class="hl kwb">double</span><span class="hl opt">?</span> MinPrice
        <span class="hl opt">{</span>
            <span class="hl kwa">get</span><span class="hl opt">;</span>
            <span class="hl kwa">set</span><span class="hl opt">;</span>
        <span class="hl opt">}</span>

        <span class="hl opt">[</span><span class="hl kwd">DataMember</span><span class="hl opt">]</span>
        <span class="text-red text-bold">[CriteriaMember(&quot;&#64;MaxPrice&quot;)]</span>
        <span class="hl kwa">public</span> <span class="hl kwb">double</span><span class="hl opt">?</span> MaxPrice
        <span class="hl opt">{</span>
            <span class="hl kwa">get</span><span class="hl opt">;</span>
            <span class="hl kwa">set</span><span class="hl opt">;</span>
        <span class="hl opt">}</span>
    <span class="hl opt">}</span>
<span class="hl opt">}</span></pre>
        <p>To set a default value on a property use the <span class="text-bold">DefaultValue</span> attribute (or in the constructor).</p>
        <pre class="hl"><span class="hl opt">[</span><span class="hl kwd">DataMember</span><span class="hl opt">]</span>
<span class="hl opt">[</span><span class="hl kwd">CriteriaMember</span><span class="hl opt">(</span><span class="hl str">&quot;&#64;IsAvailable&quot;</span><span class="hl opt">)]</span>
<span class="text-red text-bold">[DefaultValue(true)]</span>
<span class="hl kwa">public</span> <span class="hl kwb">bool</span><span class="hl opt">?</span> IsAvailable
<span class="hl opt">{</span>
    <span class="hl kwa">get</span><span class="hl opt">;</span>
    <span class="hl kwa">set</span><span class="hl opt">;</span>
<span class="hl opt">}</span></pre>
        <p>Then the Business method can be simplified like this.</p>
        <pre class="hl">﻿<span class="hl slc">// Business | ProductBusiness.custom.cs</span>

<span class="hl opt">[</span><span class="hl kwd">BusinessMethod</span><span class="hl opt">]</span>
<span class="hl kwa">public</span> TCollection<span class="hl opt">&lt;</span>Product<span class="hl opt">&gt;</span> <span class="hl kwd">SearchByCriterias</span><span class="hl opt">(</span>IUserContext userContext<span class="hl opt">,</span> <span class="hl kwa">ref</span> <span class="text-red text-bold">ProductSearchCriterias criterias</span><span class="hl opt">)</span>
<span class="hl opt">{</span>
    <span class="hl kwa">using</span> <span class="hl opt">(</span><span class="hl kwa">var</span> et <span class="hl opt">=</span> <span class="hl kwa">new</span> <span class="hl kwd">ExecutionTracerService</span><span class="hl opt">())</span>
    <span class="hl kwa">using</span> <span class="hl opt">(</span><span class="hl kwa">var</span> db <span class="hl opt">=</span> <span class="hl kwa">new</span> <span class="hl kwd">ProductCrud</span><span class="hl opt">(</span>userContext<span class="hl opt">))</span>
    <span class="hl opt">{</span>
        <span class="hl kwa">return</span> db<span class="hl opt">.</span><span class="hl kwd">SearchByCriterias</span><span class="hl opt">(</span>criterias<span class="hl opt">);</span>
    <span class="hl opt">}</span>
<span class="hl opt">}</span></pre>
        <p>CRUD method.</p>
        <pre class="hl">﻿<span class="hl com">// Crud | ProductCrud.custom.cs</span>
        
<span class="hl kwa">namespace</span> Com<span class="hl opt">.</span>Example<span class="hl opt">.</span>Labs<span class="hl opt">.</span><span class="text-red">Crud</span>
<span class="hl opt">{</span>
    <span class="hl kwa">using</span> System<span class="hl opt">;</span>
    <span class="hl kwa">using</span> System<span class="hl opt">.</span>Collections<span class="hl opt">.</span>Generic<span class="hl opt">;</span>
    <span class="hl kwa">using</span> System<span class="hl opt">.</span>Data<span class="hl opt">;</span>
    <span class="hl kwa">using</span> System<span class="hl opt">.</span>Data<span class="hl opt">.</span>Common<span class="hl opt">;</span>
    <span class="hl kwa">using</span> System<span class="hl opt">.</span>Linq<span class="hl opt">;</span>
    <span class="hl kwa">using</span> System<span class="hl opt">.</span>Transactions<span class="hl opt">;</span>
    
    <span class="hl kwa">using</span> Com<span class="hl opt">.</span>Example<span class="hl opt">.</span>Labs<span class="hl opt">.</span>Models<span class="hl opt">;</span>

    <span class="hl kwa">public partial class</span> <span class="text-bold">ProductCrud</span>
    <span class="hl opt">{</span>
        <span class="hl kwa">public</span> TCollection<span class="hl opt">&lt;</span>Product<span class="hl opt">&gt;</span> <span class="hl kwd">SearchByCriterias</span><span class="hl opt">(</span><span class="text-red text-bold">ProductSearchCriterias criterias</span><span class="hl opt">)</span>
        <span class="hl opt">{</span>
            TCollection<span class="hl opt">&lt;</span>Product<span class="hl opt">&gt;</span> collection <span class="hl opt">=</span> <span class="hl kwa">null</span><span class="hl opt">;</span>

            <span class="hl kwa">using</span> <span class="hl opt">(</span><span class="hl kwa">var</span> et <span class="hl opt">=</span> <span class="hl kwa">new</span> <span class="hl kwd">ExecutionTracerService</span><span class="hl opt">())</span>
            <span class="hl opt">{</span>
                DbConnection dbConnection<span class="hl opt">;</span>

                <span class="hl kwa">using</span> <span class="hl opt">(</span><span class="hl kwa">var</span> dbReader <span class="hl opt">=</span> <span class="hl kwa">base</span><span class="hl opt">.</span><span class="hl kwd">ToDataReader</span><span class="hl opt">(</span>
                    <span class="hl str">&quot;Product_Custom_SearchWithCriterias&quot;</span><span class="hl opt">,</span> <span class="text-red text-bold">criterias.ToParameters()</span><span class="hl opt">,</span> out dbConnection<span class="hl opt">))</span>
                <span class="hl opt">{</span>
                    collection <span class="hl opt">=</span> <span class="hl kwa">this</span><span class="hl opt">.</span><span class="hl kwd">DeepMap</span><span class="hl opt">(</span>dbReader<span class="hl opt">)</span> as TCollection<span class="hl opt">&lt;</span>Models<span class="hl opt">.</span>Product<span class="hl opt">&gt;;</span>

                    dbReader<span class="hl opt">.</span><span class="hl kwd">NextResult</span><span class="hl opt">();</span>
                    dbReader<span class="hl opt">.</span><span class="hl kwd">Read</span><span class="hl opt">();</span>

                    criterias<span class="hl opt">.</span>PagingOptions<span class="hl opt">.</span>TotalRecords <span class="hl opt">=</span> Convert<span class="hl opt">.</span><span class="hl kwd">ToInt32</span><span class="hl opt">(</span>dbReader<span class="hl opt">[</span><span class="hl num">0</span><span class="hl opt">]);</span>
                <span class="hl opt">}</span>

                <span class="hl kwa">if</span> <span class="hl opt">(</span>dbConnection <span class="hl opt">!=</span> <span class="hl kwa">null</span><span class="hl opt">)</span>
                    dbConnection<span class="hl opt">.</span><span class="hl kwd">Close</span><span class="hl opt">();</span>
            <span class="hl opt">}</span>

            <span class="hl kwa">return</span> collection<span class="hl opt">;</span>
        <span class="hl opt">}</span>
    <span class="hl opt">}</span>
<span class="hl opt">}</span></pre>
        <p>The custom stored procedure.</p>
        <pre class="hl"><span class="hl kwa">CREATE PROCEDURE</span> <span class="hl opt">[</span>dbo<span class="hl opt">]</span>.<span class="hl opt">[</span>Product_Custom_SearchWithCriterias<span class="hl opt">]</span>
<span class="hl opt">(</span>
    <span class="hl slc">-- Filters parameters</span>
	
    &#64;SearchText <span class="hl kwb">VARCHAR</span><span class="hl opt">(</span><span class="hl num">128</span><span class="hl opt">) =</span> <span class="hl kwa">NULL</span><span class="hl opt">,</span>
    &#64;IdSeller <span class="hl kwb">BIGINT</span> <span class="hl opt">=</span> <span class="hl kwa">NULL</span><span class="hl opt">,</span>
    &#64;IdManufacturer <span class="hl kwb">BIGINT</span> <span class="hl opt">=</span> <span class="hl kwa">NULL</span><span class="hl opt">,</span>
    &#64;SellerName <span class="hl kwb">VARCHAR</span><span class="hl opt">(</span><span class="hl num">64</span><span class="hl opt">) =</span> <span class="hl kwa">NULL</span><span class="hl opt">,</span>
    &#64;ManufacturerName <span class="hl kwb">VARCHAR</span><span class="hl opt">(</span><span class="hl num">64</span><span class="hl opt">) =</span> <span class="hl kwa">NULL</span><span class="hl opt">,</span>
    &#64;IsAvailable <span class="hl kwa">BIT</span> <span class="hl opt">=</span> <span class="hl kwa">NULL</span><span class="hl opt">,</span>
    &#64;MinPrice <span class="hl kwb">FLOAT</span> <span class="hl opt">=</span> <span class="hl kwa">NULL</span><span class="hl opt">,</span>
    &#64;MaxPrice <span class="hl kwb">FLOAT</span> <span class="hl opt">=</span> <span class="hl kwa">NULL</span><span class="hl opt">,</span>

    <span class="hl slc">-- Pagination parameters</span>
    
    &#64;PagingCurrentPage <span class="hl kwb">INT</span> <span class="hl opt">=</span> <span class="hl num">1</span><span class="hl opt">,</span>
    &#64;PagingRecordsPerPage <span class="hl kwb">INT</span> <span class="hl opt">=</span> <span class="hl num">50</span><span class="hl opt">,</span>

    <span class="hl slc">-- Context parameters (not used here)</span>
    
    &#64;CtxUser <span class="hl kwb">BIGINT</span><span class="hl opt"> =</span> <span class="hl kwa">NULL</span><span class="hl opt">,</span>
    &#64;CtxCulture <span class="hl kwb">VARCHAR</span><span class="hl opt">(</span><span class="hl num">2</span><span class="hl opt">) =</span> <span class="hl str">N'EN'</span><span class="hl opt">,</span>
    &#64;CtxWithContextSecurity <span class="hl kwa">BIT</span> <span class="hl opt">=</span> <span class="hl str">N'True'</span>
<span class="hl opt">)</span>
<span class="hl kwa">WITH RECOMPILE</span>
<span class="hl kwa">AS</span>
<span class="hl kwa">BEGIN</span>
    <span class="hl kwa">SET NOCOUNT ON</span>
    
    <span class="hl kwa">DECLARE</span>
        &#64;Statement_Data <span class="hl kwd">NVARCHAR</span><span class="hl opt">(</span><span class="hl kwa">MAX</span><span class="hl opt">),</span>
        &#64;Parameters_Data <span class="hl kwd">NVARCHAR</span><span class="hl opt">(</span><span class="hl kwa">MAX</span><span class="hl opt">);</span>
    
    <span class="hl kwa">DECLARE</span>
        &#64;Statement_TotalRecords <span class="hl kwd">NVARCHAR</span><span class="hl opt">(</span><span class="hl kwa">MAX</span><span class="hl opt">),</span>
        &#64;Parameters_TotalRecords <span class="hl kwd">NVARCHAR</span><span class="hl opt">(</span><span class="hl kwa">MAX</span><span class="hl opt">);</span>

    <span class="hl kwa">IF</span> &#64;PagingCurrentPage <span class="hl kwa">IS NULL OR</span> &#64;PagingCurrentPage <span class="hl opt">&lt;</span> <span class="hl num">1</span> <span class="hl kwa">SET</span> &#64;PagingCurrentPage <span class="hl opt">=</span> <span class="hl num">1</span><span class="hl opt">;</span>
    <span class="hl kwa">IF</span> &#64;PagingRecordsPerPage <span class="hl kwa">IS NULL OR</span> &#64;PagingRecordsPerPage <span class="hl opt">&lt;</span> <span class="hl num">1</span> <span class="hl kwa">SET</span> &#64;PagingRecordsPerPage <span class="hl opt">=</span> <span class="hl num">50</span><span class="hl opt">;</span>

    <span class="hl kwa">DECLARE</span> &#64;v_LastRow <span class="hl kwb">INT</span> <span class="hl opt">=</span> &#64;PagingCurrentPage <span class="hl opt">*</span> &#64;PagingRecordsPerPage<span class="hl opt">;</span>
    <span class="hl kwa">DECLARE</span> &#64;v_FirstRow <span class="hl kwb">INT</span> <span class="hl opt">=</span> &#64;v_LastRow <span class="hl opt">-</span> &#64;PagingRecordsPerPage <span class="hl opt">+</span> <span class="hl num">1</span><span class="hl opt">;</span>
    
    <span class="hl kwa">BEGIN TRY</span>

        <span class="hl slc">-- SELECT section...</span>
        
        <span class="hl kwa">SET</span> &#64;Statement_Data <span class="hl opt">=</span>
            <span class="hl str">N' [Product].*,'</span>
          <span class="hl opt">+</span> <span class="hl str">N' [Seller].*,'</span>
          <span class="hl opt">+</span> <span class="hl str">N' [Manufacturer].*'</span>
          
        <span class="hl kwa">SET</span> &#64;Statement_TotalRecords <span class="hl opt">=</span>
            <span class="hl str">N' SELECT COUNT(0) AS TotalRecords'</span>
        
        <span class="hl slc">-- FROM section...</span>
        
        <span class="hl kwa">DECLARE</span> &#64;v_From <span class="hl kwb">VARCHAR</span><span class="hl opt">(</span><span class="hl kwa">MAX</span><span class="hl opt">) =</span> 
            <span class="hl str">N' FROM'</span>
          <span class="hl opt">+</span> <span class="hl str">N' [Product] WITH(NOLOCK)'</span>
          <span class="hl opt">+</span> <span class="hl str">N'  LEFT JOIN [Seller] WITH(NOLOCK) ON [Seller].[Seller_Id] = [Product].[Product_IdSeller]'</span>
          <span class="hl opt">+</span> <span class="hl str">N' INNER JOIN [Manufacturer] WITH(NOLOCK) ON [Manufacturer].[Manufacturer_Id] = [Product].[Product_IdManufacturer]'</span>

        <span class="hl kwa">SET</span> &#64;Statement_Data <span class="hl opt">+=</span> &#64;v_From
        <span class="hl kwa">SET</span> &#64;Statement_TotalRecords <span class="hl opt">+=</span> &#64;v_From
        
        <span class="hl slc">-- WHERE section...</span>

        <span class="hl kwa">DECLARE</span> &#64;v_Where <span class="hl kwb">VARCHAR</span><span class="hl opt">(</span><span class="hl kwa">MAX</span><span class="hl opt">) =</span> 
            <span class="hl str">N' WHERE'</span>
          <span class="hl opt">+</span> <span class="hl str">N' 1 = 1'</span>

        <span class="hl kwa">IF</span> &#64;SearchText <span class="hl kwa">IS NOT NULL</span>
        <span class="hl kwa">BEGIN</span>
            <span class="text-red">-- Full-Text Search filter</span>
            <span class="hl kwa">SET</span> &#64;v_Where <span class="hl opt">+=</span> <span class="hl str">N' AND CONTAINS(([Product].[Product_Name], [Product].[Product_Description]), &#64;SearchText)'</span>
        <span class="hl kwa">END</span>

        <span class="hl kwa">IF</span> &#64;IdSeller <span class="hl kwa">IS NOT NULL</span>
        <span class="hl kwa">BEGIN</span>
            <span class="hl kwa">SET</span> &#64;v_Where <span class="hl opt">+=</span> <span class="hl str">N' AND [Product].[Product_IdSeller] = &#64;IdSeller'</span>
        <span class="hl kwa">END</span>

        <span class="hl kwa">IF</span> &#64;IdManufacturer <span class="hl kwa">IS NOT NULL</span>
        <span class="hl kwa">BEGIN</span>
            <span class="hl kwa">SET</span> &#64;v_Where <span class="hl opt">+=</span> <span class="hl str">N' AND [Product].[Product_IdManufacturer] = &#64;IdManufacturer'</span>
        <span class="hl kwa">END</span>

        <span class="hl kwa">IF</span> &#64;SellerName <span class="hl kwa">IS NOT NULL</span>
        <span class="hl kwa">BEGIN</span>
            <span class="hl kwa">SET</span> &#64;v_Where <span class="hl opt">+=</span> <span class="hl str">N' AND [Seller].[Seller_Name] = &#64;SellerName'</span>
        <span class="hl kwa">END</span>

        <span class="hl kwa">IF</span> &#64;ManufacturerName <span class="hl kwa">IS NOT NULL</span>
        <span class="hl kwa">BEGIN</span>
            <span class="hl kwa">SET</span> &#64;v_Where <span class="hl opt">+=</span> <span class="hl str">N' AND [Manufacturer].[Manufacturer_Name] = &#64;ManufacturerName'</span>
        <span class="hl kwa">END</span>

        <span class="hl kwa">IF</span> &#64;IsAvailable <span class="hl kwa">IS NOT NULL</span>
        <span class="hl kwa">BEGIN</span>
            <span class="hl kwa">SET</span> &#64;v_Where <span class="hl opt">+=</span> <span class="hl str">N' AND [Product].[Product_IsAvailable] = &#64;IsAvailable'</span>
        <span class="hl kwa">END</span>
        
        <span class="hl kwa">IF</span> &#64;MinPrice <span class="hl kwa">IS NOT NULL OR</span> &#64;MaxPrice <span class="hl kwa">IS NOT NULL</span>
        <span class="hl kwa">BEGIN</span>
            <span class="hl kwa">IF</span> &#64;MinPrice <span class="hl kwa">IS NOT NULL AND</span> &#64;MaxPrice <span class="hl kwa">IS NOT NULL</span>
            <span class="hl kwa">BEGIN</span>
                <span class="hl kwa">SET</span> &#64;v_Where <span class="hl opt">+=</span> <span class="hl str">N' AND [Product].[Product_Price] &gt;= &#64;MinPrice AND [Product].[Product_Price] &lt;= &#64;MaxPrice'</span>
            <span class="hl kwa">END</span>
            <span class="hl kwa">ELSE IF</span> &#64;MinPrice <span class="hl kwa">IS NOT NULL</span>
            <span class="hl kwa">BEGIN</span>
                <span class="hl kwa">SET</span> &#64;v_Where <span class="hl opt">+=</span> <span class="hl str">N' AND [Product].[Product_Price] &gt;= &#64;MinPrice'</span>
            <span class="hl kwa">END</span>
            <span class="hl kwa">ELSE IF</span> &#64;MaxPrice <span class="hl kwa">IS NOT NULL</span>
            <span class="hl kwa">BEGIN</span>
                <span class="hl kwa">SET</span> &#64;v_Where <span class="hl opt">+=</span> <span class="hl str">N' AND [Product].[Product_Price] &lt;= &#64;MaxPrice'</span>
            <span class="hl kwa">END</span>
        <span class="hl kwa">END</span>
        
        <span class="hl kwa">SET</span> &#64;Statement_Data <span class="hl opt">+=</span> &#64;v_Where
        <span class="hl kwa">SET</span> &#64;Statement_TotalRecords <span class="hl opt">+=</span> &#64;v_Where
        
        <span class="hl slc">-- CTE section (with ORDER BY - if not required use [Product].[Product_Id])...</span>

        <span class="hl kwa">SET</span> &#64;Statement_Data <span class="hl opt">=</span> 
              <span class="hl str">N' ;WITH PagedRows AS ('</span>
            <span class="hl opt">+</span> <span class="hl str">N' SELECT ROW_NUMBER() OVER (ORDER BY [Product].[Product_Price]) AS RowNumber,'</span>
            <span class="hl opt">+</span> &#64;Statement_Data
            <span class="hl opt">+</span> <span class="hl str">N' ) SELECT * FROM PagedRows WITH(NOLOCK) WHERE RowNumber BETWEEN '</span> <span class="hl opt">+</span> <span class="hl kwa">CONVERT</span><span class="hl opt">(</span><span class="hl kwb">VARCHAR</span><span class="hl opt">(</span><span class="hl num">12</span><span class="hl opt">),</span> &#64;v_FirstRow<span class="hl opt">) +</span> <span class="hl str">' AND '</span> <span class="hl opt">+</span> <span class="hl kwa">CONVERT</span><span class="hl opt">(</span><span class="hl kwb">VARCHAR</span><span class="hl opt">(</span><span class="hl num">12</span><span class="hl opt">),</span> &#64;v_LastRow<span class="hl opt">)</span>
        
        <span class="hl slc">-- Parameters...</span>

        <span class="hl kwa">SET</span> &#64;Parameters_Data <span class="hl opt">=</span> <span class="hl str">N'&#64;SearchText VARCHAR(128), &#64;IdSeller BIGINT, &#64;IdManufacturer BIGINT, &#64;SellerName VARCHAR(64), &#64;ManufacturerName VARCHAR(64), &#64;IsAvailable BIT, &#64;MinPrice FLOAT, &#64;MaxPrice FLOAT'</span>
        <span class="hl kwa">SET</span> &#64;Parameters_TotalRecords <span class="hl opt">=</span> <span class="hl str">N'&#64;SearchText VARCHAR(128), &#64;IdSeller BIGINT, &#64;IdManufacturer BIGINT, &#64;SellerName VARCHAR(64), &#64;ManufacturerName VARCHAR(64), &#64;IsAvailable BIT, &#64;MinPrice FLOAT, &#64;MaxPrice FLOAT'</span>

        <span class="hl slc">--PRINT N'DEBUG, &#64;Statement_Data = ' + &#64;Statement_Data</span>
        <span class="hl slc">--PRINT N'DEBUG, &#64;Statement_TotalRecords = ' + &#64;Statement_TotalRecords</span>

        <span class="hl slc">-- Execute requests...</span>

        <span class="hl kwa">EXEC</span> sp_executesql 
             &#64;Statement_Data<span class="hl opt">,</span>
             &#64;Parameters_Data<span class="hl opt">,</span>
             &#64;SearchText<span class="hl opt">,</span>
             &#64;IdSeller<span class="hl opt">,</span>
             &#64;IdManufacturer<span class="hl opt">,</span>
             &#64;SellerName<span class="hl opt">,</span>
             &#64;ManufacturerName<span class="hl opt">,</span>
             &#64;IsAvailable<span class="hl opt">,</span>
             &#64;MinPrice<span class="hl opt">,</span>
             &#64;MaxPrice<span class="hl opt">;</span>

        <span class="hl kwa">EXEC</span> sp_executesql 
             &#64;Statement_TotalRecords<span class="hl opt">,</span>
             &#64;Parameters_TotalRecords<span class="hl opt">,</span>
             &#64;SearchText<span class="hl opt">,</span>
             &#64;IdSeller<span class="hl opt">,</span>
             &#64;IdManufacturer<span class="hl opt">,</span>
             &#64;SellerName<span class="hl opt">,</span>
             &#64;ManufacturerName<span class="hl opt">,</span>
             &#64;IsAvailable<span class="hl opt">,</span>
             &#64;MinPrice<span class="hl opt">,</span>
             &#64;MaxPrice<span class="hl opt">;</span>
    
    <span class="hl kwa">END TRY</span>
    <span class="hl kwa">BEGIN CATCH</span>
    
        <span class="hl slc">-- This section is really important to track (ProcessErrorLog table)</span>
        <span class="hl slc">-- bad dynamic requests!</span>

        <span class="hl kwa">DECLARE</span> &#64;V_NOW <span class="hl kwd">DATETIME2</span><span class="hl opt">(</span><span class="hl num">3</span><span class="hl opt">) =</span> <span class="hl kwd">GETDATE</span><span class="hl opt">();</span>
        <span class="hl kwa">DECLARE</span> &#64;V_ERROR_MESSAGE <span class="hl kwb">VARCHAR</span><span class="hl opt">(</span><span class="hl kwa">MAX</span><span class="hl opt">) =</span> &#64;Statement_Data <span class="hl opt">+</span> <span class="hl str">N' -&gt;'</span> <span class="hl opt">+</span> <span class="hl kwd">ERROR_MESSAGE</span><span class="hl opt">();</span>
        <span class="hl kwa">DECLARE</span> &#64;V_ERROR_SEVERITY <span class="hl kwb">INT</span> <span class="hl opt">=</span> <span class="hl kwd">ERROR_SEVERITY</span><span class="hl opt">();</span>
        <span class="hl kwa">DECLARE</span> &#64;V_ERROR_STATE <span class="hl kwb">INT</span> <span class="hl opt">=</span> <span class="hl kwd">ERROR_STATE</span><span class="hl opt">();</span>

        <span class="hl kwa">EXEC</span> <span class="hl opt">[</span>ProcessErrorLog_Save<span class="hl opt">]</span>
             &#64;ProcessErrorLog_Date <span class="hl opt">=</span> &#64;V_NOW<span class="hl opt">,</span>
             &#64;ProcessErrorLog_ProcedureName <span class="hl opt">=</span> <span class="hl str">N'Product_Custom_SearchWithCriterias'</span><span class="hl opt">,</span>
             &#64;ProcessErrorLog_ErrorMessage <span class="hl opt">=</span> &#64;V_ERROR_MESSAGE<span class="hl opt">,</span>
             &#64;ProcessErrorLog_ErrorSeverity <span class="hl opt">=</span> &#64;V_ERROR_SEVERITY<span class="hl opt">,</span>
             &#64;ProcessErrorLog_ErrorState <span class="hl opt">=</span> &#64;V_ERROR_STATE<span class="hl opt">,</span>
             &#64;ProcessErrorLog_Data <span class="hl opt">=</span> &#64;Statement_Data<span class="hl opt">,</span>
             &#64;CtxUser <span class="hl opt">=</span> &#64;CtxUser<span class="hl opt">,</span>
             &#64;CtxCulture <span class="hl opt">=</span> &#64;CtxCulture<span class="hl opt">,</span>
             &#64;CtxWithContextSecurity <span class="hl opt">=</span> &#64;CtxWithContextSecurity<span class="hl opt">;</span>

        <span class="hl kwd">RAISERROR</span><span class="hl opt">(</span>&#64;V_ERROR_MESSAGE<span class="hl opt">,</span> &#64;V_ERROR_SEVERITY<span class="hl opt">,</span> &#64;V_ERROR_STATE<span class="hl opt">);</span>
        <span class="hl kwa">RETURN</span><span class="hl opt">;</span>
    <span class="hl kwa">END CATCH</span>
<span class="hl kwa">END</span></pre>
        <p>And finally a simple Unit Test.</p>
        <pre class="hl">﻿<span class="hl slc">// Tests</span>
		
<span class="hl kwa">using</span> <span class="hl opt">(</span><span class="hl kwa">var</span> service <span class="hl opt">=</span> <span class="hl kwa">new</span> ServiceProxy<span class="hl opt">&lt;</span>IProductService<span class="hl opt">&gt;())</span>
<span class="hl opt">{</span>
    var criterias <span class="hl opt">=</span> <span class="hl kwa">new</span> ProductSearchCriterias <span class="hl opt">{</span> SellerName <span class="hl opt">=</span> <span class="hl str">&quot;Seller_1&quot;</span> <span class="hl opt">};</span>
    
    criterias<span class="hl opt">.</span>PagingOptions<span class="hl opt">.</span>CurrentPage <span class="hl opt">=</span> <span class="hl num">1</span><span class="hl opt">;</span> <span class="hl slc">// Get the 1° page</span>
    criterias<span class="hl opt">.</span>PagingOptions<span class="hl opt">.</span>RecordsPerPage <span class="hl opt">=</span> <span class="hl num">3</span><span class="hl opt">;</span> <span class="hl slc">// Get 3 items</span>
    
    TCollection<span class="hl opt">&lt;</span>Product<span class="hl opt">&gt;</span> products <span class="hl opt">=</span> service<span class="hl opt">.</span>Proxy<span class="hl opt">.</span><span class="hl kwd">SearchByCriterias</span><span class="hl opt">(</span>ClientContext<span class="hl opt">.</span>Anonymous<span class="hl opt">,</span> <span class="hl kwa">ref</span> criterias<span class="hl opt">);</span>
    
    <span class="hl kwa">if</span> <span class="hl opt">(</span>criterias<span class="hl opt">.</span>PagingOptions<span class="hl opt">.</span>TotalRecords <span class="hl opt">&gt;</span> <span class="hl num">3</span><span class="hl opt">)</span>
    <span class="hl opt">{</span>
    	criterias<span class="hl opt">.</span>PagingOptions<span class="hl opt">.</span>CurrentPage <span class="hl opt">=</span> <span class="hl num">2</span><span class="hl opt">;</span> <span class="hl slc">// Get next page</span>
    
    	products <span class="hl opt">=</span> service<span class="hl opt">.</span>Proxy<span class="hl opt">.</span><span class="hl kwd">SearchByCriterias</span><span class="hl opt">(</span>ClientContext<span class="hl opt">.</span>Anonymous<span class="hl opt">,</span> <span class="hl kwa">ref</span> criterias<span class="hl opt">);</span>
    <span class="hl opt">}</span>
<span class="hl opt">}</span></pre>
	</section>
</body>
</html>
