<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
	<title>LCG - HowTo - Authentication Support</title>
	<link rel="stylesheet" type="text/css" href="../Styles/Highlight.css">
	<link rel="stylesheet" type="text/css" href="../Styles/Styles.css">
</head>
<body>
	<h1>HowTo - Authentication Support</h1>
	<section>
		<div class="box important">
			<h3>Work In Progress</h3>
			<div class="box-content">This page is under construction...</div>
		</div>
	</section>
	<section>
		<h2>1. Database</h2>
		<p>The deployed solution comes with <span class="text-bold">User Authentication Support</span> by default (the following schema can be extended to meet application needs).</p>
		<img src="../ScreenShots/AuthenticationSupport-01.png" title="Illustration" alt="Illustration" />
	</section>
	<section>
		<h2>2. Authentication Methods</h2>
		<p>Some business methods are available and exposed on client-side through WCF.</p>
		<img src="../ScreenShots/AuthenticationSupport-02.png" title="Illustration" alt="Illustration" />
		<ul>
		    <li>
		        <div class="field">IsUsernameUsed()</div>
		        <div class="description">Indicating whether the given Username value is already used in the database (Username is UNIQUE).</div>
		    </li>
		    <li>
		        <div class="field">IsEmailUsed()</div>
		        <div class="description">Indicating whether the given Email value is already used in the database (Email is UNIQUE).</div>
		    </li>
		    <li>
		        <div class="field">IsRegistered()</div>
		        <div class="description">Indicating whether the given UserContext is registered in the database.</div>
		    </li>
		    <li>
		        <div class="field">Create()</div>
		        <div class="description">Creates a new User in the database.</div>
		    </li>
		    <li>
		        <div class="field">ResetPassword()</div>
		        <div class="description">Resets the User's password.</div>
		    </li>
		</ul>
	</section>
	<section>
		<h2>3. Authentication Configuration</h2>
		<p>The configuration can be found in the project <span class="text-bold">Com.Example.Labs.config</span> configuration file.</p>
		<pre class="hl"><span class="hl com">// Com.Example.Labs.config</span>
		
&lt;#
  ...

  &quot;Config.AuthenticationSupport.UserTableName&quot; : &quot;User&quot; <span class="hl slc">// Do not change it</span>
  &quot;Config.AuthenticationSupport.UserTableIdentifiedColumnName&quot; : <span class="text-bold text-red">&quot;User_Username&quot;</span> <span class="hl slc">// Could be User_Email</span>

  ...
#&gt;</pre>
	</section>
	<section>
		<h2>4. Example</h2>
		<p>This example shows how to authenticate an user.</p>
		<pre class="hl"><span class="hl com">// Tests</span>

<span class="hl kwa">namespace</span> Com<span class="hl opt">.</span>Example<span class="hl opt">.</span>Labs<span class="hl opt">.</span><span class="text-red">Tests</span>
<span class="hl opt">{</span>
    <span class="hl kwa">using</span> System<span class="hl opt">;</span>
    <span class="hl kwa">using</span> System<span class="hl opt">.</span>Diagnostics<span class="hl opt">;</span>

    <span class="hl kwa">using</span> Microsoft<span class="hl opt">.</span>VisualStudio<span class="hl opt">.</span>TestTools<span class="hl opt">.</span>UnitTesting<span class="hl opt">;</span>

    <span class="hl kwa">using</span> Com<span class="hl opt">.</span>Example<span class="hl opt">.</span>Labs<span class="hl opt">.</span>Contracts<span class="hl opt">;</span>
    <span class="hl kwa">using</span> Com<span class="hl opt">.</span>Example<span class="hl opt">.</span>Labs<span class="hl opt">.</span>Core<span class="hl opt">;</span>
    <span class="hl kwa">using</span> Com<span class="hl opt">.</span>Example<span class="hl opt">.</span>Labs<span class="hl opt">.</span>Models<span class="hl opt">;</span>

    <span class="hl opt">[</span><span class="hl kwd">TestClass</span><span class="hl opt">]</span>
    <span class="hl kwa">public class</span> AuthenticationTests
    <span class="hl opt">{</span>
        <span class="hl opt">[</span><span class="hl kwd">TestMethod</span><span class="hl opt">]</span>
        <span class="hl kwa">public</span> <span class="hl kwb">void</span> <span class="hl kwd">_IsRegisteredTest</span><span class="hl opt">()</span>
        <span class="hl opt">{</span>
            IUserContext userContext <span class="hl opt">=</span> <span class="hl kwa">new</span> <span class="hl kwd">ClientContext</span><span class="hl opt">(</span><span class="hl str">&quot;john&#64;doe.com&quot;</span><span class="hl opt">,</span> <span class="hl str">&quot;jdoe1970&quot;</span><span class="hl opt">);</span>

            <span class="hl kwa">using</span> <span class="hl opt">(</span><span class="hl kwa">var</span> service <span class="hl opt">=</span> <span class="hl kwa">new</span> ServiceProxy<span class="hl opt">&lt;</span>IAuthenticationService<span class="hl opt">&gt;())</span>
            <span class="hl opt">{</span>
                User user<span class="hl opt">;</span>

                <span class="hl kwb">bool</span> isRegistered <span class="hl opt">=</span> service<span class="hl opt">.</span>Proxy<span class="hl opt">.</span><span class="hl kwd">IsRegistered</span><span class="hl opt">(</span>userContext<span class="hl opt">,</span> <span class="hl kwa">out</span> user<span class="hl opt">);</span>
                <span class="hl kwa">if</span> <span class="hl opt">(</span>isRegistered<span class="hl opt">)</span>
                <span class="hl opt">{</span>
                    <span class="hl slc">// user instance contains John Doe information.</span>

                    Debug<span class="hl opt">.</span><span class="hl kwd">WriteLine</span><span class="hl opt">(</span><span class="hl str">&quot;{0} is authenticated (registration date = {1})&quot;</span><span class="hl opt">,</span>
                        userContext<span class="hl opt">.</span>Identifier<span class="hl opt">,</span> user<span class="hl opt">.</span>RegistrationDate<span class="hl opt">.</span><span class="hl kwd">ToShortDateString</span><span class="hl opt">());</span>
                <span class="hl opt">}</span>
            <span class="hl opt">}</span>
        <span class="hl opt">}</span>
    <span class="hl opt">}</span>
<span class="hl opt">}</span></pre>
	</section>
	<section>
		<h2>5. WCF Operation Security</h2>
		<p>It is possible to secure a <span class="text-bold">WCF operation</span> (and only WCF operations) with Role(s) using the <span class="text-bold">OperationSecurity</span> attribute on the Business method.</p>
		<pre class="hl"><span class="hl com">// Business | UserBusiness.custom.cs</span>

<span class="hl kwa">namespace</span> Com<span class="hl opt">.</span>Example<span class="hl opt">.</span>Labs<span class="hl opt">.</span><span class="text-red">Business</span>
<span class="hl opt">{</span>
    <span class="hl kwa">using</span> System<span class="hl opt">;</span>
    <span class="hl kwa">using</span> System<span class="hl opt">.</span>Collections<span class="hl opt">.</span>Generic<span class="hl opt">;</span>

    <span class="hl kwa">using</span> LayerCake<span class="hl opt">.</span>Generator<span class="hl opt">.</span>Business<span class="hl opt">;</span>
    <span class="hl kwa">using</span> LayerCake<span class="hl opt">.</span>Generator<span class="hl opt">.</span>Core<span class="hl opt">;</span>
    <span class="hl kwa">using</span> LayerCake<span class="hl opt">.</span>Generator<span class="hl opt">.</span>Crud<span class="hl opt">;</span>
    <span class="hl kwa">using</span> LayerCake<span class="hl opt">.</span>Generator<span class="hl opt">.</span>Models<span class="hl opt">;</span>

    <span class="hl opt">[</span><span class="hl kwd">BusinessClass</span><span class="hl opt">]</span>
    <span class="hl kwa">public class</span> <span class="text-bold">UserBusiness</span> <span class="hl opt">:</span> BusinessBase
    <span class="hl opt">{</span>
        <span class="hl opt">[</span><span class="hl kwd">BusinessMethod</span><span class="hl opt">]</span>
        <span class="text-red text-bold">[OperationSecurity(&quot;Admin&quot;, &quot;Staff&quot;)]</span>
        <span class="hl kwa">public</span> <span class="hl kwb">void</span> <span class="hl kwd">CloseUserAccount</span><span class="hl opt">(</span>IUserContext userContext<span class="hl opt">,</span> <span class="hl kwb">long</span> id<span class="hl opt">)</span>
        <span class="hl opt">{</span>
            <span class="hl slc">// Only authenticated user with Admin or Staff role can execute this method...</span>
        <span class="hl opt">}</span>

        <span class="hl opt">[</span><span class="hl kwd">BusinessMethod</span><span class="hl opt">]</span>
        <span class="text-red text-bold">[OperationSecurity(&quot;Admin&quot;)]</span>
        <span class="hl kwa">public</span> <span class="hl kwb">void</span> <span class="hl kwd">DeleteUserAccount</span><span class="hl opt">(</span>IUserContext userContext<span class="hl opt">,</span> <span class="hl kwb">long</span> id<span class="hl opt">)</span>
        <span class="hl opt">{</span>
            <span class="hl slc">// Only authenticated user with Admin role can execute this method...</span>
        <span class="hl opt">}</span>
    <span class="hl opt">}</span>
<span class="hl opt">}</span></pre>
		<p>Once LayerCake Generator is executed these attributes are also set to the Service methods.</p>
		<pre class="hl"><span class="hl com">// Service | UserService.generated.cs</span>
		
<span class="text-red">[OperationSecurity(&quot;Admin&quot;, &quot;Staff&quot;)]</span>
<span class="hl kwa">public</span> <span class="hl kwb">void</span> <span class="hl kwd">CloseUserAccount</span><span class="hl opt">(</span>LayerCake<span class="hl opt">.</span>Generator<span class="hl opt">.</span>Core<span class="hl opt">.</span>IUserContext userContext<span class="hl opt">,</span> <span class="hl kwb">long</span> id<span class="hl opt">)</span>
<span class="hl opt">{</span>
    UserBusiness userBusiness <span class="hl opt">=</span> <span class="hl kwa">new</span> <span class="hl kwd">UserBusiness</span><span class="hl opt">();</span>
    userBusiness<span class="hl opt">.</span><span class="hl kwd">CloseUserAccount</span><span class="hl opt">(</span>userContext<span class="hl opt">,</span> id<span class="hl opt">);</span>
<span class="hl opt">}</span>

<span class="text-red">[OperationSecurity(&quot;Admin&quot;)]</span>
<span class="hl kwa">public</span> <span class="hl kwb">void</span> <span class="hl kwd">DeleteUserAccount</span><span class="hl opt">(</span>LayerCake<span class="hl opt">.</span>Generator<span class="hl opt">.</span>Core<span class="hl opt">.</span>IUserContext userContext<span class="hl opt">,</span> <span class="hl kwb">long</span> id<span class="hl opt">)</span>
<span class="hl opt">{</span>
    UserBusiness userBusiness <span class="hl opt">=</span> <span class="hl kwa">new</span> <span class="hl kwd">UserBusiness</span><span class="hl opt">();</span>
    userBusiness<span class="hl opt">.</span><span class="hl kwd">DeleteUserAccount</span><span class="hl opt">(</span>userContext<span class="hl opt">,</span> id<span class="hl opt">);</span>
<span class="hl opt">}</span></pre>
		<p>Exception when the user is not authenticated.</p>
		<pre class="hl">An exception of type <span class="text-red">'System.Security.SecurityException'</span> occurred in Com.Example.Labs.WebServices.dll but was not handled in user code

Additional information: To execute the 'Com.Example.Labs.Services.UserService.CloseUserAccount' operation the user 'UserNotRegistered' must be authenticated</pre>
		<p>Exception when the user is not allowed to execute the operation.</p>
		<pre class="hl">An exception of type <span class="text-red">'System.Security.SecurityException'</span> occurred in Com.Example.Labs.WebServices.dll but was not handled in user code

Additional information: To execute the 'Com.Example.Labs.Services.UserService.CloseUserAccount' operation the user 'UserRegistered' must have at least one on the following roles: 'Admin, Staff'</pre>
	</section>
</body>
</html>
