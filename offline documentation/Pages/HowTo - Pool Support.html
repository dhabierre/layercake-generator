<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
    <title>LCG - HowTo - Pool Support</title>
    <link rel="stylesheet" type="text/css" href="../Styles/Highlight.css">
    <link rel="stylesheet" type="text/css" href="../Styles/Styles.css">
</head>
<body>
    <h1>HowTo - Pool Support</h1>
    <section>
		<p>Pool unit tests can be found in <span class="text-bold">System.Extensions.Tests &gt; Pool &gt; PoolTests_v*.cs</span> files</p>
		<pre class="hl"><span class="hl kwa">namespace</span> System<span class="hl opt">.</span>Extensions<span class="hl opt">.</span>Tests<span class="hl opt">.</span>PoolTests_v2
<span class="hl opt">{</span>
    <span class="hl kwa">using</span> System<span class="hl opt">;</span>
    <span class="hl kwa">using</span> System<span class="hl opt">.</span>Collections<span class="hl opt">.</span>Generic<span class="hl opt">;</span>
    <span class="hl kwa">using</span> System<span class="hl opt">.</span>Diagnostics<span class="hl opt">;</span>
    <span class="hl kwa">using</span> System<span class="hl opt">.</span>Threading<span class="hl opt">;</span>
    
    <span class="hl kwa">using</span> Microsoft<span class="hl opt">.</span>VisualStudio<span class="hl opt">.</span>TestTools<span class="hl opt">.</span>UnitTesting<span class="hl opt">;</span>
    
    <span class="hl kwa">interface</span> IConnector <span class="hl opt">:</span> IDisposable
    <span class="hl opt">{</span>
        <span class="hl kwb">void</span> <span class="hl kwd">Send</span><span class="hl opt">();</span>
    <span class="hl opt">}</span>
    
    <span class="hl ppc">#region [ v2 -&gt; Connector implements IPoolableObject ]</span>
    
    <span class="hl kwa">class</span> Connector <span class="hl opt">:</span> IConnector<span class="hl opt">,</span> IPoolableObject
    <span class="hl opt">{</span>
        <span class="hl kwa">private static</span> <span class="hl kwb">int</span> _count <span class="hl opt">=</span> <span class="hl num">0</span><span class="hl opt">;</span> <span class="hl slc">// used to generate Id value</span>
    
        <span class="hl kwa">public</span> <span class="hl kwd">Connector</span><span class="hl opt">()</span>
        <span class="hl opt">{</span>
            <span class="hl kwa">this</span><span class="hl opt">.</span>Id <span class="hl opt">=</span> Interlocked<span class="hl opt">.</span><span class="hl kwd">Increment</span><span class="hl opt">(</span><span class="hl kwa">ref</span> _count<span class="hl opt">);</span> <span class="hl slc">// generates the ID</span>
        <span class="hl opt">}</span>
    
        ~<span class="hl kwd">Connector</span><span class="hl opt">()</span>
        <span class="hl opt">{</span>
            <span class="hl kwa">this</span><span class="hl opt">.</span><span class="hl kwd">Dispose</span><span class="hl opt">(</span><span class="hl kwa">false</span><span class="hl opt">);</span>
        <span class="hl opt">}</span>
    
        <span class="hl ppc">#region [ Properties ]</span>
    
        <span class="hl kwa">public</span> <span class="hl kwb">int</span> Id <span class="hl opt">{</span> <span class="hl kwa">get</span><span class="hl opt">;</span> <span class="hl kwa">private set</span><span class="hl opt">; }</span>
    
        <span class="hl ppc">#endregion</span>
    
        <span class="hl ppc">#region [ IConnector Implementation ]</span>
    
        <span class="hl kwa">public</span> <span class="hl kwb">void</span> <span class="hl kwd">Send</span><span class="hl opt">()</span>
        <span class="hl opt">{</span>
            Debug<span class="hl opt">.</span><span class="hl kwd">WriteLine</span><span class="hl opt">(</span><span class="hl str">&quot;Connector.Send() -&gt; #{0}&quot;</span><span class="hl opt">,</span> <span class="hl kwa">this</span><span class="hl opt">.</span>Id<span class="hl opt">);</span>
        <span class="hl opt">}</span>
    
        <span class="hl ppc">#endregion</span>
    
        <span class="hl ppc">#region [ IPoolableObject Implementation ]</span>
    
        <span class="hl kwa">public</span> <span class="hl kwb">void</span> <span class="hl kwd">Initialize</span><span class="hl opt">(</span><span class="hl kwb">object</span> parameter<span class="hl opt">)</span>
        <span class="hl opt">{</span>
            <span class="hl slc">// add code to initialize the instance...</span>
    
            Thread<span class="hl opt">.</span><span class="hl kwd">Sleep</span><span class="hl opt">(</span><span class="hl num">1000</span><span class="hl opt">);</span> <span class="hl slc">// simulates long initialization...</span>
    
            Debug<span class="hl opt">.</span><span class="hl kwd">WriteLine</span><span class="hl opt">(</span><span class="hl str">&quot;Connector_v1.Initialize() -&gt; #{0}&quot;</span><span class="hl opt">,</span> <span class="hl kwa">this</span><span class="hl opt">.</span>Id<span class="hl opt">);</span>
        <span class="hl opt">}</span>
    
        <span class="hl kwa">public</span> <span class="hl kwb">void</span> <span class="hl kwd">ResetState</span><span class="hl opt">()</span>
        <span class="hl opt">{</span>
            <span class="hl slc">// add code to reset the state of the instance...</span>
    
            Debug<span class="hl opt">.</span><span class="hl kwd">WriteLine</span><span class="hl opt">(</span><span class="hl str">&quot;Connector_v1.Reset() -&gt; #{0}&quot;</span><span class="hl opt">,</span> <span class="hl kwa">this</span><span class="hl opt">.</span>Id<span class="hl opt">);</span>
        <span class="hl opt">}</span>
    
        <span class="hl ppc">#endregion</span>
    
        <span class="hl ppc">#region [ IDisposable Implementation ]</span>
    
        <span class="hl kwa">private</span> <span class="hl kwb">bool</span> _isDisposed <span class="hl opt">=</span> <span class="hl kwa">false</span><span class="hl opt">;</span>
    
        <span class="hl kwa">public</span> <span class="hl kwb">void</span> <span class="hl kwd">Dispose</span><span class="hl opt">()</span>
        <span class="hl opt">{</span>
            <span class="hl kwa">this</span><span class="hl opt">.</span><span class="hl kwd">Dispose</span><span class="hl opt">(</span><span class="hl kwa">true</span><span class="hl opt">);</span>
            GC<span class="hl opt">.</span><span class="hl kwd">SuppressFinalize</span><span class="hl opt">(</span><span class="hl kwa">this</span><span class="hl opt">);</span>
        <span class="hl opt">}</span>
    
        <span class="hl kwa">protected virtual</span> <span class="hl kwb">void</span> <span class="hl kwd">Dispose</span><span class="hl opt">(</span><span class="hl kwb">bool</span> disposing<span class="hl opt">)</span>
        <span class="hl opt">{</span>
            <span class="hl kwa">if</span> <span class="hl opt">(</span>disposing<span class="hl opt">)</span>
            <span class="hl opt">{</span>
                <span class="hl kwa">if</span> <span class="hl opt">(!</span>_isDisposed<span class="hl opt">)</span>
                <span class="hl opt">{</span>
                    _isDisposed <span class="hl opt">=</span> <span class="hl kwa">true</span><span class="hl opt">;</span>
    
                    Debug<span class="hl opt">.</span><span class="hl kwd">WriteLine</span><span class="hl opt">(</span><span class="hl str">&quot;Connector.Dispose() -&gt; #{0}&quot;</span><span class="hl opt">,</span> <span class="hl kwa">this</span><span class="hl opt">.</span>Id<span class="hl opt">);</span>
                <span class="hl opt">}</span>
            <span class="hl opt">}</span>
        <span class="hl opt">}</span>
    
        <span class="hl ppc">#endregion</span>
    <span class="hl opt">}</span>
    
    <span class="hl slc">// -&gt; Connector implements IPoolableObject</span>
    <span class="hl slc">// -&gt; Initialize() and ResetState() don't have to be overrided</span>
    
    <span class="hl kwa">class</span> PooledConnector <span class="hl opt">:</span> PooledObject<span class="hl opt">&lt;</span>IConnector<span class="hl opt">,</span> Connector<span class="hl opt">&gt;,</span> IConnector
    <span class="hl opt">{</span>
        <span class="hl kwa">public</span> <span class="hl kwd">PooledConnector</span><span class="hl opt">(</span>Pool<span class="hl opt">&lt;</span>IConnector<span class="hl opt">&gt;</span> pool<span class="hl opt">)</span>
            <span class="hl opt">:</span> <span class="hl kwa">base</span><span class="hl opt">(</span>pool<span class="hl opt">)</span>
        <span class="hl opt">{</span>
        <span class="hl opt">}</span>
    
        <span class="hl ppc">#region [ IConnector Implementation ]</span>
    
        <span class="hl kwa">public</span> <span class="hl kwb">void</span> <span class="hl kwd">Send</span><span class="hl opt">()</span>
        <span class="hl opt">{</span>
            _innerObject<span class="hl opt">.</span><span class="hl kwd">Send</span><span class="hl opt">();</span>
        <span class="hl opt">}</span>
    
        <span class="hl ppc">#endregion</span>
    <span class="hl opt">}</span>
    
    <span class="hl ppc">#endregion</span>
    
    <span class="hl kwa">class</span> ConnectorConfiguration <span class="hl opt">{ }</span> <span class="hl slc">// for the sample (for example to pass configuration for the pooled connectors)</span>
    
    <span class="hl kwa">class</span> ConnectorPoolManager <span class="hl opt">:</span> Singleton<span class="hl opt">&lt;</span>ConnectorPoolManager<span class="hl opt">&gt;</span> <span class="hl slc">// if you want to use a singleton</span>
    <span class="hl opt">{</span>
        <span class="hl kwa">private static readonly</span> Pool<span class="hl opt">&lt;</span>IConnector<span class="hl opt">&gt;</span> _pool <span class="hl opt">=</span> <span class="hl kwa">new</span> Pool<span class="hl opt">&lt;</span>IConnector<span class="hl opt">&gt;(</span>
            <span class="hl num">2</span><span class="hl opt">,</span>
            p <span class="hl opt">=&gt;</span> <span class="hl kwa">new</span> <span class="hl kwd">PooledConnector</span><span class="hl opt">(</span>p<span class="hl opt">),</span>
            PoolLoadingModeEnum<span class="hl opt">.</span>Lazy<span class="hl opt">,</span> <span class="hl slc">// recommended</span>
            PoolAccessModeEnum<span class="hl opt">.</span>Circular<span class="hl opt">,</span>			
            <span class="hl opt">() =&gt;</span> <span class="hl opt">{</span> <span class="hl kwa">return</span> _config<span class="hl opt">;</span> <span class="hl opt">});</span>
    
        <span class="hl kwa">public</span> IConnector <span class="hl kwd">Acquire</span><span class="hl opt">()</span>
        <span class="hl opt">{</span>
            <span class="hl kwa">return</span> _pool<span class="hl opt">.</span><span class="hl kwd">Acquire</span><span class="hl opt">();</span>
        <span class="hl opt">}</span>
    <span class="hl opt">}</span>
    
    <span class="hl opt">[</span>TestClass<span class="hl opt">]</span>
    <span class="hl kwa">public class</span> PoolTests
    <span class="hl opt">{</span>
        <span class="hl kwa">private readonly</span> ConnectorConfiguration _config <span class="hl opt">=</span> <span class="hl kwa">new</span> <span class="hl kwd">ConnectorConfiguration</span><span class="hl opt">();</span> <span class="hl slc">// for the sample</span>
    
        <span class="hl opt">[</span>TestMethod<span class="hl opt">]</span>
        <span class="hl kwa">public</span> <span class="hl kwb">void</span> <span class="hl kwd">Extensions_PoolTest_v2_Instance_EagerCircular</span><span class="hl opt">()</span>
        <span class="hl opt">{</span>
            var pool <span class="hl opt">=</span> <span class="hl kwa">new</span> Pool<span class="hl opt">&lt;</span>IConnector<span class="hl opt">&gt;(</span> <span class="hl slc">// Eager -&gt; 2 Connectors immediately created when the pool is instanciated (2 x 1000ms)</span>
                <span class="hl num">2</span><span class="hl opt">,</span>
                p <span class="hl opt">=&gt;</span> <span class="hl kwa">new</span> <span class="hl kwd">PooledConnector</span><span class="hl opt">(</span>p<span class="hl opt">),</span>
                PoolLoadingModeEnum<span class="hl opt">.</span>Eager<span class="hl opt">,</span>
                PoolAccessModeEnum<span class="hl opt">.</span>Circular<span class="hl opt">,</span>
                <span class="hl opt">() =&gt;</span> <span class="hl opt">{</span> <span class="hl kwa">return</span> _config<span class="hl opt">;</span> <span class="hl opt">});</span>
    
            <span class="hl slc">// Now the pool contains 2 Connectors</span>
    
            <span class="hl kwa">using</span> <span class="hl opt">(</span>var connector <span class="hl opt">=</span> pool<span class="hl opt">.</span><span class="hl kwd">Acquire</span><span class="hl opt">())</span> <span class="hl slc">// -&gt; gets Connector #1 from the pool</span>
            <span class="hl opt">{</span>
                connector<span class="hl opt">.</span><span class="hl kwd">Send</span><span class="hl opt">();</span>
            <span class="hl opt">}</span>
    
            <span class="hl slc">// Connector #1 is released at the end of the using() and becomes available</span>
    
            <span class="hl kwa">using</span> <span class="hl opt">(</span>var connector <span class="hl opt">=</span> pool<span class="hl opt">.</span><span class="hl kwd">Acquire</span><span class="hl opt">())</span> <span class="hl slc">// -&gt; gets Connector #2 from the pool</span>
            <span class="hl opt">{</span>
                connector<span class="hl opt">.</span><span class="hl kwd">Send</span><span class="hl opt">();</span>
            <span class="hl opt">}</span>
    
            <span class="hl kwa">using</span> <span class="hl opt">(</span>var connector <span class="hl opt">=</span> pool<span class="hl opt">.</span><span class="hl kwd">Acquire</span><span class="hl opt">())</span> <span class="hl slc">// -&gt; gets Connector #1 from the pool</span>
            <span class="hl opt">{</span>
                connector<span class="hl opt">.</span><span class="hl kwd">Send</span><span class="hl opt">();</span>
            <span class="hl opt">}</span>
    
            <span class="hl slc">// -&gt; the pool contains 2 Connectors</span>
        <span class="hl opt">}</span>
    
        <span class="hl opt">[</span>TestMethod<span class="hl opt">]</span>
        <span class="hl kwa">public</span> <span class="hl kwb">void</span> <span class="hl kwd">Extensions_PoolTest_v2_Instance_LazyCircular</span><span class="hl opt">()</span>
        <span class="hl opt">{</span>
            var pool <span class="hl opt">=</span> <span class="hl kwa">new</span> Pool<span class="hl opt">&lt;</span>IConnector<span class="hl opt">&gt;(</span> <span class="hl slc">// -&gt; Lazy -&gt; no Connectors created</span>
                <span class="hl num">2</span><span class="hl opt">,</span>
                p <span class="hl opt">=&gt;</span> <span class="hl kwa">new</span> <span class="hl kwd">PooledConnector</span><span class="hl opt">(</span>p<span class="hl opt">),</span>
                PoolLoadingModeEnum<span class="hl opt">.</span>Lazy<span class="hl opt">,</span>
                PoolAccessModeEnum<span class="hl opt">.</span>Circular<span class="hl opt">,</span>			
                <span class="hl opt">() =&gt;</span> <span class="hl opt">{</span> <span class="hl kwa">return</span> _config<span class="hl opt">;</span> <span class="hl opt">});</span>
    
            <span class="hl slc">// Now the pool contains 0 Connector</span>
    
            <span class="hl kwa">using</span> <span class="hl opt">(</span>var connector <span class="hl opt">=</span> pool<span class="hl opt">.</span><span class="hl kwd">Acquire</span><span class="hl opt">())</span> <span class="hl slc">// creates Connector #1 in the pool (1 x 1000ms)</span>
            <span class="hl opt">{</span>
                connector<span class="hl opt">.</span><span class="hl kwd">Send</span><span class="hl opt">();</span>
            <span class="hl opt">}</span>
    
            <span class="hl kwa">using</span> <span class="hl opt">(</span>var connector <span class="hl opt">=</span> pool<span class="hl opt">.</span><span class="hl kwd">Acquire</span><span class="hl opt">())</span> <span class="hl slc">// Connector #1 is free -&gt; gets Connector #1 from the pool</span>
            <span class="hl opt">{</span>
                connector<span class="hl opt">.</span><span class="hl kwd">Send</span><span class="hl opt">();</span>
            <span class="hl opt">}</span>
    
            <span class="hl slc">// -&gt; the pool contains 1 Connector</span>
        <span class="hl opt">}</span>
    
        <span class="hl opt">[</span>TestMethod<span class="hl opt">]</span>
        <span class="hl kwa">public</span> <span class="hl kwb">void</span> <span class="hl kwd">Extensions_PoolTest_v2_Instance_LazyExpandingCircular</span><span class="hl opt">()</span>
        <span class="hl opt">{</span>
            var pool <span class="hl opt">=</span> <span class="hl kwa">new</span> Pool<span class="hl opt">&lt;</span>IConnector<span class="hl opt">&gt;(</span> <span class="hl slc">// -&gt; LazyExpanding -&gt; no Connectors created</span>
                <span class="hl num">2</span><span class="hl opt">,</span>
                p <span class="hl opt">=&gt;</span> <span class="hl kwa">new</span> <span class="hl kwd">PooledConnector</span><span class="hl opt">(</span>p<span class="hl opt">),</span>
                PoolLoadingModeEnum<span class="hl opt">.</span>LazyExpanding<span class="hl opt">,</span>
                PoolAccessModeEnum<span class="hl opt">.</span>Circular<span class="hl opt">,</span>			
                <span class="hl opt">() =&gt;</span> <span class="hl opt">{</span> <span class="hl kwa">return</span> _config<span class="hl opt">;</span> <span class="hl opt">});</span>
    
            <span class="hl slc">// Now the pool contains 0 Connector</span>
    
            <span class="hl kwa">using</span> <span class="hl opt">(</span>var connector <span class="hl opt">=</span> pool<span class="hl opt">.</span><span class="hl kwd">Acquire</span><span class="hl opt">())</span> <span class="hl slc">// the pool is not full -&gt; creates Connector #1 in the pool (1 x 1000ms)</span>
            <span class="hl opt">{</span>
                connector<span class="hl opt">.</span><span class="hl kwd">Send</span><span class="hl opt">();</span>
            <span class="hl opt">}</span>
    
            <span class="hl kwa">using</span> <span class="hl opt">(</span>var connector <span class="hl opt">=</span> pool<span class="hl opt">.</span><span class="hl kwd">Acquire</span><span class="hl opt">())</span> <span class="hl slc">// the pool is not full -&gt; creates Connector #2 in the pool (1 x 1000ms)</span>
            <span class="hl opt">{</span>
                connector<span class="hl opt">.</span><span class="hl kwd">Send</span><span class="hl opt">();</span>
            <span class="hl opt">}</span>
    
            <span class="hl kwa">using</span> <span class="hl opt">(</span>var connector <span class="hl opt">=</span> pool<span class="hl opt">.</span><span class="hl kwd">Acquire</span><span class="hl opt">())</span> <span class="hl slc">// the pool is full - the Connector #1 is free -&gt; gets Connector #1 from the pool</span>
            <span class="hl opt">{</span>
                connector<span class="hl opt">.</span><span class="hl kwd">Send</span><span class="hl opt">();</span>
            <span class="hl opt">}</span>
    
            <span class="hl slc">// -&gt; the pool contains 2 Connectors</span>
        <span class="hl opt">}</span>
    
        <span class="hl opt">[</span>TestMethod<span class="hl opt">]</span>
        <span class="hl kwa">public</span> <span class="hl kwb">void</span> <span class="hl kwd">Extensions_PoolTest_v2_Singleton</span><span class="hl opt">()</span>
        <span class="hl opt">{</span>
            <span class="hl kwa">using</span> <span class="hl opt">(</span>var connector <span class="hl opt">=</span> ConnectorPoolManager<span class="hl opt">.</span>Current<span class="hl opt">.</span><span class="hl kwd">Acquire</span><span class="hl opt">())</span>
            <span class="hl opt">{</span>
                connector<span class="hl opt">.</span><span class="hl kwd">Send</span><span class="hl opt">();</span>
            <span class="hl opt">}</span>
        <span class="hl opt">}</span>
    <span class="hl opt">}</span>
<span class="hl opt">}</span></pre>
    </section>
</body>
</html>
