<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
	<title>LCG - HowTo - RedisCacheService Support</title>
	<link rel="stylesheet" type="text/css" href="../Styles/Highlight.css">
	<link rel="stylesheet" type="text/css" href="../Styles/Styles.css">
</head>
<body>
	<h1>HowTo - RedisCacheService Support</h1>
	<section>
		<p>By default <span class="text-bold">CacheServiceHelper.Current</span> singleton uses <span class="text-bold">LocalMemoryCacheService</span> implementation.</p>
		<p>This HowTo explains how to use a <a href="http://www.redis.io/" title="Redis Project" class="text-bold" target="_blank">Redis</a> implementation (at server-side through configuration file) instead of LocalMemoryCacheService one.</p>
		<p class="quote">Redis is a data structure server. It is open-source, networked, in-memory, and stores keys with optional durability. According to the monthly ranking by DB-Engines.com, Redis is the most popular key-value database. The name Redis means REmote DIctionary Server -- Wikipedia</p>
		<p>This documentation is based on <span class="text-bold">StackExchange.Redis.Extensions</span>.</p>
	</section>
	<section>
		<h2>1. Externals.RedisCache Library</h2>
		<p class="action">First add a new <span class="text-bold">Class Library</span> project to the solution (choose the name you wish)</p>
		<img src="../ScreenShots/RedisCacheServiceSupport-01.png" title="Illustration" alt="Illustration" />
		<p class="action">Then add a reference to the <span class="text-bold">System.Extensions</span> project</p>
		<img src="../ScreenShots/RedisCacheServiceSupport-02.png" title="Illustration" alt="Illustration" />
	</section>
	<section>
		<h2>2. NuGet Packages</h2>
		<p class="action">Open <span class="text-bold">Tools</span> &gt; <span class="text-bold">NuGet Package Manager</span> &gt; <span class="text-bold">Package Manager Console</span> and select the project</p>
		<img src="../ScreenShots/RedisCacheServiceSupport-03.png" title="Illustration" alt="Illustration" />
		<p class="action">Install <span class="text-bold">Redis 64bits</span> (currently v2.8.19)</p>
		<p class="pm-action">PM&gt; Install-Package Redis-64</p>
		<p class="action">Install the <span class="text-bold">StackExchange.Redis.Extensions</span> package (all required dependencies will be installed too)</p>
		<p class="pm-action">PM&gt; Install-Package StackExchange.Redis.Extensions.Newtonsoft</p>
		
		<div class="box warning">
			<h3>Unable To Read Package</h3>
			<div class="box-content">If the following error occurs</div>
			<div class="box-content pm-error" style="margin-top: 12px; padding: 4px 8px;">Install-Package : Unable to read package from path 'Newtonsoft.Json.7.0.1\Newtonsoft.Json.7.0.1.nupkg'.</div>
			<ol>
				<li>Move the <em>Src\packages\Newtonsoft.Json.7.0.1</em> directory outside the <em>packages</em> folder (Desktop for example)</li>
				<li>Execute <em>Install-Package StackExchange.Redis.Extensions.Newtonsoft</em> again</li>
				<li>If the versions are different move back Newtonsoft.Json.7.0.1 directory</li>
			</ol>
		</div>
		<p>Result</p>
		<img src="../ScreenShots/RedisCacheServiceSupport-04.png" title="Illustration" alt="Illustration" />
	</section>
	<section>
		<h2>3. Implementation</h2>
		<p class="action">Add the new <span class="text-bold">CacheService</span> class in the project</p>
<pre class="hl">﻿<span class="hl slc">// -----------------------------------------------</span>
<span class="hl slc">// This file is part of the LayerCake Generator.</span>
<span class="hl slc">//</span>
<span class="hl slc">// Copyright (c) 2012, 2015 LayerCake Generator.</span>
<span class="hl slc">// http://www.layercake-generator.net</span>
<span class="hl slc">// -----------------------------------------------</span>

<span class="hl kwa">namespace</span> Externals<span class="hl opt">.</span>RedisCache
<span class="hl opt">{</span>
    <span class="hl kwa">using</span> StackExchange<span class="hl opt">.</span>Redis<span class="hl opt">.</span>Extensions<span class="hl opt">.</span>Core<span class="hl opt">;</span>
    <span class="hl kwa">using</span> StackExchange<span class="hl opt">.</span>Redis<span class="hl opt">.</span>Extensions<span class="hl opt">.</span>Newtonsoft<span class="hl opt">;</span>
    
    <span class="hl kwa">using</span> System<span class="hl opt">;</span>
    <span class="hl kwa">using</span> System<span class="hl opt">.</span>Collections<span class="hl opt">.</span>Generic<span class="hl opt">;</span>
    <span class="hl kwa">using</span> System<span class="hl opt">.</span>Linq<span class="hl opt">;</span>
    <span class="hl kwa">using</span> System<span class="hl opt">.</span>Threading<span class="hl opt">.</span>Tasks<span class="hl opt">;</span>
    
    <span class="hl slc">/// &lt;summary&gt;</span>
    <span class="hl slc">/// A Redis implementation (System.ICacheService implementation).</span>
    <span class="hl slc">/// Redis-64 v2.8.19, StackExchange.Redis v1.0.450, StackExchange.Redis.Extensions.Core v1.1.10.0, StackExchange.Redis.Extensions.Newtonsoft v1.1.7.0.</span>
    <span class="hl slc">/// &lt;/summary&gt;</span>
    <span class="hl kwa">public class</span> CacheService <span class="hl opt">:</span> ICacheService
    <span class="hl opt">{</span>
        <span class="hl ppc">#region [ Members ]</span>
    
        <span class="hl kwa">private static readonly</span> StackExchangeRedisCacheClient _cacheClient <span class="hl opt">=</span> <span class="hl kwa">null</span><span class="hl opt">;</span>
        <span class="hl kwa">private static readonly</span> ICacheStatistics _statistics <span class="hl opt">=</span> <span class="hl kwa">null</span><span class="hl opt">;</span>
    
        <span class="hl ppc">#endregion</span>
    
        <span class="hl ppc">#region [ Constructors ]</span>
    
        <span class="hl kwa">static</span> <span class="hl kwd">CacheService</span><span class="hl opt">()</span>
        <span class="hl opt">{</span>
            _cacheClient <span class="hl opt">=</span> <span class="hl kwa">new</span> <span class="hl kwd">StackExchangeRedisCacheClient</span><span class="hl opt">(</span><span class="hl kwa">new</span> <span class="hl kwd">NewtonsoftSerializer</span><span class="hl opt">());</span>
            _statistics <span class="hl opt">=</span> <span class="hl kwa">new</span> <span class="hl kwd">CacheStatistics</span><span class="hl opt">();</span>
        <span class="hl opt">}</span>
    
        <span class="hl slc">/// &lt;summary&gt;</span>
        <span class="hl slc">/// Initializes a new instance of the RedisCacheService class.</span>
        <span class="hl slc">/// &lt;/summary&gt;</span>
        <span class="hl kwa">public</span> <span class="hl kwd">CacheService</span><span class="hl opt">()</span>
        <span class="hl opt">{</span>
        <span class="hl opt">}</span>
    
        <span class="hl slc">/// &lt;summary&gt;</span>
        <span class="hl slc">/// Destructor.</span>
        <span class="hl slc">/// &lt;/summary&gt;</span>
        ~<span class="hl kwd">CacheService</span><span class="hl opt">()</span>
        <span class="hl opt">{</span>
            <span class="hl kwa">this</span><span class="hl opt">.</span><span class="hl kwd">Dispose</span><span class="hl opt">(</span><span class="hl kwa">false</span><span class="hl opt">);</span>
        <span class="hl opt">}</span>
    
        <span class="hl ppc">#endregion</span>
    
        <span class="hl ppc">#region [ ICacheService Implementation ]</span>
    
        <span class="hl ppc">#region [ Synchronous Methods ]</span>
    
        <span class="hl slc">/// &lt;summary&gt;</span>
        <span class="hl slc">/// Adds a CacheItem object to the cache. If the key already exists, the cache is updated with the new data.</span>
        <span class="hl slc">/// &lt;/summary&gt;</span>
        <span class="hl slc">///</span>
        <span class="hl slc">/// &lt;param name=&quot;cacheItem&quot;&gt;</span>
        <span class="hl slc">/// CacheItem object.</span>
        <span class="hl slc">/// &lt;/param&gt;</span>
        <span class="hl kwa">public</span> <span class="hl kwb">bool</span> <span class="hl kwd">Add</span><span class="hl opt">(</span>CacheItem cacheItem<span class="hl opt">)</span>
        <span class="hl opt">{</span>
            <span class="hl slc">// RedisServerException: 'ERR invalid expire time in setex'</span>
            <span class="hl slc">// -&gt; the expiration value has a bad value</span>
    
            <span class="hl kwa">return</span> _cacheClient<span class="hl opt">.</span><span class="hl kwd">Add</span><span class="hl opt">(</span>cacheItem<span class="hl opt">.</span>Key<span class="hl opt">,</span> cacheItem<span class="hl opt">.</span>Data<span class="hl opt">,</span> cacheItem<span class="hl opt">.</span>Expiration<span class="hl opt">);</span>
        <span class="hl opt">}</span>
    
        <span class="hl slc">/// &lt;summary&gt;</span>
        <span class="hl slc">/// Adds a new object to the cache with expiration TimeSpan.</span>
        <span class="hl slc">/// If the key already exists, the cache is updated with the new data.</span>
        <span class="hl slc">/// &lt;/summary&gt;</span>
        <span class="hl slc">///</span>
        <span class="hl slc">/// &lt;param name=&quot;key&quot;&gt;</span>
        <span class="hl slc">/// Unique key.</span>
        <span class="hl slc">/// &lt;/param&gt;</span>
        <span class="hl slc">///</span>
        <span class="hl slc">/// &lt;param name=&quot;data&quot;&gt;</span>
        <span class="hl slc">/// Object to add to the cache.</span>
        <span class="hl slc">/// &lt;/param&gt;</span>
        <span class="hl slc">///</span>
        <span class="hl slc">/// &lt;param name=&quot;timeSpan&quot;&gt;</span>
        <span class="hl slc">/// Expiration TimeSpan.</span>
        <span class="hl slc">/// &lt;/param&gt;</span>
        <span class="hl kwa">public</span> <span class="hl kwb">bool</span> <span class="hl kwd">Add</span><span class="hl opt">(</span><span class="hl kwb">string</span> key<span class="hl opt">,</span> <span class="hl kwb">object</span> data<span class="hl opt">,</span> TimeSpan timeSpan<span class="hl opt">)</span>
        <span class="hl opt">{</span>
            <span class="hl slc">// RedisServerException: 'ERR invalid expire time in setex'</span>
            <span class="hl slc">// -&gt; the expiration value is out of range</span>
    
            <span class="hl kwa">return</span> _cacheClient<span class="hl opt">.</span><span class="hl kwd">Add</span><span class="hl opt">(</span>key<span class="hl opt">,</span> data<span class="hl opt">,</span> timeSpan<span class="hl opt">);</span>
        <span class="hl opt">}</span>
    
        <span class="hl slc">/// &lt;summary&gt;</span>
        <span class="hl slc">/// Gets an object from the cache given its unique key.</span>
        <span class="hl slc">/// &lt;/summary&gt;</span>
        <span class="hl slc">///</span>
        <span class="hl slc">/// &lt;typeparam name=&quot;T&quot;&gt;</span>
        <span class="hl slc">/// The type of the retrieved object.</span>
        <span class="hl slc">/// &lt;/typeparam&gt;</span>
        <span class="hl slc">///</span>
        <span class="hl slc">/// &lt;param name=&quot;key&quot;&gt;</span>
        <span class="hl slc">/// Unique key.</span>
        <span class="hl slc">/// &lt;/param&gt;</span>
        <span class="hl slc">///</span>
        <span class="hl slc">/// &lt;returns&gt;</span>
        <span class="hl slc">/// The retrieved object. If not found returns null.</span>
        <span class="hl slc">/// &lt;/returns&gt;</span>
        <span class="hl kwa">public</span> T Get<span class="hl opt">&lt;</span>T<span class="hl opt">&gt;(</span><span class="hl kwb">string</span> key<span class="hl opt">)</span> where T <span class="hl opt">:</span> <span class="hl kwa">class</span>
        <span class="hl opt">{</span>
            <span class="hl opt">((</span>CacheStatistics<span class="hl opt">)</span>_statistics<span class="hl opt">).</span><span class="hl kwd">IncrementRequestCount</span><span class="hl opt">();</span>
    
            var data <span class="hl opt">=</span> _cacheClient<span class="hl opt">.</span>Get<span class="hl opt">&lt;</span>T<span class="hl opt">&gt;(</span>key<span class="hl opt">);</span>
    
            <span class="hl kwa">if</span> <span class="hl opt">(</span>data <span class="hl opt">==</span> <span class="hl kwa">null</span><span class="hl opt">)</span>
            <span class="hl opt">{</span>
                <span class="hl opt">((</span>CacheStatistics<span class="hl opt">)</span>_statistics<span class="hl opt">).</span><span class="hl kwd">IncrementMissCount</span><span class="hl opt">();</span>
            <span class="hl opt">}</span>
            <span class="hl kwa">else</span>
            <span class="hl opt">{</span>
                <span class="hl opt">((</span>CacheStatistics<span class="hl opt">)</span>_statistics<span class="hl opt">).</span><span class="hl kwd">IncrementHitCount</span><span class="hl opt">();</span>
            <span class="hl opt">}</span>
    
            <span class="hl kwa">return</span> data<span class="hl opt">;</span>
        <span class="hl opt">}</span>
    
        <span class="hl slc">/// &lt;summary&gt;</span>
        <span class="hl slc">/// Gets an object from the cache given its unique key.</span>
        <span class="hl slc">/// &lt;/summary&gt;</span>
        <span class="hl slc">///</span>
        <span class="hl slc">/// &lt;typeparam name=&quot;T&quot;&gt;</span>
        <span class="hl slc">/// The type of the retrieved object.</span>
        <span class="hl slc">/// &lt;/typeparam&gt;</span>
        <span class="hl slc">///</span>
        <span class="hl slc">/// &lt;param name=&quot;key&quot;&gt;</span>
        <span class="hl slc">/// Unique key.</span>
        <span class="hl slc">/// &lt;/param&gt;</span>
        <span class="hl slc">///</span>
        <span class="hl slc">/// &lt;param name=&quot;whenNull&quot;&gt;</span>
        <span class="hl slc">/// Function to execute when the key is not present in the cache.</span>
        <span class="hl slc">/// &lt;/param&gt;</span>
        <span class="hl slc">///</span>
        <span class="hl slc">/// &lt;param name=&quot;expiration&quot;&gt;</span>
        <span class="hl slc">/// Expiration DateTime.</span>
        <span class="hl slc">/// &lt;/param&gt;</span>
        <span class="hl slc">///</span>
        <span class="hl slc">/// &lt;returns&gt;</span>
        <span class="hl slc">/// The retrieved object. If not found returns null.</span>
        <span class="hl slc">/// &lt;/returns&gt;</span>
        <span class="hl kwa">public</span> T Get<span class="hl opt">&lt;</span>T<span class="hl opt">&gt;(</span><span class="hl kwb">string</span> key<span class="hl opt">,</span> Func<span class="hl opt">&lt;</span>T<span class="hl opt">&gt;</span> whenNull<span class="hl opt">,</span> DateTime expiration<span class="hl opt">)</span> where T <span class="hl opt">:</span> <span class="hl kwa">class</span>
        <span class="hl opt">{</span>
            var item <span class="hl opt">=</span> <span class="hl kwa">this</span><span class="hl opt">.</span>Get<span class="hl opt">&lt;</span>T<span class="hl opt">&gt;(</span>key<span class="hl opt">);</span>
            <span class="hl kwa">if</span> <span class="hl opt">(</span>item <span class="hl opt">==</span> <span class="hl kwa">null</span><span class="hl opt">)</span>
            <span class="hl opt">{</span>
                item <span class="hl opt">=</span> <span class="hl kwd">whenNull</span><span class="hl opt">();</span>
                <span class="hl kwa">if</span> <span class="hl opt">(</span>item <span class="hl opt">!=</span> <span class="hl kwa">null</span><span class="hl opt">)</span>
                <span class="hl opt">{</span>
                    <span class="hl kwa">this</span><span class="hl opt">.</span><span class="hl kwd">Add</span><span class="hl opt">(</span><span class="hl kwa">new</span> CacheItem <span class="hl opt">{</span> Key <span class="hl opt">=</span> key<span class="hl opt">,</span> Data <span class="hl opt">=</span> item<span class="hl opt">,</span> Expiration <span class="hl opt">=</span> expiration <span class="hl opt">});</span>
                <span class="hl opt">}</span>
            <span class="hl opt">}</span>
    
            <span class="hl kwa">return</span> item<span class="hl opt">;</span>
        <span class="hl opt">}</span>
    
        <span class="hl slc">/// &lt;summary&gt;</span>
        <span class="hl slc">/// Gets an object from the cache given its unique key.</span>
        <span class="hl slc">/// &lt;/summary&gt;</span>
        <span class="hl slc">///</span>
        <span class="hl slc">/// &lt;typeparam name=&quot;T&quot;&gt;</span>
        <span class="hl slc">/// The type of the retrieved object.</span>
        <span class="hl slc">/// &lt;/typeparam&gt;</span>
        <span class="hl slc">///</span>
        <span class="hl slc">/// &lt;param name=&quot;key&quot;&gt;</span>
        <span class="hl slc">/// Unique key.</span>
        <span class="hl slc">/// &lt;/param&gt;</span>
        <span class="hl slc">///</span>
        <span class="hl slc">/// &lt;param name=&quot;whenNull&quot;&gt;</span>
        <span class="hl slc">/// Function to execute when the key is not present in the cache.</span>
        <span class="hl slc">/// &lt;/param&gt;</span>
        <span class="hl slc">///</span>
        <span class="hl slc">/// &lt;param name=&quot;expiration&quot;&gt;</span>
        <span class="hl slc">/// Expiration TimeSpan.</span>
        <span class="hl slc">/// &lt;/param&gt;</span>
        <span class="hl slc">///</span>
        <span class="hl slc">/// &lt;returns&gt;</span>
        <span class="hl slc">/// The retrieved object. If not found returns null.</span>
        <span class="hl slc">/// &lt;/returns&gt;</span>
        <span class="hl kwa">public</span> T Get<span class="hl opt">&lt;</span>T<span class="hl opt">&gt;(</span><span class="hl kwb">string</span> key<span class="hl opt">,</span> Func<span class="hl opt">&lt;</span>T<span class="hl opt">&gt;</span> whenNull<span class="hl opt">,</span> TimeSpan expiration<span class="hl opt">)</span> where T <span class="hl opt">:</span> <span class="hl kwa">class</span>
        <span class="hl opt">{</span>
            <span class="hl kwa">return this</span><span class="hl opt">.</span>Get<span class="hl opt">&lt;</span>T<span class="hl opt">&gt;(</span>key<span class="hl opt">,</span> whenNull<span class="hl opt">,</span> DateTime<span class="hl opt">.</span>Now<span class="hl opt">.</span><span class="hl kwd">AddMilliseconds</span><span class="hl opt">(</span>expiration<span class="hl opt">.</span>TotalMilliseconds<span class="hl opt">));</span>
        <span class="hl opt">}</span>
    
        <span class="hl slc">/// &lt;summary&gt;</span>
        <span class="hl slc">/// Removes an object from the cache given its unique key.</span>
        <span class="hl slc">/// &lt;/summary&gt;</span>
        <span class="hl slc">///</span>
        <span class="hl slc">/// &lt;param name=&quot;key&quot;&gt;</span>
        <span class="hl slc">/// Unique key.</span>
        <span class="hl slc">/// &lt;/param&gt;</span>
        <span class="hl slc">///</span>
        <span class="hl slc">/// &lt;returns&gt;</span>
        <span class="hl slc">/// True if the object has been removed from the cache; otherwise, false.</span>
        <span class="hl slc">/// &lt;/returns&gt;</span>
        <span class="hl kwa">public</span> <span class="hl kwb">bool</span> <span class="hl kwd">Remove</span><span class="hl opt">(</span><span class="hl kwb">string</span> key<span class="hl opt">)</span>
        <span class="hl opt">{</span>
            <span class="hl kwa">return</span> _cacheClient<span class="hl opt">.</span><span class="hl kwd">Remove</span><span class="hl opt">(</span>key<span class="hl opt">);</span>
        <span class="hl opt">}</span>
    
        <span class="hl slc">/// &lt;summary&gt;</span>
        <span class="hl slc">/// Removes all the objects having the given tag value from the cache.</span>
        <span class="hl slc">/// &lt;/summary&gt;</span>
        <span class="hl slc">///</span>
        <span class="hl slc">/// &lt;param name=&quot;tag&quot;&gt;</span>
        <span class="hl slc">/// Tag value.</span>
        <span class="hl slc">/// &lt;/param&gt;</span>
        <span class="hl slc">///</span>
        <span class="hl slc">/// &lt;returns&gt;</span>
        <span class="hl slc">/// The number of objects removed.</span>
        <span class="hl slc">/// &lt;/returns&gt;</span>
        <span class="hl kwa">public</span> <span class="hl kwb">int</span> <span class="hl kwd">RemoveByTag</span><span class="hl opt">(</span><span class="hl kwb">string</span> tag<span class="hl opt">)</span>
        <span class="hl opt">{</span>
            var keys <span class="hl opt">=</span> _cacheClient<span class="hl opt">.</span><span class="hl kwd">SearchKeys</span><span class="hl opt">(</span>tag<span class="hl opt">);</span>
    
            _cacheClient<span class="hl opt">.</span><span class="hl kwd">RemoveAll</span><span class="hl opt">(</span>keys<span class="hl opt">);</span>
    
            <span class="hl kwa">return</span> keys<span class="hl opt">.</span><span class="hl kwd">Count</span><span class="hl opt">();</span>
        <span class="hl opt">}</span>
    
        <span class="hl ppc">#endregion</span>
    
        <span class="hl ppc">#region [ Asynchronous Methods ]</span>
    
        <span class="hl kwa">public</span> async Task<span class="hl opt">&lt;</span><span class="hl kwb">bool</span><span class="hl opt">&gt;</span> <span class="hl kwd">AddAsync</span><span class="hl opt">(</span>CacheItem cacheItem<span class="hl opt">)</span>
        <span class="hl opt">{</span>
            <span class="hl kwa">return</span> await _cacheClient<span class="hl opt">.</span><span class="hl kwd">AddAsync</span><span class="hl opt">(</span>cacheItem<span class="hl opt">.</span>Key<span class="hl opt">,</span> cacheItem<span class="hl opt">.</span>Data<span class="hl opt">,</span> cacheItem<span class="hl opt">.</span>Expiration<span class="hl opt">);</span>
        <span class="hl opt">}</span>
    
        <span class="hl kwa">public</span> async Task<span class="hl opt">&lt;</span><span class="hl kwb">bool</span><span class="hl opt">&gt;</span> <span class="hl kwd">AddAsync</span><span class="hl opt">(</span><span class="hl kwb">string</span> key<span class="hl opt">,</span> <span class="hl kwb">object</span> data<span class="hl opt">,</span> TimeSpan timeSpan<span class="hl opt">)</span>
        <span class="hl opt">{</span>
            <span class="hl kwa">return</span> await _cacheClient<span class="hl opt">.</span><span class="hl kwd">AddAsync</span><span class="hl opt">(</span>key<span class="hl opt">,</span> data<span class="hl opt">,</span> timeSpan<span class="hl opt">);</span>
        <span class="hl opt">}</span>
    
        <span class="hl kwa">public</span> async Task<span class="hl opt">&lt;</span>T<span class="hl opt">&gt;</span> GetAsync<span class="hl opt">&lt;</span>T<span class="hl opt">&gt;(</span><span class="hl kwb">string</span> key<span class="hl opt">)</span> where T <span class="hl opt">:</span> <span class="hl kwa">class</span>
        <span class="hl opt">{</span>
            <span class="hl opt">((</span>CacheStatistics<span class="hl opt">)</span>_statistics<span class="hl opt">).</span><span class="hl kwd">IncrementRequestCount</span><span class="hl opt">();</span>
    
            var data <span class="hl opt">=</span> await _cacheClient<span class="hl opt">.</span>GetAsync<span class="hl opt">&lt;</span>T<span class="hl opt">&gt;(</span>key<span class="hl opt">);</span>
    
            <span class="hl kwa">if</span> <span class="hl opt">(</span>data <span class="hl opt">==</span> <span class="hl kwa">null</span><span class="hl opt">)</span>
            <span class="hl opt">{</span>
                <span class="hl opt">((</span>CacheStatistics<span class="hl opt">)</span>_statistics<span class="hl opt">).</span><span class="hl kwd">IncrementMissCount</span><span class="hl opt">();</span>
            <span class="hl opt">}</span>
            <span class="hl kwa">else</span>
            <span class="hl opt">{</span>
                <span class="hl opt">((</span>CacheStatistics<span class="hl opt">)</span>_statistics<span class="hl opt">).</span><span class="hl kwd">IncrementHitCount</span><span class="hl opt">();</span>
            <span class="hl opt">}</span>
    
            <span class="hl kwa">return</span> data<span class="hl opt">;</span>
        <span class="hl opt">}</span>
    
        <span class="hl kwa">public</span> async Task<span class="hl opt">&lt;</span>T<span class="hl opt">&gt;</span> GetAsync<span class="hl opt">&lt;</span>T<span class="hl opt">&gt;(</span><span class="hl kwb">string</span> key<span class="hl opt">,</span> Func<span class="hl opt">&lt;</span>T<span class="hl opt">&gt;</span> whenNull<span class="hl opt">,</span> DateTime expiration<span class="hl opt">)</span> where T <span class="hl opt">:</span> <span class="hl kwa">class</span>
        <span class="hl opt">{</span>
            var item <span class="hl opt">=</span> await _cacheClient<span class="hl opt">.</span>GetAsync<span class="hl opt">&lt;</span>T<span class="hl opt">&gt;(</span>key<span class="hl opt">);</span>
            <span class="hl kwa">if</span> <span class="hl opt">(</span>item <span class="hl opt">==</span> <span class="hl kwa">null</span><span class="hl opt">)</span>
            <span class="hl opt">{</span>
                item <span class="hl opt">=</span> <span class="hl kwd">whenNull</span><span class="hl opt">();</span>
                <span class="hl kwa">if</span> <span class="hl opt">(</span>item <span class="hl opt">!=</span> <span class="hl kwa">null</span><span class="hl opt">)</span>
                <span class="hl opt">{</span>
                    await <span class="hl kwa">this</span><span class="hl opt">.</span><span class="hl kwd">AddAsync</span><span class="hl opt">(</span><span class="hl kwa">new</span> CacheItem <span class="hl opt">{</span> Key <span class="hl opt">=</span> key<span class="hl opt">,</span> Data <span class="hl opt">=</span> item<span class="hl opt">,</span> Expiration <span class="hl opt">=</span> expiration <span class="hl opt">});</span>
                <span class="hl opt">}</span>
            <span class="hl opt">}</span>
    
            <span class="hl kwa">return</span> item<span class="hl opt">;</span>
        <span class="hl opt">}</span>
    
        <span class="hl kwa">public</span> async Task<span class="hl opt">&lt;</span>T<span class="hl opt">&gt;</span> GetAsync<span class="hl opt">&lt;</span>T<span class="hl opt">&gt;(</span><span class="hl kwb">string</span> key<span class="hl opt">,</span> Func<span class="hl opt">&lt;</span>T<span class="hl opt">&gt;</span> whenNull<span class="hl opt">,</span> TimeSpan expiration<span class="hl opt">)</span> where T <span class="hl opt">:</span> <span class="hl kwa">class</span>
        <span class="hl opt">{</span>
            <span class="hl kwa">return</span> await <span class="hl kwa">this</span><span class="hl opt">.</span>GetAsync<span class="hl opt">&lt;</span>T<span class="hl opt">&gt;(</span>key<span class="hl opt">,</span> whenNull<span class="hl opt">,</span> DateTime<span class="hl opt">.</span>Now<span class="hl opt">.</span><span class="hl kwd">AddMilliseconds</span><span class="hl opt">(</span>expiration<span class="hl opt">.</span>TotalMilliseconds<span class="hl opt">));</span>
        <span class="hl opt">}</span>
    
        <span class="hl kwa">public</span> async Task<span class="hl opt">&lt;</span><span class="hl kwb">bool</span><span class="hl opt">&gt;</span> <span class="hl kwd">RemoveAsync</span><span class="hl opt">(</span><span class="hl kwb">string</span> key<span class="hl opt">)</span>
        <span class="hl opt">{</span>
            <span class="hl kwa">return</span> await _cacheClient<span class="hl opt">.</span><span class="hl kwd">RemoveAsync</span><span class="hl opt">(</span>key<span class="hl opt">);</span>
        <span class="hl opt">}</span>
    
        <span class="hl kwa">public</span> async Task<span class="hl opt">&lt;</span><span class="hl kwb">int</span><span class="hl opt">&gt;</span> <span class="hl kwd">RemoveByTagAsync</span><span class="hl opt">(</span><span class="hl kwb">string</span> tag<span class="hl opt">)</span>
        <span class="hl opt">{</span>
            <span class="hl kwa">return</span> await _cacheClient<span class="hl opt">.</span><span class="hl kwd">SearchKeysAsync</span><span class="hl opt">(</span>tag<span class="hl opt">)</span>
                                     <span class="hl opt">.</span><span class="hl kwd">ContinueWith</span><span class="hl opt">&lt;</span><span class="hl kwb">int</span><span class="hl opt">&gt;(</span>result <span class="hl opt">=&gt;</span>
            <span class="hl opt">{</span>
                _cacheClient<span class="hl opt">.</span><span class="hl kwd">RemoveAllAsync</span><span class="hl opt">(</span>result<span class="hl opt">.</span>Result<span class="hl opt">);</span>
                <span class="hl kwa">return</span> result<span class="hl opt">.</span>Result<span class="hl opt">.</span><span class="hl kwd">Count</span><span class="hl opt">();</span>
            <span class="hl opt">});</span>
        <span class="hl opt">}</span>
    
        <span class="hl ppc">#endregion</span>
    
        <span class="hl ppc">#region [ Properties ]</span>
    
        <span class="hl slc">/// &lt;summary&gt;</span>
        <span class="hl slc">/// Gets the cache statistics.</span>
        <span class="hl slc">/// &lt;/summary&gt;</span>
        <span class="hl kwa">public</span> ICacheStatistics Statistics
        <span class="hl opt">{</span>
            <span class="hl kwa">get</span>
            <span class="hl opt">{</span>
                var key <span class="hl opt">=</span> _cacheClient<span class="hl opt">.</span><span class="hl kwd">GetInfo</span><span class="hl opt">().</span><span class="hl kwd">Single</span><span class="hl opt">(</span>i <span class="hl opt">=&gt;</span> i<span class="hl opt">.</span>Value<span class="hl opt">.</span><span class="hl kwd">StartsWith</span><span class="hl opt">(</span><span class="hl str">&quot;keys=&quot;</span><span class="hl opt">)).</span>Value<span class="hl opt">;</span>
                var data <span class="hl opt">=</span> key<span class="hl opt">.</span><span class="hl kwd">Split</span><span class="hl opt">(</span><span class="hl str">','</span><span class="hl opt">,</span> <span class="hl str">'='</span><span class="hl opt">);</span>
    
                <span class="hl opt">((</span>CacheStatistics<span class="hl opt">)</span>_statistics<span class="hl opt">).</span>ItemCount <span class="hl opt">=</span> TypeHelper<span class="hl opt">.</span>To<span class="hl opt">&lt;</span><span class="hl kwb">int</span><span class="hl opt">&gt;(</span>data<span class="hl opt">[</span><span class="hl num">1</span><span class="hl opt">]);</span>
    
                <span class="hl kwa">return</span> _statistics<span class="hl opt">;</span>
            <span class="hl opt">}</span>
        <span class="hl opt">}</span>
    
        <span class="hl ppc">#endregion</span>
    
        <span class="hl ppc">#endregion</span>
    
        <span class="hl ppc">#region [ IDisposable Implementation ]</span>
    
        <span class="hl kwa">private</span> <span class="hl kwb">bool</span> _isDisposed <span class="hl opt">=</span> <span class="hl kwa">false</span><span class="hl opt">;</span>
    
        <span class="hl slc">/// &lt;summary&gt;</span>
        <span class="hl slc">/// Performs application-defined tasks associated with freeing, releasing, or resetting unmanaged resources.</span>
        <span class="hl slc">/// &lt;/summary&gt;</span>
        <span class="hl kwa">public</span> <span class="hl kwb">void</span> <span class="hl kwd">Dispose</span><span class="hl opt">()</span>
        <span class="hl opt">{</span>
            <span class="hl kwa">this</span><span class="hl opt">.</span><span class="hl kwd">Dispose</span><span class="hl opt">(</span><span class="hl kwa">true</span><span class="hl opt">);</span>
            GC<span class="hl opt">.</span><span class="hl kwd">SuppressFinalize</span><span class="hl opt">(</span><span class="hl kwa">this</span><span class="hl opt">);</span>
        <span class="hl opt">}</span>
    
        <span class="hl slc">/// &lt;summary&gt;</span>
        <span class="hl slc">/// Performs application-defined tasks associated with freeing, releasing, or resetting unmanaged resources.</span>
        <span class="hl slc">/// &lt;/summary&gt;</span>
        <span class="hl slc">///</span>
        <span class="hl slc">/// &lt;param name=&quot;disposing&quot;&gt;</span>
        <span class="hl slc">/// For internal use.</span>
        <span class="hl slc">/// &lt;/param&gt;</span>
        <span class="hl kwa">protected virtual</span> <span class="hl kwb">void</span> <span class="hl kwd">Dispose</span><span class="hl opt">(</span><span class="hl kwb">bool</span> disposing<span class="hl opt">)</span>
        <span class="hl opt">{</span>
            <span class="hl kwa">if</span> <span class="hl opt">(</span>disposing<span class="hl opt">)</span>
            <span class="hl opt">{</span>
                <span class="hl kwa">if</span> <span class="hl opt">(!</span>_isDisposed<span class="hl opt">)</span>
                <span class="hl opt">{</span>
                    <span class="hl slc">// Nothing because _cacheClient is a static instance</span>
    
                    _isDisposed <span class="hl opt">=</span> <span class="hl kwa">true</span><span class="hl opt">;</span>
                <span class="hl opt">}</span>
            <span class="hl opt">}</span>
        <span class="hl opt">}</span>
    
        <span class="hl ppc">#endregion</span>
    <span class="hl opt">}</span>
<span class="hl opt">}</span></pre>
	</section>

	<section>
		<h2>4. Web.config (server-side)</h2>
		<p class="action">Edit the <span class="text-bold">Web.config file</span> (of the WebServices project and/or possible ASP.NET WebSite depending on your needs)</p>
		<ol>
			<li>Add the 2 missing sections</li>
			<li>Change the <span class="text-bold">implementation</span> attribute with the new value <em>Externals.RedisCache.CacheService, Externals.RedisCache</em></li>
		</ol>
		<pre class="hl"><span class="hl kwa">&lt;?xml</span> <span class="hl kwb">version</span>=<span class="hl str">&quot;1.0&quot;</span> <span class="hl kwb">encoding</span>=<span class="hl str">&quot;utf-8&quot;</span> <span class="hl kwa">?&gt;</span>
<span class="hl kwa">&lt;configuration&gt;</span>
	
  <span class="hl kwa">&lt;configSections&gt;</span>
    ...
    <span class="hl slc">&lt;!-- add this --&gt;</span>
    <span class="text-bold text-red">&lt;section
      name=&quot;redisCacheClient&quot;
      type=&quot;StackExchange.Redis.Extensions.Core.Configuration.RedisCachingSectionHandler, StackExchange.Redis.Extensions.Core&quot; /&gt;</span>
  <span class="hl kwa">&lt;/configSections&gt;</span>

  <span class="hl kwa">&lt;serviceLocatorConfiguration&gt;</span>
    <span class="hl kwa">&lt;instances&gt;</span>
      ...
      <span class="hl slc">&lt;!-- edit this --&gt;</span>
      <span class="hl kwa">&lt;instance</span>
        <span class="hl kwb">interface</span>=<span class="hl str">&quot;System.ICacheService, System.Extensions&quot;</span>
        <span class="hl kwb">implementation</span>=<span class="text-bold text-red">&quot;Externals.RedisCache.CacheService, Externals.RedisCache&quot;</span>
        <span class="hl kwb">instancingMode</span>=<span class="hl str">&quot;Singleton&quot;</span><span class="hl kwa">/&gt;</span>
      <span class="hl kwa">&lt;/instances&gt;</span>
  <span class="hl kwa">&lt;/serviceLocatorConfiguration&gt;</span>
	
  <span class="hl slc">&lt;!-- add this --&gt;</span>
  <span class="text-bold text-red">&lt;redisCacheClient allowAdmin=&quot;true&quot; ssl=&quot;false&quot; connectTimeout=&quot;5000&quot; database=&quot;0&quot;&gt;
    &lt;hosts&gt;
      &lt;add host=&quot;127.0.0.1&quot; cachePort=&quot;6379&quot;/&gt;
    &lt;/hosts&gt;
  &lt;/redisCacheClient&gt;</span>
	
<span class="hl kwa">&lt;/configuration&gt;</span></pre>
		<div class="box important">
			<h3>Reference</h3>
			<div class="box-content">Do not forget to add a reference on the <em>Externals.RedisCache</em> project!</div>
			<div class="box-content">
				<img src="../ScreenShots/RedisCacheServiceSupport-05.png" title="Illustration" alt="Illustration" />
			</div>
		</div>
		<div class="box important">
			<h3>How to run Redis</h3>
			<div class="box-content">To run Redis execute <span class="text-bold">Src\packages\Redis-64.2.8.19\redis-server.exe</span></div>
			<div class="box-content">
				<img src="../ScreenShots/RedisCacheServiceSupport-06.png" title="Illustration" alt="Illustration" />
			</div>
		</div>
	</section>
</body>
</html>
